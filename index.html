
<!doctype html><html lang=es><meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1"><title>CDL · Panel</title>
<style>
:root{--p:#C62828;--g:#2e7d32;--o:#f57c00;--r:#d32f2f}*{box-sizing:border-box}body{margin:0;font-family:system-ui,Arial;background:#f4f5f7}
.topbar{position:sticky;top:0;z-index:20;background:#fff;border-bottom:3px solid var(--p)}.topbar>div{display:flex;align-items:center;gap:10px;padding:6px 10px}
img.logo{height:50px}h1{font-size:16px;margin:0;font-weight:800}.nav{margin-left:auto;display:flex;gap:8px;overflow:auto}
.nav a{text-decoration:none;color:#111;background:#f0f0f0;border:1px solid #e2e2e2;padding:6px 10px;border-radius:999px;font-weight:700;font-size:13px;white-space:nowrap}
.nav a.active{background:#111;color:#fff}.c{max-width:1100px;margin:12px auto;padding:0 10px}.card{background:#fff;border-radius:10px;box-shadow:0 4px 18px #0001;padding:12px;margin:10px 0}
.grid{display:grid;gap:8px}@media(min-width:720px){.grid{grid-template-columns:1fr 1fr}}.item{display:flex;flex-wrap:wrap;gap:8px;border:1px solid #eee;border-radius:10px;padding:10px}
.item-left{display:flex;align-items:center;gap:8px;flex:1 1 240px;min-width:0}.dot{width:12px;height:12px;border-radius:999px}
.dot.g{background:var(--g)}.dot.o{background:var(--o)}.dot.r{background:var(--r)}.title{font-weight:800;word-break:break-word;line-height:1.15}
.item-actions{display:flex;gap:8px;flex:1 1 220px;justify-content:flex-end}select,textarea,input{border:1px solid #ddd;border-radius:8px;padding:8px}
.btn{border:0;border-radius:8px;padding:8px 10px;font-weight:700;cursor:pointer;color:#fff;background:var(--p)}.ghost{background:#e8eaed;color:#111}
.table-wrap{overflow-x:auto;border-radius:10px}table{width:100%;min-width:820px;border-collapse:separate;border-spacing:0 6px}th{text-align:left;color:#666;font-size:12px;padding:8px}td{background:#fff;padding:10px;border-radius:8px;vertical-align:top;word-break:break-word}
.toast{position:fixed;left:10px;right:10px;bottom:12px;display:none;z-index:50}.toast .in{background:#323232;color:#fff;padding:10px 12px;border-radius:10px;display:flex;justify-content:space-between;align-items:center;gap:10px;box-shadow:0 6px 18px #0004}
.toast button{background:#ff7043;border:0;color:#fff;border-radius:6px;padding:6px 10px;font-weight:700}
.badge{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:4px 8px;background:#eee;font-weight:600;font-size:12px}
</style>
<body>
<div class=topbar><div><img class=logo src=logo_mantenimiento.jpeg alt=CDL><h1>CDL · Panel de Mantenimiento</h1>
<nav class=nav id=nav><a href=#inicio class=active>Inicio</a><a href=#gruas>Grúas</a><a href=#incidencias>Incidencias</a><a href=#indicadores>Indicadores</a></nav></div></div>
<div class=c>
  <div id=alerta class=card style="display:none;border-left:6px solid var(--r)"><b>Equipos parados o con restricciones</b><div id=alertaList></div></div>
  <section id=inicioSec class=card><div style=display:flex;gap:8px;margin:6px 0>
    <span class=badge>🔴 Parada</span><span class=badge>🟠 Restricciones</span><span class=badge>🟢 En marcha</span></div>
    <button class="btn" onclick="mailtoParadaProlongada()">Parada prolongada (aviso correo)</button>
    <div id=inicioGroups></div></section>
  <section id=gruasSec class=card style="display:none"><h3>Puentes grúa por nave</h3><div id=gruasGroups></div></section>
  <section id=incidenciasSec class=card style="display:none">
    <h3>Incidencias</h3>
    <div class=card>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div><label>Equipo</label><br><input id=incEquipo list=equiposList placeholder="Empieza a escribir..."><datalist id=equiposList></datalist></div>
        <div><label>Tipo</label><br><select id=incTipo><option>Correctivo</option><option>Preventivo</option><option>Mejora</option></select></div>
        <div><label>Hora aviso</label><br><input type=datetime-local id=incAviso></div>
        <div><label>Hora atención</label><br><input type=datetime-local id=incAtencion></div>
        <div><label>Hora fin</label><br><input type=datetime-local id=incFin></div>
        <div><label>Horas de parada</label><br><input type=number step=0.01 id=incHoras placeholder="Ej. 2.5"></div>
        <div style="grid-column:1/3"><label>Descripción (obligatorio)</label><br><textarea id=incDesc rows=3></textarea></div>
      </div>
      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        <button class=btn onclick=addIncidencia()>Añadir incidencia</button>
        <button class="btn ghost" onclick=exportBackup()>Exportar backup</button>
        <input type=file id=importFile style="display:none" accept=.json onchange="importBackup(this.files[0])">
        <button class="btn ghost" onclick="document.getElementById('importFile').click()">Importar backup</button>
      </div>
    </div>
    <div class=card>
      <h4>Filtros / búsqueda</h4>
      <div style="display:flex;flex-wrap:wrap;gap:8px">
        <div style="flex:1 1 140px"><label>Equipo</label><br><input id=fEquipo list=equiposList placeholder=Todos></div>
        <div style="flex:1 1 140px"><label>Tipo</label><br><select id=fTipo><option value=''>Todos</option><option>Correctivo</option><option>Preventivo</option><option>Mejora</option></select></div>
        <div style="flex:1 1 140px"><label>Desde</label><br><input type=date id=fDesde></div>
        <div style="flex:1 1 140px"><label>Hasta</label><br><input type=date id=fHasta></div>
        <div style="flex:2 1 220px"><label>Texto</label><br><input id=fTexto placeholder="Equipo o descripción"></div>
        <div style="display:flex;gap:8px;align-items:end"><button class="btn ghost" onclick=resetFiltros()>Limpiar</button><button class=btn onclick=aplicarFiltros()>Aplicar</button><button class="btn ghost" onclick=exportCSV()>Exportar CSV</button></div>
      </div>
    </div>
    <div class=card><div style="display:flex;gap:10px;flex-wrap:wrap">
      <div><div style="font-size:12px;color:#666">MTTR medio (h)</div><div id=kpiMttr style="font-weight:800;font-size:22px">0</div></div>
      <div><div style="font-size:12px;color:#666">MTTA (h)</div><div id=kpiMtta style="font-weight:800;font-size:22px">0</div></div>
    </div>
    <div class=card><b>MTTR por semana</b><canvas id=chartMttr height=160></canvas></div>
    <div class=card><b>Incidencias por semana</b><canvas id=chartCount height=160></canvas></div></div>
    <h4>Historial (según filtro)</h4>
    <div class=table-wrap><table id=incTable><thead><tr><th>Fecha</th><th>Equipo</th><th>Tipo</th><th>Descripción</th><th>Horas parada</th><th>MTTA (h)</th><th>Acciones</th></tr></thead><tbody></tbody></table></div>
  </section>
  <section id=indicadoresSec class=card style="display:none"><h3>Indicadores</h3>
    <div class=card><b>MTTR por semana</b><canvas id=chartMttr2 height=160></canvas></div>
    <div class=card><b>Incidencias por semana</b><canvas id=chartCount2 height=160></canvas></div>
  </section>
</div>
<div class=toast id=toast><div class=in><div id=toastMsg>Incidencia borrada.</div><div style="display:flex;gap:8px;align-items:center"><button onclick=deshacerBorrado()>Deshacer</button><span id=toastCountdown style=font-size:12px></span></div></div></div>
<script>
const DATA={"equipos": {"Línea KALTENBACH": ["SIERRA KBS", "KDP1", "KDP3", "ÁREA PINTURA", "TRANSPORTE T13 (Rodillo central)", "VALLADO Y SEGURIDADES", "SALIDA Q8", "SALIDA Q9"], "Máquinas independientes": ["HGG", "SIERRA DE PAQUETES", "TECOI (THOR)", "MAZAK FG-400NEO"], "Láser Trumpf": ["LASER T12-2", "LASER T12-1", "LASER T7-1", "LASER T7-2", "LASER T11-1", "LASER T11-2"], "Maquinaria móvil / transporte": ["CARRETILLA ELEVADORA LINDE 1", "CARRETILLA ELEVADORA LINDE 2", "PLATAFORMA ELEVADORA ARTICULADA", "TRANSPALETAS ELÉCTRICAS", "CARRO DE TRANSPORTE TRANSVERSAL 1", "CARRO DE TRANSPORTE TRANSVERSAL 2"]}, "gruas": {"Nave 1": ["N1 PUENTE GRÚA CON IMANES (SIN INSTALAR)", "N1 DEMAG 5+5T", "N1 DEMAG 6.3+6.3T", "N1 GH 6.3+6.3T"], "Nave 2": ["N2 PUENTE GRÚA CON IMANES (SIN INSTALAR)", "N2 DEMAG 5+5T (PORTADOR IMANES)", "N2 DEMAG 6.3+6.3T", "N2 GH 6.3+6.3T", "N2 GH 5+5T"], "Nave 3": ["N3 ARAEL 3.2+3.2T (IMANES)", "N3 DEMAG 5+5T", "N3 DEMAG 6.3+6.3T", "N3 GH 5+5T (1)", "N3 GH 5+5T (2)", "N3 GH 3.2+3.2T DESCARGA ZONA LÁSER (1)", "N3 GH 3.2+3.2T DESCARGA ZONA LÁSER (2)"], "Nave 4": ["N4 GH 2.2+2.2T (IMANES)", "N4 DEMAG 5+5T", "N4 DEMAG 6.3+6.3T", "N4 GH 10+10T", "N4 GH 5+5T"]}};

const KEY_STATE="cdl_state_v1", KEY_INCID="cdl_incid_v1";
let _cacheFiltrado=[], _undo=null, _toastTimer=null;
const q=x=>document.querySelector(x);
function loadState(){return JSON.parse(localStorage.getItem(KEY_STATE)||'{}')}
function saveState(s){localStorage.setItem(KEY_STATE,JSON.stringify(s))}
function loadIncid(){return JSON.parse(localStorage.getItem(KEY_INCID)||'[]')}
function saveIncid(a){localStorage.setItem(KEY_INCID,JSON.stringify(a))}
function statusDot(s){return s==='Parada'?'r':(s==='Restricciones'?'o':'g')}
function mailtoParadaProlongada(eq='(no especificado)'){const to='mrsmarioruizsola@outlook.es';location.href=`mailto:${to}?subject=${encodeURIComponent('🚨 Parada prolongada — '+eq)}&body=${encodeURIComponent('Equipo: '+eq+'\nFecha: '+new Date().toLocaleString())}`}
function setActive(h){document.querySelectorAll('.nav a').forEach(a=>a.classList.remove('active'));const l=document.querySelector('.nav a[href="'+h+'"]');if(l)l.classList.add('active');['inicioSec','gruasSec','incidenciasSec','indicadoresSec'].forEach(id=>q('#'+id).style.display='none');q(h==='#gruas'?'#gruasSec':h==='#incidencias'?'#incidenciasSec':h==='#indicadores'?'#indicadoresSec':'#inicioSec').style.display='block'}
function renderItem(name,group){const st=loadState();const d=document.createElement('div');d.className='item';d.innerHTML=`<div class=item-left><span class="dot ${statusDot(st[name]?.estado||'En marcha')}"></span><div><div class=title>${name}</div><small>${group}</small></div></div><div class=item-actions><select class=status><option>En marcha</option><option>Restricciones</option><option>Parada</option></select><button class=btn onclick="mailtoParadaProlongada('${name.replace("'", "\'")}')">Parada prolongada</button></div>`;const sel=d.querySelector('select');sel.value=(st[name]?.estado)||'En marcha';sel.onchange=()=>{const s=loadState();s[name]={estado:sel.value,updated:new Date().toISOString()};saveState(s);renderAll()};return d}
function renderInicio(){const w=q('#inicioGroups');w.innerHTML='';Object.entries(DATA.equipos).forEach(([g,l])=>{const c=document.createElement('div');c.className='card';c.innerHTML=`<h3>${g}</h3>`;const grd=document.createElement('div');grd.className='grid';l.forEach(n=>grd.appendChild(renderItem(n,g)));c.appendChild(grd);w.appendChild(c)})}
function renderGruas(){const w=q('#gruasGroups');w.innerHTML='';Object.entries(DATA.gruas).forEach(([g,l])=>{const c=document.createElement('div');c.className='card';c.innerHTML=`<h3>${g}</h3>`;const grd=document.createElement('div');grd.className='grid';l.forEach(n=>grd.appendChild(renderItem(n,g)));c.appendChild(grd);w.appendChild(c)})}
function fillDatalist(){const dl=q('#equiposList');dl.innerHTML='';[...Object.values(DATA.equipos).flat(),...Object.values(DATA.gruas).flat()].forEach(n=>{const o=document.createElement('option');o.value=n;dl.appendChild(o)})}
function addIncidencia(){const equipo=q('#incEquipo').value.trim(),tipo=q('#incTipo').value,aviso=q('#incAviso').value,at=q('#incAtencion').value,fin=q('#incFin').value,horas=parseFloat(q('#incHoras').value||'0'),desc=q('#incDesc').value.trim();if(!equipo||!desc){alert('Equipo y descripción son obligatorios');return}let mtta=0;if(aviso&&at)mtta=(new Date(at)-new Date(aviso))/36e5;const arr=loadIncid();arr.push({id:'INC'+Date.now(),equipo,tipo,aviso,atencion:at,fin,horas,mtta,desc,created:new Date().toISOString()});saveIncid(arr);aplicarFiltros()}
function isoWeek(d){const dt=new Date(d),t=new Date(dt.valueOf());const dn=(dt.getDay()+6)%7;t.setDate(t.getDate()-dn+3);const ft=new Date(t.getFullYear(),0,4);return 1+Math.round(((t-ft)/86400000-3+((ft.getDay()+6)%7))/7)}
function drawBars(id,labels,values,unit){const c=q('#'+id),ctx=c.getContext('2d');const W=c.width=c.clientWidth,H=c.height=c.clientHeight;ctx.clearRect(0,0,W,H);const pad=28,max=Math.max(1,...values),step=(W-pad*2)/Math.max(1,labels.length),bw=step*.7;ctx.strokeStyle='#ccc';ctx.beginPath();ctx.moveTo(pad,H-pad);ctx.lineTo(W-pad,H-pad);ctx.stroke();values.forEach((v,i)=>{const x=pad+i*step+(step-bw)/2,h=(H-pad*2)*(v/max),y=H-pad-h;ctx.fillStyle='rgba(198,40,40,.88)';ctx.fillRect(x,y,bw,h);ctx.fillStyle='#333';ctx.font='12px system-ui';ctx.fillText(labels[i],x,H-pad+14);ctx.fillText((+v).toFixed(1)+(unit||''),x,y-4)})}
function getFiltros(){const eq=q('#fEquipo').value.trim(),tipo=q('#fTipo').value;const desde=q('#fDesde').value?new Date(q('#fDesde').value):null;const hasta=q('#fHasta').value?new Date(q('#fHasta').value):null;const texto=q('#fTexto').value.trim().toLowerCase();return {eq,tipo,desde,hasta,texto}}
function filtrar(a){const f=getFiltros();return a.filter(i=>{if(f.eq&&i.equipo!==f.eq)return false;if(f.tipo&&i.tipo!==f.tipo)return false;const d=new Date(i.created);if(f.desde&&d<f.desde)return false;if(f.hasta){const h=new Date(f.hasta);h.setHours(23,59,59,999);if(d>h)return false}if(f.texto){const blob=(i.equipo+' '+(i.desc||'')).toLowerCase();if(!blob.includes(f.texto))return false}return true})}
function resetFiltros(){['#fEquipo','#fTipo','#fDesde','#fHasta','#fTexto'].forEach(s=>q(s).value='');aplicarFiltros()}
function aplicarFiltros(){const arr=loadIncid().sort((a,b)=>new Date(b.created)-new Date(a.created)),vis=filtrar(arr);_cacheFiltrado=vis;const tb=q('#incTable tbody');tb.innerHTML='';const fmt=d=>d?new Date(d).toLocaleString():'—';vis.forEach(it=>{const tr=document.createElement('tr');tr.innerHTML='<td>'+fmt(it.created)+'</td><td><span class=badge>'+it.equipo+'</span></td><td>'+it.tipo+'</td><td>'+it.desc+'</td><td>'+((it.horas||0).toFixed(2))+'</td><td>'+((it.mtta||0).toFixed(2))+'</td><td><button class="btn" style="background:#d32f2f" onclick="borrarIncidencia(\''+it.id+'\')">Borrar</button></td>';tb.appendChild(tr)});const corr=vis.filter(i=>i.tipo==='Correctivo'&&i.horas);const mttr=corr.length?corr.reduce((s,i)=>s+(i.horas||0),0)/corr.length:0;const ma=vis.filter(i=>i.mtta);const mtta=ma.length?ma.reduce((s,i)=>s+i.mtta,0)/ma.length:0;q('#kpiMttr').textContent=mttr.toFixed(2);q('#kpiMtta').textContent=mtta.toFixed(2);const by={};vis.forEach(i=>{const w=isoWeek(i.created);by[w]=by[w]||{count:0,hrs:0};by[w].count++;by[w].hrs+=(i.horas||0)});const weeks=Object.keys(by).sort((a,b)=>a-b);drawBars('chartMttr',weeks,weeks.map(w=>by[w].count?by[w].hrs/by[w].count:0),'h');drawBars('chartCount',weeks,weeks.map(w=>by[w].count),'')}
function exportCSV(){const rows=_cacheFiltrado.map(i=>[new Date(i.created).toLocaleString(),i.equipo,i.tipo,(i.desc||'').replace(/\n/g,' '),(i.horas||0),(i.mtta||0)]);const header=['Fecha','Equipo','Tipo','Descripción','Horas_parada','MTTA_h'];const csv=[header].concat(rows).map(r=>r.map(v=>'"'+String(v).replaceAll('"','""')+'"').join(',')).join('\n');const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='incidencias_filtradas.csv';a.click()}
function borrarIncidencia(id){const arr=loadIncid();const i=arr.findIndex(x=>x.id===id);if(i<0)return;const [rm]=arr.splice(i,1);saveIncid(arr);_undo={item:rm};aplicarFiltros();showToast('Incidencia borrada.',6,()=>{_undo=null})}
function deshacerBorrado(){if(!_undo)return;const arr=loadIncid();arr.push(_undo.item);saveIncid(arr);_undo=null;hideToast();aplicarFiltros();showToast('Restaurada.',2)}
function showToast(msg,sec,onExpire){q('#toastMsg').textContent=msg;let left=sec||4;q('#toastCountdown').textContent=left+'s';q('#toast').style.display='block';if(_toastTimer)clearInterval(_toastTimer);_toastTimer=setInterval(()=>{left--;q('#toastCountdown').textContent=left>0?left+'s':'';if(left<=0){clearInterval(_toastTimer);hideToast();if(onExpire)onExpire();}},1000)}
function hideToast(){q('#toast').style.display='none'}
function renderKPIsGlobal(){const arr=loadIncid(),by={};arr.forEach(i=>{const w=isoWeek(i.created);by[w]=by[w]||{count:0,hrs:0};by[w].count++;by[w].hrs+=(i.horas||0)});const weeks=Object.keys(by).sort((a,b)=>a-b);drawBars('chartMttr2',weeks,weeks.map(w=>by[w].count?by[w].hrs/by[w].count:0),'h');drawBars('chartCount2',weeks,weeks.map(w=>by[w].count),'')}
function renderAlert(){const s=loadState(),all=[...Object.values(DATA.equipos).flat(),...Object.values(DATA.gruas).flat()],its=all.filter(n=>['Parada','Restricciones'].includes(s[n]?.estado));const b=q('#alerta'),l=q('#alertaList');if(its.length==0){b.style.display='none';l.innerHTML='';return}b.style.display='block';l.innerHTML='';its.forEach(n=>{const d=document.createElement('div');d.textContent=n+' — '+(s[n]?.estado||'En marcha');l.appendChild(d)})}
function renderAll(){renderInicio();renderGruas();fillDatalist();aplicarFiltros();renderKPIsGlobal();renderAlert();setActive(location.hash||'#inicio')}
addEventListener('hashchange',()=>setActive(location.hash||'#inicio'));addEventListener('load',renderAll);
</script>
</html>
