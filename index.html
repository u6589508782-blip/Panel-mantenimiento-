<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CDL Â· CMMS v20</title>
<style>
:root{--brand:#e53935;--bg:#f6f7f9;--ok:#2e7d32;--warn:#f57c00;--bad:#d32f2f}
*{box-sizing:border-box}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg)}
.header{position:sticky;top:0;background:#fff;border-bottom:2px solid var(--brand);z-index:1000}
.header-top{display:flex;align-items:center;gap:12px;padding:8px 12px}
.header-logo{height:56px}.header-title{font-weight:900;font-size:20px;margin:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.header-right{margin-left:auto;display:flex;align-items:center;gap:8px}
.icon-btn{border:0;background:#e8eaed;color:#111;border-radius:10px;padding:10px 12px;font-weight:800;cursor:pointer}
.icon-btn:active{transform:scale(.98)}
.menu-panel,.session-panel{display:none;position:absolute;right:10px;top:64px;background:#fff;border:1px solid #ddd;border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.12);min-width:230px;overflow:hidden;z-index:1100}
.menu-panel a,.session-panel a,.session-panel div{display:block;padding:12px 14px;text-decoration:none;color:#111;border-bottom:1px solid #f2f2f2;font-weight:700}
.menu-panel a:last-child,.session-panel a:last-child,.session-panel div:last-child{border-bottom:0}
.menu-panel a:hover,.session-panel a:hover{background:#f8f8f8}.session-muted{opacity:.7;font-weight:600}
.container{max-width:1100px;margin:10px auto;padding:0 12px}.card{background:#fff;border:1px solid #eee;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.06);padding:12px;margin:12px 0}
.badge{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:4px 8px;background:#eee;font-weight:700;font-size:12px}
.grid{display:grid;grid-template-columns:1fr;gap:8px}@media(min-width:720px){.grid{grid-template-columns:1fr 1fr}}
.item{display:flex;flex-wrap:wrap;gap:10px;border:1px solid #eee;border-radius:12px;padding:10px}
.item-left{display:flex;align-items:center;gap:10px;flex:1 1 260px;min-width:0}
.dot{width:12px;height:12px;border-radius:999px}.dot.g{background:var(--ok)}.dot.o{background:var(--warn)}.dot.r{background:var(--bad)}
.title{font-weight:900;line-height:1.15;word-break:break-word}.small{color:#666}
select,input,textarea{border:1px solid #ddd;border-radius:10px;padding:8px;width:100%}
.btn{border:0;background:var(--brand);color:#fff;border-radius:10px;padding:9px 12px;font-weight:800;cursor:pointer}
.btn.ghost{background:#e8eaed;color:#111}.btn.warn{background:var(--bad)}
.table-wrap{overflow-x:auto;border-radius:12px}.table{width:100%;min-width:920px;border-collapse:separate;border-spacing:0 8px}
.table th{text-align:left;color:#666;font-size:12px;padding:8px}.table td{background:#fff;padding:10px;border-radius:10px;vertical-align:top}
.toast{position:fixed;left:10px;right:10px;bottom:12px;display:none;z-index:1200}
.toast .in{background:#323232;color:#fff;padding:10px 12px;border-radius:10px;display:flex;justify-content:space-between;align-items:center;gap:10px}
.ot-card{border-left:6px solid #999}.ot-R{border-color:#d32f2f}.ot-N{border-color:#f57c00}.ot-A{border-color:#f9a825}.ot-V{border-color:#2e7d32}
</style>
</head>
<body>
<header class="header">
  <div class="header-top">
    <img class="header-logo" 
    <img class="header-logo" src="logo_mantenimiento.PNG" alt="CDL">
    <h1 class="header-title">CDL Â· CMMS</h1>
    <div class="header-right">
      <button class="icon-btn" id="pagesBtn">â˜° MenÃº</button>
      <button class="icon-btn" id="sessBtn">â‹®</button>
    </div>
    <nav id="menuPanel" class="menu-panel" aria-hidden="true">
      <a href="#equipos">Equipos</a><a href="#puentes">Puentes GrÃºa</a><a href="#otros">Otros</a>
      <a href="#incidencias">Incidencias</a><a href="#indicadores">Indicadores</a>
      <a href="#inventario">Inventario</a><a href="#ot">O.T.</a><a href="#personal">Personal</a>
    </nav>
    <div id="sessionPanel" class="session-panel" aria-hidden="true">
      <div class="session-muted" id="sessInfo">Usuario: Invitado</div>
      <a href="#" id="loginLink">Entrar</a>
      <a href="#" id="logoutLink">Salir</a>
    </div>
  </div>
</header>

<div class="container">
  <!-- Avisos -->
  <div id="alerta" class="card" style="display:none;border-left:6px solid var(--bad)">
    <h3 style="margin:0;color:var(--bad)">Equipos parados o con restricciones por averÃ­a</h3>
    <div id="alertaList" style="display:flex;flex-direction:column;gap:6px"></div>
  </div>

  <!-- Equipos -->
  <section id="equiposSec" class="card">
    <div class="badge">ðŸ”´ Parada</div> <div class="badge">ðŸŸ  Restricciones</div> <div class="badge">ðŸŸ¢ En marcha</div>
    <div style="margin-top:8px"><button class="btn warn" id="btnParada">Parada prolongada (aviso correo)</button></div>
    <div id="equiposGroups"></div>
  </section>

  <!-- Puentes -->
  <section id="puentesSec" class="card" style="display:none"><h2>Puentes GrÃºa</h2><div id="gruasGroups"></div></section>

  <!-- Otros -->
  <section id="otrosSec" class="card" style="display:none"><h2>Otros (auxiliares)</h2><div id="otrosWrap"></div></section>

  <!-- Incidencias -->
  <section id="incidenciasSec" class="card" style="display:none">
    <h2>Incidencias</h2>
    <div class="card">
      <h3>Nueva incidencia</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div style="grid-column:1/3"><label>Equipo</label><br><select id="incEquipo"></select></div>
        <div><label>Tipo</label><br><select id="incTipo"><option>Correctivo</option><option>Preventivo</option><option>Mejora</option></select></div>
        <div><label>Resultado</label><br><select id="incResultado"><option>Solucionado</option><option>Con restricciones</option><option>No solucionado</option></select></div>
        <div><label>Reportante</label><br><input id="incReportante" placeholder="Tu nombre"></div>
        <div><label>Asignado a</label><br><input id="incAsignado" placeholder="TÃ©cnico"></div>
        <div><label>Â¿Uso de repuestos?</label><br><select id="incRep"><option>No</option><option>SÃ­</option></select></div>
        <div><label>Repuesto (opcional)</label><br><input id="incRepTxt" placeholder="CÃ³digo o descripciÃ³n"></div>
        <div><label>Horas de paro (total)</label><br><input type="number" step="0.01" id="incHorasParo"></div>
        <div><label>Horas de reparaciÃ³n</label><br><input type="number" step="0.01" id="incHorasRepar"></div>
        <div><label>Fecha inicio</label><br><input type="datetime-local" id="incInicio"></div>
        <div style="grid-column:1/3"><label>Adjunto (URL Drive)</label><br><input id="incAdj" placeholder="Pega enlace de Drive (opcional)"></div>
        <div style="grid-column:1/3"><label>DescripciÃ³n</label><br><textarea id="incDesc" rows="3"></textarea></div>
      </div>
      <div style="margin-top:8px"><button class="btn" id="btnAddInc">AÃ±adir incidencia</button></div>
    </div>

    <div class="card">
      <h3>Filtros / bÃºsqueda</h3>
      <div style="display:flex;flex-wrap:wrap;gap:8px">
        <div style="flex:1 1 200px"><label>Equipo</label><br><select id="fEquipo"><option value="">Todos</option></select></div>
        <div style="flex:1 1 140px"><label>Tipo</label><br><select id="fTipo"><option value="">Todos</option><option>Correctivo</option><option>Preventivo</option><option>Mejora</option></select></div>
        <div style="flex:1 1 160px"><label>Resultado</label><br><select id="fRes"><option value="">Todos</option><option>Solucionado</option><option>Con restricciones</option><option>No solucionado</option></select></div>
        <div style="flex:2 1 240px"><label>Texto</label><br><input id="fTexto" placeholder="Equipo, descripciÃ³n, repuestoâ€¦"></div>
        <div style="display:flex;gap:8px;align-items:flex-end">
          <button class="btn ghost" id="btnResetFiltros">Limpiar</button>
          <button class="btn" id="btnAplicarFiltros">Aplicar</button>
        </div>
      </div>
    </div>

    <h3>Historial (Ãºltimas primero)</h3>
    <div class="table-wrap"><table class="table" id="incTable"><thead>
      <tr><th>Fecha</th><th>Equipo</th><th>Tipo</th><th>Resultado</th><th>Reportante</th><th>Asignado</th><th>Inicio</th><th>DescripciÃ³n</th><th>Paro (h)</th><th>ReparaciÃ³n (h)</th><th>Adjunto</th></tr>
    </thead><tbody></tbody></table></div>
  </section>

  <!-- Indicadores -->
  <section id="indicadoresSec" class="card" style="display:none">
    <h2>Indicadores</h2>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <div style="background:#fff;border-radius:10px;padding:10px;min-width:140px"><div class="small">MTTR global (h)</div><div id="kpiMttrG" style="font-size:22px;font-weight:800">0</div></div>
      <div style="background:#fff;border-radius:10px;padding:10px;min-width:140px"><div class="small">MTBF global (h)</div><div id="kpiMtbfG" style="font-size:22px;font-weight:800">0</div></div>
      <div style="background:#fff;border-radius:10px;padding:10px;min-width:140px"><div class="small">Disponibilidad (%)</div><div id="kpiDispG" style="font-size:22px;font-weight:800">0</div></div>
      <div style="background:#fff;border-radius:10px;padding:10px;min-width:140px"><div class="small">OEE estimado (%)</div><div id="kpiOeeG" style="font-size:22px;font-weight:800">0</div></div>
    </div>
    <div class="card"><b>MTTR por semana</b><canvas id="chartMttr2" height="160"></canvas></div>
    <div class="card"><b>Incidencias por semana</b><canvas id="chartCount2" height="160"></canvas></div>
    <div id="indicEmpty" style="display:none;color:#555;margin-top:8px">AÃºn no hay incidencias registradas.</div>
  </section>

  <!-- Inventario -->
  <section id="inventarioSec" class="card" style="display:none">
    <h2>Inventario</h2>
    <div class="card">
      <h3>AÃ±adir repuesto</h3>
      <div style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr 1fr;gap:8px">
        <input id="invNombre" placeholder="Nombre">
        <input id="invRef" placeholder="Referencia">
        <input id="invStock" type="number" min="0" placeholder="Stock">
        <input id="invMin" type="number" min="0" placeholder="MÃ­nimo">
        <button class="btn" id="btnInvAdd">AÃ±adir</button>
      </div>
    </div>
    <div class="card"><h3>Buscar</h3><input id="invSearch" placeholder="Nombre o referenciaâ€¦"></div>
    <div class="card"><div class="table-wrap"><table class="table" id="invTable"><thead><tr><th>Nombre</th><th>Referencia</th><th>Stock</th><th>MÃ­nimo</th><th>Acciones</th></tr></thead><tbody></tbody></table></div></div>
  </section>

  <!-- Ã“rdenes de trabajo -->
  <section id="otSec" class="card" style="display:none">
    <h2>Ã“rdenes de Trabajo</h2>
    <div class="card" id="otForm">
      <h3>Nueva O.T.</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div style="grid-column:1/3"><label>Equipo</label><br><select id="otEquipo"></select></div>
        <div><label>Prioridad</label><br><select id="otPrio">
          <option value="R">Rojo Â· Urgente</option><option value="N">Naranja Â· Alta</option>
          <option value="A">Amarillo Â· Preventivo</option><option value="V">Verde Â· Predictivo</option></select></div>
        <div><label>Asignado a</label><br><input id="otAsignado" placeholder="TÃ©cnico"></div>
        <div><label>Vencimiento</label><br><input id="otDue" type="date"></div>
        <div style="grid-column:1/3"><label>TÃ­tulo</label><br><input id="otTitle" placeholder="Ej. Sustituir filtroâ€¦"></div>
        <div style="grid-column:1/3"><label>Adjunto (URL Drive)</label><br><input id="otAdj" placeholder="Enlace Drive (opcional)"></div>
        <div style="grid-column:1/3"><label>DescripciÃ³n</label><br><textarea id="otDesc" rows="3"></textarea></div>
      </div>
      <div style="margin-top:8px"><button class="btn" id="btnOtAdd">Crear O.T.</button></div>
    </div>
    <div class="card">
      <h3>Cola (mÃ¡s crÃ­ticas primero)</h3>
      <div id="otList"></div>
    </div>
  </section>

  <!-- Personal -->
  <section id="personalSec" class="card" style="display:none">
    <h2>Personal (solo Admin)</h2>
    <div class="card">
      <h3>Alta / ediciÃ³n</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <input id="pId" placeholder="(automÃ¡tico al crear)" disabled>
        <input id="pNombre" placeholder="Nombre">
        <input id="pEmail" placeholder="Email">
        <select id="pRol"><option>Administrador</option><option>Gerente</option><option>Encargado</option><option>Tecnico</option><option>Visor</option></select>
        <select id="pActivo"><option value="true">Activo</option><option value="false">Inactivo</option></select>
        <input id="pTelefono" placeholder="TelÃ©fono">
        <input id="pEsp" placeholder="Especialidad">
        <input id="pTurno" placeholder="Turno">
      </div>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button class="btn" id="btnPSave">Guardar</button>
        <button class="btn ghost" id="btnPClear">Limpiar</button>
      </div>
    </div>
    <div class="card">
      <h3>Listado</h3>
      <div class="table-wrap"><table class="table" id="pTable"><thead><tr><th>Nombre</th><th>Email</th><th>Rol</th><th>Activo</th><th>TelÃ©fono</th><th>Especialidad</th><th>Turno</th><th>Acciones</th></tr></thead><tbody></tbody></table></div>
    </div>
  </section>
</div>

<div class="toast" id="toast"><div class="in"><div id="toastMsg">Listo.</div></div></div>

<script>
"use strict";
const API_BASE = "https://script.google.com/macros/s/AKfycbxbIWXzjq__2OSL7UhkxeanoBcvuz_5QC3dyBvyHVlY_W_F5WSVhts0I1HVOh2ofp4A/exec";

let STATE=[], INC=[], OT=[], PERSONAL=[];

const q=s=>document.querySelector(s), qs=s=>document.querySelectorAll(s);
const toast=msg=>{const t=q('#toast'); q('#toastMsg').textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',1600);};

const apiGet=async(params)=>{const u=new URL(API_BASE); Object.entries(params||{}).forEach(([k,v])=>u.searchParams.set(k,v));
  try{const r=await fetch(u.toString()); return await r.json();}catch(e){return {ok:false,error:String(e)}}};
const apiPost=async(body)=>{try{const r=await fetch(API_BASE,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body||{})}); return await r.json();}catch(e){return {ok:false,error:String(e)}}};

const statusDot=s=> s==='Parada'?'r':(s==='Restricciones'?'o':'g');
const groupBy=(arr,key)=>arr.reduce((a,it)=>{const k=it[key]||'â€”';(a[k]=a[k]||[]).push(it);return a;},{});
const setActive=(hash)=>{['equiposSec','puentesSec','otrosSec','incidenciasSec','indicadoresSec','inventarioSec','otSec','personalSec']
  .forEach(id=> q('#'+id).style.display='none'); (q(hash+'Sec')||q('#equiposSec')).style.display='block'; window.scrollTo({top:0,behavior:'smooth'});};

function renderItems(list,label){
  const grid=document.createElement('div'); grid.className='grid';
  list.forEach(it=>{
    const wrap=document.createElement('div'); wrap.className='item';
    wrap.innerHTML=`<div class="item-left"><span class="dot ${statusDot(it.estado||'En marcha')}"></span>
      <div><div class="title">${it.nombre}</div><div class="small">${label}</div></div></div>`;
    const r=document.createElement('div'); r.style.marginLeft='auto';
    const sel=document.createElement('select'); ['En marcha','Restricciones','Parada']
      .forEach(t=>{const o=document.createElement('option'); o.value=t;o.textContent=t;if((it.estado||'En marcha')===t)o.selected=true; sel.appendChild(o);});
    sel.addEventListener('change',async()=>{await apiPost({res:'state',fn:'set',name:it.nombre,estado:sel.value}); await loadState();});
    const b=document.createElement('button'); b.className='btn warn'; b.textContent='Parada prolongada';
    b.addEventListener('click',async()=>{await apiPost({res:'alert',fn:'parada',equipo:it.nombre}); await loadState();});
    r.appendChild(sel); r.appendChild(b); wrap.appendChild(r); grid.appendChild(wrap);
  }); return grid;
}

function renderAlert(){
  const items=STATE.filter(s=> s.estado==='Parada'||s.estado==='Restricciones');
  const box=q('#alerta'), list=q('#alertaList');
  if(!items.length){box.style.display='none'; list.innerHTML=''; return;}
  box.style.display='block'; list.innerHTML=items.map(i=>`${i.nombre} â€” ${i.estado}`).join('<br>');
}

function renderEquipos(){
  const host=q('#equiposGroups'); host.innerHTML='';
  const grupos=groupBy(STATE.filter(s=>!String(s.grupo||'').startsWith('Puentes GrÃºa') && s.grupo!=='Otros (auxiliares)'),'grupo');
  Object.keys(grupos).forEach(g=>{const card=document.createElement('div'); card.className='card';
    card.innerHTML=`<h3>${g}</h3>`; card.appendChild(renderItems(grupos[g],g)); host.appendChild(card);});
}
function renderGruas(){
  const host=q('#gruasGroups'); host.innerHTML='';
  const grupos=groupBy(STATE.filter(s=>String(s.grupo||'').startsWith('Puentes GrÃºa')),'grupo');
  Object.keys(grupos).forEach(g=>{const card=document.createElement('div'); card.className='card';
    card.innerHTML=`<h3>${g.replace('Puentes GrÃºa Â· ','Nave ')}</h3>`; card.appendChild(renderItems(grupos[g],g)); host.appendChild(card);});
}
function renderOtros(){
  const host=q('#otrosWrap'); host.innerHTML='';
  host.appendChild(renderItems(STATE.filter(s=>s.grupo==='Otros (auxiliares)'),'Auxiliar'));
}

async function loadState(){
  let r=await apiGet({res:'state',fn:'list'});
  if(!r.ok){r={items:[]};}
  if(!(r.items||[]).length){await apiPost({res:'state',fn:'seed'}); r=await apiGet({res:'state',fn:'list'});}
  STATE=r.items||[]; renderEquipos(); renderGruas(); renderOtros(); renderAlert();
  ['#incEquipo','#fEquipo','#otEquipo'].forEach(sel=>{const el=q(sel); if(!el) return; el.innerHTML=''; STATE.forEach(s=>{const o=document.createElement('option'); o.value=s.nombre;o.textContent=s.nombre; el.appendChild(o);});});
}

async function loadIncid(){ const r=await apiGet({res:'incid',fn:'list'}); INC=r.items||[]; aplicarFiltros(); }
function aplicarFiltros(){
  const fE=q('#fEquipo').value, fT=q('#fTipo').value, fR=q('#fRes').value, fTxt=(q('#fTexto').value||'').toLowerCase();
  const arr=(INC||[]).filter(i=>{
    if(fE && i.equipo!==fE) return false;
    if(fT && i.tipo!==fT) return false;
    if(fR && i.res!==fR) return false;
    if(fTxt){const blob=(i.equipo+' '+(i.desc||'')+' '+(i.repTxt||'')).toLowerCase(); if(!blob.includes(fTxt)) return false;}
    return true;
  }); renderIncidTable(arr); renderGlobalKPIs();
}
function renderIncidTable(arr){
  const tb=q('#incTable tbody'); tb.innerHTML='';
  (arr||[]).forEach(i=>{
    const tr=document.createElement('tr');
    const link=i.adj? `<a href="${i.adj}" target="_blank">Abrir</a>`:'â€”';
    const inicio=i.inicio? new Date(i.inicio).toLocaleString():'â€”';
    tr.innerHTML=`<td>${new Date(i.created).toLocaleString()}</td><td><span class="badge">${i.equipo}</span></td>
      <td>${i.tipo}</td><td>${i.res}</td><td>${i.reportante||'â€”'}</td><td>${i.asignado||'â€”'}</td>
      <td>${inicio}</td><td>${(i.desc||'').replace(/\n/g,' ')}</td><td>${(+i.hParo||0).toFixed(2)}</td>
      <td>${(+i.hRep||0).toFixed(2)}</td><td>${link}</td>`; tb.appendChild(tr);
  });
}

function getHoursPerWeek(){return 120;} // como acordamos
function isoWeek(d){const dt=new Date(d),t=new Date(dt.valueOf());const dn=(dt.getDay()+6)%7;t.setDate(t.getDate()-dn+3);
  const ft=new Date(t.getFullYear(),0,4);return 1+Math.round(((t-ft)/86400000-3+((ft.getDay()+6)%7))/7);}
function drawBars(id,labels,vals){
  const c=q('#'+id),ctx=c.getContext('2d'); const W=c.width=c.clientWidth,H=c.height=c.clientHeight;
  ctx.clearRect(0,0,W,H); const pad=28,max=Math.max(1,...vals),step=(W-pad*2)/Math.max(1,(labels||[]).length),bw=step*0.7;
  ctx.strokeStyle='#ccc'; ctx.beginPath(); ctx.moveTo(pad,H-pad); ctx.lineTo(W-pad,H-pad); ctx.stroke();
  (vals||[]).forEach((v,i)=>{const x=pad+i*step+(step-bw)/2, h=(H-pad*2)*(v/max), y=H-pad-h; ctx.fillStyle='rgba(229,57,53,.9)'; ctx.fillRect(x,y,bw,h);
    ctx.fillStyle='#333'; ctx.font='11px system-ui'; ctx.textAlign='center'; ctx.fillText(String(labels[i]), x+bw/2, H-8);});
}
function renderGlobalKPIs(){
  const corr=(INC||[]).filter(i=>i.tipo==='Correctivo'), byW={};
  corr.forEach(i=>{const w=isoWeek(i.created); if(!byW[w]) byW[w]={count:0,rep:0}; byW[w].count++; byW[w].rep+=(+i.hRep||0);});
  const weeks=Object.keys(byW).sort((a,b)=>a-b), HPW=getHoursPerWeek();
  const mttr=corr.length? corr.reduce((s,i)=>s+(+i.hRep||0),0)/corr.length : 0;
  const mtbfWeeks=weeks.map(w=> byW[w].count? HPW/byW[w].count : HPW);
  const meanMtbf=weeks.length? mtbfWeeks.reduce((a,b)=>a+b,0)/weeks.length : 0;
  q('#kpiMttrG').textContent=mttr.toFixed(2); q('#kpiMtbfG').textContent=meanMtbf.toFixed(1);
  const dispWeeks=weeks.map((w,i)=>{const f=byW[w].count; const mtbf=mtbfWeeks[i]; const mttrW=f? byW[w].rep/f : 0; return (mtbf/(mtbf+mttrW))*100;});
  const meanDisp=weeks.length? dispWeeks.reduce((a,b)=>a+b,0)/weeks.length : 0; q('#kpiDispG').textContent=meanDisp.toFixed(1); q('#kpiOeeG').textContent=meanDisp.toFixed(1);
  drawBars('chartMttr2',weeks,weeks.map((w,i)=>{const f=byW[w].count; return f? byW[w].rep/f : 0;}));
  drawBars('chartCount2',weeks,weeks.map(w=>byW[w].count));
}

async function addIncidencia(){
  const item={equipo:q('#incEquipo').value,tipo:q('#incTipo').value,res:q('#incResultado').value,reportante:q('#incReportante').value,
    asignado:q('#incAsignado').value,rep:q('#incRep').value,repTxt:q('#incRepTxt').value,hParo:+(q('#incHorasParo').value||0),
    hRep:+(q('#incHorasRepar').value||0),inicio:q('#incInicio').value,adj:q('#incAdj').value,desc:q('#incDesc').value};
  if(!item.equipo||!item.desc){alert('Equipo y descripciÃ³n obligatorios');return;}
  const r=await apiPost({res:'incid',fn:'add',item}); if(!r.ok){alert(r.error||'Error');return;}
  await loadIncid(); await loadState(); toast('Incidencia creada');
}

async function invList(){const r=await apiGet({res:'inv',fn:'list'}); return r.items||[];}
async function renderInventario(){
  const list=await invList(); const qtxt=(q('#invSearch').value||'').toLowerCase();
  const vis=list.filter(x=> (x.nombre||'').toLowerCase().includes(qtxt)||(x.ref||'').toLowerCase().includes(qtxt));
  const tb=q('#invTable tbody'); tb.innerHTML='';
  vis.forEach(it=>{
    const tr=document.createElement('tr'); tr.innerHTML=`
      <td>${it.nombre}</td><td>${it.ref}</td><td>${it.stock}</td><td>${it.minimo}</td>
      <td><button class="btn ghost" data-ref="${it.ref}" data-d="-1">âˆ’</button>
          <button class="btn ghost" data-ref="${it.ref}" data-d="1">+</button></td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('button').forEach(b=> b.addEventListener('click', async (e)=>{
    const ref=e.target.getAttribute('data-ref'), d=parseInt(e.target.getAttribute('data-d')||'0',10);
    await apiPost({res:'inv',fn:'delta',ref,delta:d}); await renderInventario();
  }));
}
async function invAdd(){
  const item={nombre:q('#invNombre').value,ref:q('#invRef').value,stock:+(q('#invStock').value||0),minimo:+(q('#invMin').value||0)};
  if(!item.nombre||!item.ref){alert('Nombre y referencia');return;}
  await apiPost({res:'inv',fn:'add',item}); ['invNombre','invRef','invStock','invMin'].forEach(id=>q('#'+id).value=''); renderInventario();
}

const prioOrder=p=>p==='R'?1:p==='N'?2:p==='A'?3:4;
async function otLoad(){const r=await apiGet({res:'ot',fn:'list'}); OT=r.items||[]; renderOT();}
function renderOT(){
  const host=q('#otList'); host.innerHTML='';
  [...(OT||[])].sort((a,b)=> prioOrder(a.prioridad)-prioOrder(b.prioridad) || new Date(a.created)-new Date(b.created))
    .forEach(it=>{
      const card=document.createElement('div'); card.className='card ot-card ot-'+it.prioridad;
      const adj=it.adj?`<a href="${it.adj}" target="_blank">Adjunto</a>`:''; 
      card.innerHTML=`<div style="display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap">
        <div><span class="badge" style="background:${it.prioridad==='R'?'#d32f2f':it.prioridad==='N'?'#f57c00':it.prioridad==='A'?'#f9a825':'#2e7d32'};color:#fff">${it.prioridad}</span> <b>${it.titulo}</b>
        <div class="small">${it.equipo} â€¢ asignado a ${it.asignado||'â€”'}</div></div>
        <div><select data-id="${it.id}" class="otEstado"><option ${it.estado==='Abierta'?'selected':''}>Abierta</option><option ${it.estado==='En curso'?'selected':''}>En curso</option><option ${it.estado==='Cerrada'?'selected':''}>Cerrada</option></select></div>
      </div><div style="margin-top:6px">${it.desc||''}</div>${it.vencimiento?('<div class="small">Vence: '+it.vencimiento+'</div>'):''}<div>${adj}</div>`;
      host.appendChild(card);
    });
  host.querySelectorAll('.otEstado').forEach(sel=> sel.addEventListener('change', async (e)=>{
    const id=e.target.getAttribute('data-id'), est=e.target.value;
    const r=await apiPost({res:'ot',fn:'set',id,estado:est}); if(!r.ok){alert(r.error||'Error');return;} await otLoad();
  }));
}
async function otAdd(){
  const item={equipo:q('#otEquipo').value,prioridad:q('#otPrio').value,asignado:q('#otAsignado').value,
    vencimiento:q('#otDue').value,titulo:q('#otTitle').value,adj:q('#otAdj').value,desc:q('#otDesc').value};
  if(!item.titulo){alert('TÃ­tulo obligatorio');return;}
  const r=await apiPost({res:'ot',fn:'add',item}); if(!r.ok){alert(r.error||'Error');return;}
  ['otTitle','otDesc','otDue','otAdj'].forEach(id=>q('#'+id).value=''); await otLoad();
}

async function pLoad(){ const r=await apiGet({res:'personal',fn:'list'}); PERSONAL=r.items||[]; const tb=q('#pTable tbody'); tb.innerHTML='';
  (PERSONAL||[]).forEach(p=>{const tr=document.createElement('tr'); tr.innerHTML=
    `<td>${p.nombre}</td><td>${p.email}</td><td>${p.rol}</td><td>${p.activo?'SÃ­':'No'}</td>
     <td>${p.telefono||''}</td><td>${p.especialidad||''}</td><td>${p.turno||''}</td><td><button class="btn ghost" disabled>Editar</button></td>`;
    tb.appendChild(tr);
  });
}

function attachNav(){
  const menuBtn=q('#pagesBtn'), sessBtn=q('#sessBtn'), menu=q('#menuPanel'), sess=q('#sessionPanel');
  menuBtn.addEventListener('click', e=>{e.stopPropagation(); menu.style.display=menu.style.display==='block'?'none':'block'; sess.style.display='none';});
  sessBtn.addEventListener('click', e=>{e.stopPropagation(); sess.style.display=sess.style.display==='block'?'none':'block'; menu.style.display='none';});
  document.addEventListener('click', ()=>{menu.style.display='none'; sess.style.display='none';});
  q('#menuPanel').querySelectorAll('a').forEach(a=> a.addEventListener('click',(e)=>{e.preventDefault(); setActive(a.getAttribute('href'));}));
}
function attachActions(){
  q('#btnParada').addEventListener('click', async()=>{const nombre=prompt('Equipo en parada prolongada'); if(!nombre)return; await apiPost({res:'alert',fn:'parada',equipo:nombre}); await loadState();});
  q('#btnAddInc').addEventListener('click', addIncidencia);
  q('#btnAplicarFiltros').addEventListener('click', aplicarFiltros);
  q('#btnResetFiltros').addEventListener('click', ()=>{q('#fEquipo').value='';q('#fTipo').value='';q('#fRes').value='';q('#fTexto').value=''; aplicarFiltros();});
  q('#btnInvAdd').addEventListener('click', invAdd);
  q('#btnOtAdd').addEventListener('click', otAdd);
  q('#loginLink').addEventListener('click', async (e)=>{e.preventDefault(); const d=await apiGet({res:'personal',fn:'list'}); const activos=(d.items||[]).filter(p=>p.activo); const pick=prompt('Escribe tu email o elige:\n'+activos.map(p=>p.email).join('\n')); if(!pick)return; const f=activos.find(p=>(p.email||'').toLowerCase()===pick.toLowerCase()); const role=f?(f.rol||'Visor'):'Visor'; q('#sessInfo').textContent='Usuario: '+pick+' Â· '+role;});
  q('#logoutLink').addEventListener('click', (e)=>{e.preventDefault(); q('#sessInfo').textContent='Usuario: Invitado';});
}

async function boot(){
  attachNav(); attachActions();
  setActive(location.hash||'#equipos');           // visible aunque el backend tarde
  await loadState(); await loadIncid();
  await renderInventario(); await otLoad(); await pLoad();
}
window.addEventListener('load', boot);
</script>
</body>
</html>