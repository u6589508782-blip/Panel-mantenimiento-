<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CDL · CMMS v29</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<style>
:root{
  --brand1:#A60000; --brand2:#E43B3B; --bg:#F5F7FA; --card:#FFFFFF;
  --ok:#16a34a; --warn:#f59e0b; --stop:#dc2626; --muted:#5B6673; --ink:#0E1824;
  --line:#E6ECF1; --ring:0 10px 30px rgba(0,0,0,.08);
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);font-family:Inter,system-ui,sans-serif;color:var(--ink)}

/* ===== Header ===== */
header{position:sticky;top:0;z-index:60;background:#fff;border-bottom:3px solid #e8ecef}
.nav{position:relative;display:flex;align-items:center;gap:.75rem;padding:.65rem .9rem}
.logo{display:flex;align-items:center;gap:1rem;min-width:0}
.logo img{height:56px;width:auto;object-fit:contain}
.logo h1{font-size:1.55rem;margin:0;font-weight:800;white-space:nowrap;color:#0f172a}
.grow{flex:1 1 auto}
/* Rol discreto arriba a la derecha */
.rolechip{position:absolute;top:4px;right:8px;font-size:.68rem;font-weight:700;color:#475569;opacity:.85}

/* Menús */
.menu{position:relative}
.mbtn{border:0;border-radius:14px;padding:.7rem .9rem;font-weight:800;cursor:pointer;background:linear-gradient(90deg,var(--brand1),var(--brand2));color:#fff}
.mbtn-pages{background:#0f172a}
.panel{position:absolute;right:0;top:120%;background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:var(--ring);min-width:300px;overflow:hidden;z-index:70}
.row{padding:.85rem 1rem;border-bottom:1px solid #edf2f7}
.row:last-child{border-bottom:0}
label.small{font-size:.8rem;color:#6b7280;display:block;margin-bottom:.3rem}
.actions{display:flex;gap:.5rem;flex-wrap:wrap}
.btn{border:0;border-radius:12px;padding:.6rem .85rem;font-weight:700;cursor:pointer}
.btn-ghost{background:#f2f4f7} .btn-ghost:hover{background:#e9eef5}
.btn-outline{background:#fff;border:1px solid #dbe3ea;color:#0f172a}
.btn-danger{background:var(--stop);color:#fff}
.btn-brand{background:linear-gradient(90deg,var(--brand1),var(--brand2));color:#fff}
.hidden{display:none!important}

/* ===== Contenido ===== */
.container{max-width:980px;margin:0 auto;padding:1rem}

/* Chips / leyenda */
.toolbar{background:var(--card);border-radius:18px;box-shadow:var(--ring);padding:.75rem 1rem;margin:1rem 0;display:flex;flex-wrap:wrap;gap:.6rem;align-items:center}
.badge-chip{display:inline-flex;align-items:center;gap:.5rem;padding:.45rem .75rem;border-radius:999px;background:#fff;border:1px solid #e5e7eb;box-shadow:var(--ring);font-weight:700}
.dot{width:16px;height:16px;border-radius:50%}
.dot.ok{background:var(--ok)} .dot.warn{background:var(--warn)} .dot.stop{background:var(--stop)}

/* Tarjetas de equipo */
.group{margin:1.2rem 0}
.group h2{margin:.2rem 0 .7rem;font-size:1.1rem}
.card{background:var(--card);border-radius:18px;box-shadow:var(--ring);padding:.85rem .95rem;margin:.45rem 0;display:flex;gap:.9rem;align-items:center;flex-wrap:wrap;border:1px solid var(--line)}
.name{font-weight:800;font-size:1.05rem;min-width:200px}
.sub{color:var(--muted);font-size:.9rem}
.pilot{width:22px;height:22px;border-radius:50%;box-shadow:0 0 0 3px #fff,0 0 0 6px rgba(0,0,0,.05),inset 0 -2px 4px rgba(0,0,0,.12)}
.p-ok{background:var(--ok)} .p-warn{background:var(--warn)} .p-stop{background:var(--stop)}
.right{margin-left:auto;display:flex;gap:.45rem;align-items:center;flex-wrap:wrap}

/* Botones de estado estilo chip */
.btn-mini{padding:.38rem .55rem;border-radius:10px;font-weight:700;font-size:.9rem}
.btn-chip{border:1px solid transparent;border-radius:999px;padding:.45rem .75rem;font-weight:800}
.btn-ok{background:#e7f8ee;border-color:#b7e1c5;color:#14532d}
.btn-warn{background:#fff2df;border-color:#ffd7a8;color:#7c2d12}
.btn-stop{background:#ffe7e7;border-color:#ffc9c9;color:#7f1d1d}
.btn-ghost-strong{background:#e6eefb;color:#0f3a7f;font-weight:800}
.btn-mail{background:var(--stop);color:#fff} /* Parada prolongada (se mantiene intenso) */
.link{color:#0f3a7f;font-weight:800;cursor:pointer}

/* Tablas / bloques */
.kpi{background:var(--card);border-radius:18px;box-shadow:var(--ring);padding:1rem}
.kpi h3{margin:.2rem 0 .8rem}
table{width:100%;border-collapse:separate;border-spacing:0 8px}
th,td{padding:.62rem .85rem;background:#fff;border-bottom:1px solid #F2F5F8}
th{text-align:left;color:#4B5563;font-size:.9rem;background:#f8fafc}
tr td:first-child, tr th:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px}
tr td:last-child, tr th:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px}

/* Grids */
.inv-grid{display:grid;gap:10px;grid-template-columns:1fr 1fr 1fr 1fr}
@media(max-width:720px){.inv-grid{grid-template-columns:1fr 1fr}.right{justify-content:flex-start}}
.form-grid{display:grid;gap:10px;grid-template-columns:1fr 1fr}
@media(max-width:720px){.form-grid{grid-template-columns:1fr}}

/* TV */
.tv-wrap{max-width:1400px}
.tv-grid{display:grid;gap:16px}
@media(min-width:760px){.tv-grid{grid-template-columns:1fr 1fr}}
@media(min-width:1180px){.tv-grid{grid-template-columns:1fr 1fr 1fr}}
.tv-card{background:#fff;border-radius:22px;box-shadow:var(--ring);padding:18px}
.tv-title{display:flex;align-items:center;gap:.6rem;margin:0 0 10px}
.tv-title .dot{width:20px;height:20px}
.tv-list{display:flex;flex-direction:column;gap:8px;max-height:60vh;overflow:auto}
.tv-item{padding:10px 12px;border-radius:12px;font-weight:700}
.tv-item.stop{background:#fee2e2;color:#7f1d1d}
.tv-item.warn{background:#ffedd5;color:#7c2d12}
.tv-item.stock{background:#e0f2fe;color:#0c4a6e}
.tv-legend{color:#64748b;font-size:.9rem;margin-left:8px}
.fullscreen{position:fixed;inset:0;background:var(--bg);padding:14px;z-index:80;overflow:auto}

/* Footer */
footer{padding:2rem 1rem;color:#9aa7b4;text-align:center}

/* Extras: paginación, orden, validaciones, toasts */
.nowrap{white-space:nowrap} .num{text-align:right;font-variant-numeric:tabular-nums}
.tag{display:inline-flex;align-items:center;gap:.35rem;padding:.18rem .5rem;border-radius:999px;font-weight:700;line-height:1;border:1px solid transparent;font-size:.82rem}
.tag-corr{color:#991B1B;background:#FEE2E2;border-color:#FECACA}
.tag-prev{color:#0C4A6E;background:#E0F2FE;border-color:#BAE6FD}
.tag-pred{color:#6B21A8;background:#F3E8FF;border-color:#E9D5FF}
.tag-mej{color:#065F46;background:#D1FAE5;border-color:#A7F3D0}
.tag-sol{color:#065F46;background:#D1FAE5;border-color:#A7F3D0}
.tag-rest{color:#7C2D12;background:#FFEDD5;border-color:#FED7AA}
.tag-par{color:#7F1D1D;background:#FEE2E2;border-color:#FECACA}
.pager{display:flex;align-items:center;gap:.5rem;flex-wrap:wrap;justify-content:flex-end;margin-top:.6rem;font-size:.9rem;color:#4B5563}
.pager .info{margin-right:auto}
.page-btn{border:1px solid var(--line);background:#fff;cursor:pointer;border-radius:10px;padding:.35rem .6rem;font-weight:700}
.page-btn[disabled]{opacity:.5;cursor:not-allowed}
.page-btn.active{background:#0F172A;color:#fff;border-color:#0F172A}
.page-size{border:1px solid var(--line);background:#fff;border-radius:10px;padding:.35rem .5rem;font:inherit}
@media (max-width:640px){.pager{justify-content:center}.pager .info{display:none}}
.th-sort{display:inline-flex;align-items:center;gap:.35rem;cursor:pointer;user-select:none;border:0;background:transparent;font:inherit;font-weight:700;color:#4B5563;padding:.15rem .25rem;border-radius:8px}
.th-sort:hover{background:#F3F4F6}
.th-caret{display:inline-block;width:0;height:0;border-left:5px solid transparent;border-right:5px solid transparent}
.th-sort.asc .th-caret{border-bottom:7px solid #0F172A}
.th-sort.desc .th-caret{border-top:7px solid #0F172A}
.field-invalid{border-color:#ef4444!important;outline:2px solid color-mix(in srgb,#ef4444 35%,transparent)}
.field-msg{font-size:.8rem;color:#991b1b;margin-top:.25rem}
.counter{font-size:.78rem;color:#64748b;margin-left:.35rem}
.counter.warn{color:#b45309}
.toast{position:fixed;right:14px;bottom:14px;z-index:90;background:#0f172a;color:#fff;padding:.6rem .8rem;border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.18)}

/* Inventario reforzado */
.row-low{background:#FEF3C7!important}
.row-low .sub{color:#7C2D12}
.badge-low{display:inline-flex;align-items:center;gap:.35rem;padding:.15rem .45rem;border-radius:999px;font-weight:700;background:#FFEDD5;color:#7C2D12;border:1px solid #FED7AA;font-size:.78rem;line-height:1}

/* Mostrar/ocultar contraseña – icono serio (SVG) */
.pw{position:relative;display:flex;align-items:center}
.pw input{padding-right:2.4rem}
.pw-toggle{position:absolute;right:.5rem;top:50%;transform:translateY(-50%);border:0;background:#f2f4f7;border-radius:8px;padding:.28rem .38rem;cursor:pointer}
.pw-toggle:hover{background:#e9eef5}
.pw-toggle svg{width:18px;height:18px;display:block;stroke:#334155;stroke-width:1.5;fill:none}
.pw-toggle[aria-pressed="true"] svg{stroke:#111827}

/* QR */
.qr-card{background:#fff;border:1px solid var(--line);border-radius:16px;padding:14px;box-shadow:var(--ring)}
.qr-wrap{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
.qr-box{width:160px;height:160px;border:1px dashed #dbe3ea;border-radius:12px;display:flex;align-items:center;justify-content:center;background:#fff}
</style>
</head>

<body>
<header>
  <div class="nav" id="navBar">
    <div class="logo">
      <img src="logo_mantenimiento.png" alt="Logo" onerror="this.src='logo_mantenimiento.PNG'">
      <h1>CDL · Panel de mantenimiento</h1>
    </div>
    <div class="grow"></div>

    <!-- Rol discreto -->
    <span id="roleChip" class="rolechip">Invitado</span>

    <!-- Menú Páginas -->
    <div class="menu">
      <button id="pagesBtn" class="mbtn mbtn-pages">☰</button>
      <div id="pagesPanel" class="panel hidden" style="min-width:260px">
        <div class="row">
          <div class="actions">
            <button class="btn btn-ghost" onclick="nav('equipos')">Equipos</button>
            <button class="btn btn-ghost" id="mGruas" onclick="nav('gruas')">Puentes Grúa</button>
            <button class="btn btn-ghost" id="mOtros" onclick="nav('otros')">Otros</button>
            <button class="btn btn-ghost" id="mIncid" onclick="nav('incidencias')">Incidencias</button>
            <button class="btn btn-ghost" id="mIndic" onclick="nav('indicadores')">Indicadores</button>
            <button class="btn btn-ghost" id="mOT" onclick="nav('ot')">OT</button>
            <button class="btn btn-ghost" id="mInv" onclick="nav('inventario')">Inventario</button>
            <button class="btn btn-ghost" id="mTV" onclick="nav('tv')">Dashboard TV</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Menú Usuario -->
    <div class="menu">
      <button id="userBtn" class="mbtn">⋯</button>
      <div id="userPanel" class="panel hidden">
        <div class="row">
          <label class="small">Usuario</label>
          <select id="userSelect">
            <option value="invitado">Invitado</option>
            <option value="admin">Administrador</option>
            <option value="gerente">Gerente</option>
            <option value="encargado">Encargado</option>
            <option value="produccion">Producción</option>
            <option value="rt11">RT1.1</option><option value="rt12">RT1.2</option>
            <option value="rt21">RT2.1</option><option value="rt22">RT2.2</option>
            <option value="rt31">RT3.1</option><option value="rt32">RT3.2</option>
            <option value="tcoint">Tco.INT</option>
            <option value="subc">Subcontrata</option>
          </select>

          <label class="small" style="margin-top:.4rem">Contraseña</label>
          <div class="pw">
            <input id="userPass" type="password" placeholder="••••••••"/>
            <button type="button" class="pw-toggle" data-target="userPass" aria-label="Mostrar contraseña" aria-pressed="false">
              <svg viewBox="0 0 24 24"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7Z"/><circle cx="12" cy="12" r="3.5"/></svg>
            </button>
          </div>

          <div class="actions" style="margin-top:.6rem">
            <button class="btn btn-brand" onclick="login()">Entrar</button>
            <button class="btn btn-ghost" onclick="logout()">Salir</button>
          </div>
        </div>

        <div class="row">
          <label class="small">Cambiar contraseña</label>
          <div class="pw">
            <input id="oldPass" type="password" placeholder="Contraseña actual">
            <button type="button" class="pw-toggle" data-target="oldPass" aria-label="Mostrar contraseña" aria-pressed="false">
              <svg viewBox="0 0 24 24"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7Z"/><circle cx="12" cy="12" r="3.5"/></svg>
            </button>
          </div>
          <div class="pw" style="margin-top:.4rem">
            <input id="newPass" type="password" placeholder="Nueva contraseña">
            <button type="button" class="pw-toggle" data-target="newPass" aria-label="Mostrar contraseña" aria-pressed="false">
              <svg viewBox="0 0 24 24"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7Z"/><circle cx="12" cy="12" r="3.5"/></svg>
            </button>
          </div>
          <div class="actions" style="margin-top:.6rem">
            <button class="btn btn-ghost" onclick="changePwd()">Cambiar</button>
          </div>
          <div id="pwdMsg" class="small" style="margin-top:.4rem;color:#64748b"></div>
        </div>
      </div>
    </div>
  </div>
</header>

<main class="container">

  <!-- EQUIPOS -->
  <section id="page-equipos">
    <div id="equiposWrap"></div>
    <div class="toolbar">
      <span class="badge-chip"><span class="dot stop"></span> Parada</span>
      <span class="badge-chip"><span class="dot warn"></span> Restricciones</span>
      <span class="badge-chip"><span class="dot ok"></span> En marcha</span>
    </div>
  </section>

  <!-- GRÚAS -->
  <section id="page-gruas" class="hidden"><h2>Puentes Grúa</h2><div id="gruasWrap"></div></section>

  <!-- OTROS -->
  <section id="page-otros" class="hidden"><h2>Otros (auxiliares)</h2><div id="otrosWrap"></div></section>

  <!-- INCIDENCIAS -->
  <section id="page-incidencias" class="hidden">
    <div class="kpi">
      <h3>Registrar nueva incidencia</h3>
      <div class="form-grid">
        <label class="req">Equipo <select id="iEquipo"></select></label>
        <label class="req">Tipo
          <select id="iTipo"><option>Correctivo</option><option>Preventivo</option><option>Predictivo</option><option>Mejora</option></select>
        </label>
        <label class="req">Resultado
          <select id="iRes"><option>Solucionado</option><option>Con restricciones</option><option>Parada</option></select>
        </label>
        <label>¿Repuesto? <select id="iRep"><option>No</option><option>Sí</option></select></label>
        <label>Repuesto (txt) <input id="iRepTxt" placeholder="p.ej. THM6-20"/></label>
        <label>Horas de parada <input id="iHParo" type="number" value="0"/></label>
        <label>Horas de reparación <input id="iHRep" type="number" value="0"/></label>
        <label class="req">Fecha inicio <input id="iInicio" type="datetime-local"/></label>
        <label>Fecha fin <input id="iFin" type="datetime-local"/></label>
        <label>Reportante <input id="iReport" placeholder="Nombre"/></label>
        <label>Intervenido por <input id="iAsignado" placeholder="Nombre técnico"/></label>
        <label class="req" style="grid-column:1/-1">Descripción <textarea id="iDesc" rows="3" placeholder="Breve descripción obligatoria"></textarea></label>
      </div>
      <div style="margin-top:.6rem;display:flex;gap:.5rem;flex-wrap:wrap">
        <button class="btn btn-brand" onclick="addIncid()">Añadir incidencia</button>
        <button class="btn btn-ghost" onclick="exportIncidCSV()" id="btnExportIncidCSV">Exportar CSV</button>
        <button class="btn btn-ghost" onclick="exportIncidPDF()" id="btnExportIncidPDF">Exportar PDF</button>
      </div>
    </div>
    <div class="kpi" style="margin-top:12px">
      <div class="filters" style="display:flex;gap:.6rem;align-items:center;flex-wrap:wrap;margin-bottom:.6rem">
        <strong>Historial</strong>
        <input id="filtroIncid" placeholder="Buscar…">
        <select id="fEquipo" class="sel"><option value="">Equipo: todos</option></select>
        <select id="fTipo" class="sel"><option value="">Tipo: todos</option></select>
        <select id="fRes" class="sel"><option value="">Resultado: todos</option></select>
        <button class="btn btn-ghost" onclick="resetIncidFilters()">Limpiar</button>
      </div>
      <div id="incidTableWrap"></div>
    </div>
  </section>

  <!-- INDICADORES -->
  <section id="page-indicadores" class="hidden">
    <div class="kpi">
      <h3>KPIs globales</h3>
      <table>
        <tr><th>KPI</th><th>Valor</th><th>Definición</th></tr>
        <tr><td>MTTR (h)</td><td id="kpiMttrG">0</td><td>Tiempo medio de reparación.</td></tr>
        <tr><td>MTBF (h)</td><td id="kpiMbfG">0</td><td>Tiempo medio entre fallos.</td></tr>
        <tr><td>Disponibilidad (%)</td><td id="kpiDispG">0</td><td>Tiempo disponible / planificado.</td></tr>
        <tr><td>OEE estimado (%)</td><td id="kpiOeeG">0</td><td>Calidad × Rendimiento × Disponibilidad aprox.</td></tr>
      </table>
      <div style="margin-top:.6rem;display:flex;gap:.5rem;flex-wrap:wrap">
        <button class="btn btn-ghost" onclick="exportKPIsCSV()" id="btnExportKPICSV">Descargar KPIs (CSV)</button>
        <button class="btn btn-ghost" onclick="exportKPIsPDF()" id="btnExportKPIPDF">Descargar KPIs (PDF)</button>
      </div>
    </div>
    <div class="kpi" style="margin-top:12px"><h3>Evolución semanal (MTTR)</h3><canvas id="kpiChart" height="140"></canvas></div>
    <div class="kpi" style="margin-top:12px"><h3>Histórico semanal — MTTR</h3><div id="tblMttr"></div></div>
    <div class="kpi" style="margin-top:12px"><h3>Histórico semanal — MTBF</h3><div id="tblMtbf"></div></div>
    <div class="kpi" style="margin-top:12px"><h3>Histórico semanal — Disponibilidad</h3><div id="tblDisp"></div></div>
    <div class="kpi" style="margin-top:12px"><h3>Histórico semanal — OEE estimado</h3><div id="tblOee"></div></div>
  </section>

  <!-- OT -->
  <section id="page-ot" class="hidden">
    <div class="kpi">
      <h3>Nueva OT</h3>
      <div class="form-grid">
        <label class="req">Equipo <select id="otEquipo"></select></label>
        <label class="req">Prioridad
          <select id="otPri"><option value="R">Rojo (Urgente)</option><option value="N">Naranja (Alta)</option><option value="A">Amarillo (Preventivo)</option><option value="V">Verde (Predictivo)</option></select>
        </label>
        <label class="req">Título <input id="otTitulo" placeholder="Breve título"/></label>
        <label>Asignado <input id="otAsign" placeholder="Nombre técnico"/></label>
        <label class="req">Vencimiento <input id="otDue" type="date"/></label>
        <label>Adjunto (URL) <input id="otAdj" placeholder="https://…"/></label>
        <label style="grid-column:1/-1">Descripción <textarea id="otDesc" rows="3"></textarea></label>
      </div>
      <div style="margin-top:.6rem;display:flex;gap:.5rem;flex-wrap:wrap">
        <button id="btnAddOT" class="btn btn-brand" onclick="addOT()">Crear OT</button>
        <button class="btn btn-ghost" onclick="exportOTPDF()">Exportar listado (PDF)</button>
      </div>
    </div>
    <div class="kpi" style="margin-top:12px"><h3>Listado OT</h3><div id="otTableWrap"></div></div>
  </section>

  <!-- INVENTARIO -->
  <section id="page-inventario" class="hidden">
    <div class="kpi">
      <h3>Inventario de repuestos</h3>
      <div style="display:flex;gap:.6rem;flex-wrap:wrap;margin-bottom:.6rem">
        <input id="invSearch" placeholder="Buscar ref/nombre…" oninput="renderInv()">
        <button class="btn btn-ghost" onclick="exportInvCSV()" id="btnExportInvCSV">Exportar CSV</button>
      </div>
      <div class="inv-grid">
        <input id="invNombre" placeholder="Nombre repuesto" />
        <input id="invRef" placeholder="Referencia" />
        <input id="invStock" type="number" placeholder="Stock" />
        <input id="invMin" type="number" placeholder="Mínimo" />
      </div>
      <div style="margin-top:.6rem"><button class="btn btn-brand" onclick="addInv()">Añadir</button></div>
      <div id="invTableWrap" style="margin-top:12px"></div>
    </div>
  </section>

  <!-- DASHBOARD TV -->
  <section id="page-tv" class="hidden">
    <div class="tv-wrap">
      <div style="display:flex;align-items:center">
        <h2 style="margin:0">Dashboard TV (alertas globales)</h2>
        <span class="tv-legend"> · se actualiza cada 30 s</span>
        <div class="grow"></div>
        <button class="btn btn-ghost" onclick="tvFull()">Pantalla completa</button>
      </div>
      <div class="tv-grid" style="margin-top:10px">
        <div class="tv-card"><h3 class="tv-title"><span class="dot stop"></span> Equipos PARADOS</h3><div id="tvParados" class="tv-list"></div></div>
        <div class="tv-card"><h3 class="tv-title"><span class="dot warn"></span> Equipos con RESTRICCIONES</h3><div id="tvRestr" class="tv-list"></div></div>
        <div class="tv-card"><h3 class="tv-title"><span class="dot"></span> Repuestos BAJO MÍNIMO</h3><div id="tvStock" class="tv-list"></div></div>
      </div>
    </div>
  </section>

  <!-- FICHA EQUIPO (router #/equipo/:slug) -->
  <section id="page-equipo" class="hidden"><div id="equipoDetail"></div></section>
  <!-- FICHA REPUESTO (router #/repuesto/:ref) -->
  <section id="page-repuesto" class="hidden"><div id="repuestoDetail"></div></section>

</main>

<footer>v29 · © CDL</footer>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<!-- Librería QR -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
/* ================= CONFIG ================= */
const API_BASE = "https://script.google.com/macros/s/AKfycbyf9lBLIXXKIBOCuERaVaNb8lUkASiYFblFX8_OHS7KMU7tBg0hgtOTfmtAOV59zUAQ/exec";

/* ===== Util ===== */
const byId=(id)=>document.getElementById(id);
function fmt(n){return (Math.round((+n||0)*100)/100).toFixed(2);}
function fmtDate(d){const x=new Date(d); return x.toLocaleString();}
function esc(s){return (s||"").replace(/[&<>"]/g,m=>({"&":"&amp;","<":"&lt;","">":"&gt;","\"":"&quot;"}[m]));}
function toCSV(rows,header){const all=[header,...rows]; return all.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\\n');}
function downloadBlob(txt,mime,name){const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([txt],{type:mime})); a.download=name; a.click();}
function setTxt(id,v){byId(id).textContent=v;}
function getText(id){return byId(id).textContent;}
function val(id){return byId(id).value;}
function buildTableHtml(rows, header){
  const thead = `<tr>${header.map(h=>`<th>${esc(h)}</th>`).join('')}</tr>`;
  const tbody = rows.map(r=>`<tr>${r.map(c=>`<td>${esc(String(c))}</td>`).join('')}</tr>`).join('');
  return `<table><thead>${thead}</thead><tbody>${tbody}</tbody></table>`;
}

/* ===== Auth & Roles ===== */
const ROLE_MAP = {
  "Administrador":"admin","Gerente":"gerente","Encargado":"encargado","Producción":"produccion",
  "RT":"rt","Tco.INT":"tco","Subcontrata":"subc","Invitado":"guest"
};
let currentUser = JSON.parse(localStorage.getItem("CDL_USER")||'{"user":"invitado","rol":"Invitado","group":"guest"}');

function setUser(u){
  currentUser=u;
  localStorage.setItem("CDL_USER",JSON.stringify(u));
  byId('roleChip').textContent=u.rol;
  applyRoleUI();
}
async function login(){
  const user = byId('userSelect').value;
  const pass = byId('userPass').value || "";
  const r = await apiPost({res:'auth', fn:'login', user, pass});
  if(!r.ok){ alert("Error login: " + (r.error || "desconocido")); return; }
  const group = ROLE_MAP[r.rol] || "guest";
  setUser({user, rol: r.rol, group});
  byId('userPanel').classList.add('hidden');
  byId('userPass').value = "";
}
function logout(){ setUser({user:"invitado",rol:"Invitado",group:"guest"}); }
async function changePwd(){
  const user = byId('userSelect').value;
  const old = byId('oldPass').value||"";
  const nu  = byId('newPass').value||"";
  if(!old||!nu){ byId('pwdMsg').textContent="Rellena ambas contraseñas."; return;}
  const r = await apiPost({res:'auth',fn:'changepwd',user,old,nu});
  byId('pwdMsg').textContent = r.ok? "Contraseña cambiada." : "Error al cambiar (credenciales).";
  if(r.ok){ byId('oldPass').value=""; byId('newPass').value=""; }
}

/* permisos por grupo */
function applyRoleUI(){
  const g=currentUser.group;
  const canIndic = (g==="admin"||g==="gerente");
  const canOT    = (g==="admin"||g==="tco");
  const canIncid = (g!=="guest");
  const canInv   = (g!=="guest");
  const canGruas = (g!=="guest");
  const canOtros = (g!=="guest");
  const canTV    = (g!=="guest");

  toggleItem('mIndic', canIndic);
  toggleItem('mOT',    canOT);
  toggleItem('mIncid', canIncid);
  toggleItem('mInv',   canInv);
  toggleItem('mGruas', canGruas);
  toggleItem('mOtros', canOtros);
  toggleItem('mTV',    canTV);

  const canExport = (g==="admin"||g==="gerente");
  ['btnExportIncidCSV','btnExportIncidPDF','btnExportKPICSV','btnExportKPIPDF','btnExportInvCSV']
    .forEach(id=> byId(id)?.classList.toggle('hidden',!canExport));

  if (byId('btnAddOT')) byId('btnAddOT').disabled = !canOT;
}
function toggleItem(id, show){ const el=byId(id); if(el) el.classList.toggle('hidden', !show); }

/* ===== API helpers ===== */
async function apiGet(q){
  const r = await fetch(API_BASE + "?" + new URLSearchParams(q));
  return r.json();
}
async function apiPost(o){
  const r = await fetch(API_BASE, {
    method: 'POST',
    headers: { 'Content-Type':'text/plain;charset=utf-8' }, // Apps Script
    body: JSON.stringify(o)
  });
  return r.json();
}

/* ===== Menús ===== */
const userBtn = byId('userBtn'), pagesBtn = byId('pagesBtn');
const userPanel = byId('userPanel'), pagesPanel = byId('pagesPanel');

userBtn.addEventListener('click', (e)=>{ e.stopPropagation(); userPanel.classList.toggle('hidden'); pagesPanel.classList.add('hidden'); });
pagesBtn.addEventListener('click', (e)=>{ e.stopPropagation(); pagesPanel.classList.toggle('hidden'); userPanel.classList.add('hidden'); });
document.addEventListener('click', (e)=>{
  if(!userPanel.contains(e.target) && e.target!==userBtn) userPanel.classList.add('hidden');
  if(!pagesPanel.contains(e.target) && e.target!==pagesBtn) pagesPanel.classList.add('hidden');
});

/* ===== NAV ===== */
let CURRENT_PAGE='equipos';
function nav(id){
  CURRENT_PAGE=id;
  pagesPanel.classList.add('hidden'); userPanel.classList.add('hidden');
  for(const s of ["equipos","gruas","otros","incidencias","indicadores","ot","inventario","tv","equipo","repuesto"])
    byId('page-'+s).classList.add('hidden');
  byId('page-'+id).classList.remove('hidden');
  if(id==="equipos") loadState();
  if(id==="gruas") renderSubGroup("Puentes Grúa","gruasWrap");
  if(id==="otros") renderSubGroup("Otros (auxiliares)","otrosWrap");
  if(id==="incidencias"){ loadIncid(); }
  if(id==="indicadores"){ calcKPIs(); buildKpiTables(); }
  if(id==="ot"){ loadOT(); }
  if(id==="inventario"){ loadInv(); }
  if(id==="tv"){ loadTV(); }
  window.scrollTo({top:0,behavior:"smooth"});
}

/* ===== EQUIPOS ===== */
let STATE=[];
function statusClass(s){return s==="Parada"?"p-stop":(s==="Restricciones"?"p-warn":"p-ok");}

async function loadState(){
  try{
    const j=await apiGet({res:'state',fn:'list'});
    if(j.ok&&j.items.length){STATE=j.items;renderState();return;}
    await apiPost({res:'state',fn:'seed'});
    const k=await apiGet({res:'state',fn:'list'}); STATE=(k.ok?k.items:[]);
    renderState();
  }catch(e){console.error(e)}
}
function renderState(){
  const by={}; STATE.forEach(it=>{(by[it.grupo] ||= []).push(it);});
  const wrap=byId('equiposWrap'); wrap.innerHTML="";
  for(const [g,items] of Object.entries(by)){
    if(g.startsWith("Puentes Grúa")||g==="Otros (auxiliares)") continue;
    const group=document.createElement('div'); group.className='group'; group.innerHTML=`<h2>${g}</h2>`;
    items.forEach(eq=>group.appendChild(cardEquipo(eq)));
    wrap.appendChild(group);
  }
  if(!byId('page-gruas').classList.contains('hidden')) renderSubGroup("Puentes Grúa","gruasWrap");
  if(!byId('page-otros').classList.contains('hidden')) renderSubGroup("Otros (auxiliares)","otrosWrap");
}
function renderSubGroup(match,target){
  const wrap=byId(target); wrap.innerHTML="";
  const items=STATE.filter(x=> match==="Otros (auxiliares)"?x.grupo===match:x.grupo.startsWith(match));
  const by={}; items.forEach(it=>{(by[it.grupo] ||= []).push(it);});
  for(const [g,arr] of Object.entries(by)){
    const group=document.createElement('div'); group.className='group'; group.innerHTML=`<h2>${g}</h2>`;
    arr.forEach(eq=>group.appendChild(cardEquipo(eq))); wrap.appendChild(group);
  }
}

/* Tarjeta de equipo – bloque 12 */
function cardEquipo(eq){
  const canIncButtons = (currentUser.group!=="guest");
  const safeName = eq.nombre.replace(/'/g,"\\'");
  const el=document.createElement('div'); el.className='card';
  el.innerHTML=`
    <div class="left" style="display:flex;align-items:center;gap:.75rem">
      <span class="pilot ${statusClass(eq.estado)}"></span>
      <div>
        <div class="name link" onclick="openEquipoByName('${safeName}')">${esc(eq.nombre)}</div>
        <div class="sub">${esc(eq.grupo)}</div>
      </div>
    </div>
    <div class="right">
      <button class="btn-chip btn-ok"   onclick="setEstado('${safeName}','En marcha')">En marcha</button>
      <button class="btn-chip btn-warn" onclick="estadoConIncid('${safeName}','Restricciones')">Restricciones</button>
      <button class="btn-chip btn-stop" onclick="estadoConIncid('${safeName}','Parada')">Parada</button>
      <button class="btn btn-ghost-strong btn-mini" onclick="estadoConIncid('${safeName}','Parada','programada')">Parada programada</button>
      ${canIncButtons ? `<button class="btn btn-mini btn-mail" title="Parada prolongada (aviso correo)" onclick="accionParadaProlongada('${safeName}')">Parada prolongada</button>`:''}
      <button class="btn btn-ghost btn-mini" onclick="openFicha('${safeName}')">Ficha</button>
      <button class="btn btn-ghost btn-mini" onclick="estadoConIncid('${safeName}','Nueva')">Nueva incidencia</button>
    </div>`;
  return el;
}
async function setEstado(name,estado){
  if(currentUser.group==="guest"){ alert("Inicia sesión para modificar estados."); return; }
  await apiPost({res:'state',fn:'set',name,estado,actor:currentUser.user});
  const it=STATE.find(x=>x.nombre===name); if(it) it.estado=estado;
  renderState();
}
function estadoConIncid(name, estado, modo){
  if(estado!=="Nueva"){ // cambia estado salvo "Nueva incidencia"
    setEstado(name, estado==='Parada' && modo==='programada' ? 'Parada' : estado);
  }
  // Abrir incidencias con formulario pre-rellenado
  nav('incidencias');
  setTimeout(()=>{
    byId('iEquipo').value = name;
    byId('iTipo').value   = (modo==='programada') ? 'Preventivo' : 'Correctivo';
    byId('iRes').value    = estado==='Restricciones' ? 'Con restricciones' : 'Parada';
    if(estado==='Nueva'){ byId('iRes').value='Solucionado'; byId('iTipo').value='Correctivo'; }
    byId('iDesc').focus();
  },120);
}
async function accionParadaProlongada(name){
  if(currentUser.group==="guest"){ alert("Inicia sesión para marcar paradas."); return; }
  await apiPost({res:'alert',fn:'parada',equipo:name,actor:currentUser.user});
  await loadState();
}
function openFicha(name){
  openEquipoByName(name);
  const inc=INCIDS_ALL.filter(x=>x.equipo===name).sort((a,b)=>new Date(b.created)-new Date(a.created));
  if(inc[0]){ const i=inc[0]; setTimeout(()=>toast(`Última: ${i.tipo} · ${i.res} · ${fmtDate(i.created)}`), 150); }
}

/* ===== INCIDENCIAS ===== */
let INCIDS_ALL=[];
let INCID_PAGE = 1;
let INCID_PAGE_SIZE = 10;
let _INCID_LAST_Q = "";
let INCID_SORT_KEY = 'fecha';
let INCID_SORT_DIR = 'desc';

function uniqSorted(arr){ return [...new Set(arr)].sort((a,b)=> String(a).localeCompare(String(b),'es')); }
function resetIncidFilters(){
  byId('fEquipo').value = ""; byId('fTipo').value = ""; byId('fRes').value = ""; byId('filtroIncid').value = ""; renderIncidTable();
}
function buildIncidFilters(){
  const equipos = uniqSorted(INCIDS_ALL.map(x=>x.equipo).filter(Boolean));
  const tipos   = uniqSorted(INCIDS_ALL.map(x=>x.tipo).filter(Boolean));
  const resul   = uniqSorted(INCIDS_ALL.map(x=>x.res).filter(Boolean));
  if(byId('fEquipo')) byId('fEquipo').innerHTML = `<option value="">Equipo: todos</option>` + equipos.map(n=>`<option value="${esc(n)}">${esc(n)}</option>`).join('');
  if(byId('fTipo'))   byId('fTipo').innerHTML   = `<option value="">Tipo: todos</option>` + [...new Set(["Correctivo","Preventivo","Predictivo","Mejora",...tipos])].map(n=>`<option value="${esc(n)}">${esc(n)}</option>`).join('');
  if(byId('fRes'))    byId('fRes').innerHTML    = `<option value="">Resultado: todos</option>` + [...new Set(["Solucionado","Con restricciones","Parada",...resul])].map(n=>`<option value="${esc(n)}">${esc(n)}</option>`).join('');
}
function setIncidPage(n){ INCID_PAGE = Math.max(1, n); renderIncidTable(); }
function setIncidPageSize(n){ INCID_PAGE_SIZE = Number(n) || 10; INCID_PAGE = 1; renderIncidTable(); }
function pagerControls(total, page, size){
  const pages = Math.max(1, Math.ceil(total / size));
  const start = (page-1)*size + 1;
  const end   = Math.min(total, page*size);
  let from = Math.max(1, page-2), to = Math.min(pages, from+4); from = Math.max(1, to-4);
  const nums = []; for(let i=from;i<=to;i++){ nums.push(`<button class="page-btn ${i===page?'active':''}" onclick="setIncidPage(${i})">${i}</button>`); }
  return `<div class="pager"><div class="info">Mostrando ${total?start:0}–${end} de ${total}</div>
    <label>Filas <select class="page-size" onchange="setIncidPageSize(this.value)"><option ${size===10?'selected':''}>10</option><option ${size===25?'selected':''}>25</option><option ${size===50?'selected':''}>50</option></select></label>
    <button class="page-btn" onclick="setIncidPage(${page-1})" ${page<=1?'disabled':''}>‹</button>${nums.join('')}
    <button class="page-btn" onclick="setIncidPage(${page+1})" ${page>=pages?'disabled':''}>›</button></div>`;
}
function badgeTipo(t){
  const k = (t||'').toLowerCase();
  if(k.startsWith('corre')) return `<span class="tag tag-corr">Correctivo</span>`;
  if(k.startsWith('preven')) return `<span class="tag tag-prev">Preventivo</span>`;
  if(k.startsWith('pred'))   return `<span class="tag tag-pred">Predictivo</span>`;
  if(k.startsWith('mej'))    return `<span class="tag tag-mej">Mejora</span>`;
  return `<span class="tag">${esc(t||'')}</span>`;
}
function badgeRes(r){
  const k = (r||'').toLowerCase();
  if(k.startsWith('solu')) return `<span class="tag tag-sol">Solucionado</span>`;
  if(k.includes('restr'))  return `<span class="tag tag-rest">Restricciones</span>`;
  if(k.startsWith('para')) return `<span class="tag tag-par">Parada</span>`;
  return `<span class="tag">${esc(r||'')}</span>`;
}
function setIncidSort(key){
  if(INCID_SORT_KEY === key){ INCID_SORT_DIR = (INCID_SORT_DIR === 'asc' ? 'desc' : 'asc'); }
  else { INCID_SORT_KEY = key; INCID_SORT_DIR = (key === 'fecha' ? 'desc' : 'asc'); }
  renderIncidTable();
}
async function loadIncid(){
  const st=await apiGet({res:'state',fn:'list'}); STATE=st.ok?st.items:[];
  const inc=await apiGet({res:'incid',fn:'list'}); INCIDS_ALL=inc.ok?inc.items:[];
  byId('iEquipo').innerHTML=STATE.map(x=>`<option>${esc(x.nombre)}</option>`).join('');
  buildIncidFilters();
  if(!byId('filtroIncid').dataset.bound){ byId('filtroIncid').addEventListener('input',renderIncidTable); byId('filtroIncid').dataset.bound='1'; }
  ['fEquipo','fTipo','fRes'].forEach(id=>{ if(!byId(id).dataset.bound){ byId(id).addEventListener('change',renderIncidTable); byId(id).dataset.bound='1'; }});
  renderIncidTable();
}
function renderIncidTable(){
  const q = (byId('filtroIncid')?.value || "").toLowerCase();
  const fEq  = byId('fEquipo')?.value || "";
  const fTip = byId('fTipo')?.value || "";
  const fRes = byId('fRes')?.value || "";
  const key = JSON.stringify({q,fEq,fTip,fRes});
  if(key !== _INCID_LAST_Q){ INCID_PAGE = 1; _INCID_LAST_Q = key; }
  let filtered = INCIDS_ALL.filter(x=>{
    const txt = JSON.stringify(x).toLowerCase().includes(q);
    const eqOk  = !fEq  || (x.equipo === fEq);
    const tipOk = !fTip || (String(x.tipo||"").toLowerCase().startsWith(fTip.toLowerCase()));
    const resOk = !fRes || (String(x.res||"").toLowerCase().startsWith(fRes.toLowerCase()));
    return txt && eqOk && tipOk && resOk;
  });
  const dir = (INCID_SORT_DIR === 'asc' ? 1 : -1);
  filtered.sort((a,b)=>{
    let A,B;
    switch(INCID_SORT_KEY){
      case 'fecha': A=new Date(a.created).getTime(); B=new Date(b.created).getTime(); break;
      case 'equipo': A=String(a.equipo||''); B=String(b.equipo||''); break;
      case 'tipo': A=String(a.tipo||''); B=String(b.tipo||''); break;
      case 'res': A=String(a.res||''); B=String(b.res||''); break;
      case 'hParo': A=+a.hParo||0; B=+b.hParo||0; break;
      case 'hRep': A=+a.hRep||0; B=+b.hRep||0; break;
      default: A=0; B=0;
    }
    if(typeof A==='string'&&typeof B==='string'){ return A.localeCompare(B,'es')*dir; }
    return (A===B?0:(A>B?1:-1))*dir;
  });
  const total = filtered.length;
  const pages = Math.max(1, Math.ceil(total / INCID_PAGE_SIZE));
  const page  = Math.min(INCID_PAGE, pages);
  const startIndex = (page-1)*INCID_PAGE_SIZE;
  const pageItems  = filtered.slice(startIndex, startIndex + INCID_PAGE_SIZE);
  const rows = pageItems.map(x=>{
    const desc = String(x.desc || '');
    const preview = (desc && desc.length>60) ? desc.slice(0,57)+'…' : (desc || 'Ver descripción');
    return `<tr>
      <td class="nowrap">${fmtDate(x.created)}</td>
      <td><span class="rolechip" style="position:static;font-size:.78rem">${esc(x.equipo)}</span></td>
      <td>${badgeTipo(x.tipo)}</td>
      <td>${badgeRes(x.res)}</td>
      <td><details class="desc"><summary>${esc(preview)}</summary><div class="full">${esc(desc)}</div></details></td>
      <td class="num">${fmt(x.hParo)}</td>
      <td class="num">${fmt(x.hRep)}</td>
    </tr>`;
  }).join('');
  const thBtn = (label, key) => {
    const active = (INCID_SORT_KEY === key);
    const dirCls = active ? (INCID_SORT_DIR === 'asc' ? 'asc' : 'desc') : '';
    return `<button class="th-sort ${dirCls}" onclick="setIncidSort('${key}')">${label}<span class="th-caret"></span></button>`;
  };
  byId('incidTableWrap').innerHTML = `<table>
    <thead><tr>
      <th>${thBtn('Fecha','fecha')}</th>
      <th>${thBtn('Equipo','equipo')}</th>
      <th>${thBtn('Tipo','tipo')}</th>
      <th>${thBtn('Resultado','res')}</th>
      <th>Descripción</th>
      <th>${thBtn('Horas parada','hParo')}</th>
      <th>${thBtn('Reparación','hRep')}</th>
    </tr></thead><tbody>${rows}</tbody></table>${pagerControls(total, page, INCID_PAGE_SIZE)}`;
}

/* ===== Validaciones / UX ===== */
function msgElFor(input){
  let next = input.nextElementSibling;
  if(!next || !next.classList || !next.classList.contains('field-msg')){
    next = document.createElement('div'); next.className = 'field-msg'; input.insertAdjacentElement('afterend', next);
  }
  return next;
}
function setInvalid(id, msg){ const el = byId(id); if(!el) return false; el.classList.add('field-invalid'); msgElFor(el).textContent = msg || 'Campo obligatorio'; return false; }
function clearInvalid(id){ const el = byId(id); if(!el) return; el.classList.remove('field-invalid'); const m = el.nextElementSibling; if(m?.classList?.contains('field-msg')) m.textContent=''; }
function toast(txt, ms=2200){ const t=document.createElement('div'); t.className='toast'; t.textContent=txt; document.body.appendChild(t); setTimeout(()=>{ t.style.opacity='0'; t.style.transition='opacity .3s'; }, ms); setTimeout(()=> t.remove(), ms+320); }
function bindCounter(inputId, max=300){
  const el = byId(inputId); if(!el) return;
  const lab = document.createElement('span'); lab.className='counter'; lab.textContent = `0/${max}`; el.insertAdjacentElement('afterend', lab);
  const update = ()=>{const n=(el.value||'').length; lab.textContent=`${n}/${max}`; lab.classList.toggle('warn', n > max*0.9);};
  el.addEventListener('input', update); update();
}
function initDateTimeDefaults(inputId, isDateOnly=false){
  const el = byId(inputId); if(!el) return;
  const now = new Date();
  if(isDateOnly){
    const yyyy=now.getFullYear(), mm=String(now.getMonth()+1).padStart(2,'0'), dd=String(now.getDate()).padStart(2,'0');
    const today = `${yyyy}-${mm}-${dd}`; if(!el.value) el.value = today; el.min = today;
  }else{
    const pad=n=>String(n).padStart(2,'0');
    const iso = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;
    if(!el.value) el.value = iso; el.min = iso;
  }
}

/* Alta incidencia */
async function addIncid(){
  if(currentUser.group==="guest"){ alert("Inicia sesión para registrar incidencias."); return; }
  ['iEquipo','iTipo','iRes','iDesc','iInicio','iReport'].forEach(clearInvalid);
  let ok = true;
  if(!val('iEquipo')) ok = setInvalid('iEquipo','Selecciona un equipo');
  if(!val('iTipo'))   ok = setInvalid('iTipo','Elige un tipo');
  if(!val('iRes'))    ok = setInvalid('iRes','Indica el resultado');
  const desc = (val('iDesc')||'').trim();
  if(!desc)           ok = setInvalid('iDesc','Añade una breve descripción');
  if(desc.length>600) ok = setInvalid('iDesc','Máximo 600 caracteres');
  if(!val('iInicio')) ok = setInvalid('iInicio','Fecha/hora de inicio requerida');
  if(!ok){ return; }
  const item={
    equipo:val('iEquipo'),tipo:val('iTipo'),res:val('iRes'),rep:val('iRep'),repTxt:val('iRepTxt'),
    hParo:+val('iHParo')||0,hRep:+val('iHRep')||0,inicio:val('iInicio')||new Date().toISOString(), fin:val('iFin')||'',
    reportante:val('iReport')||currentUser.user,asignado:val('iAsignado')||'',adj:'', desc
  };
  await apiPost({res:'incid',fn:'add',item,actor:currentUser.user});
  toast('Incidencia registrada');
  byId('iDesc').value=''; byId('iHParo').value='0'; byId('iHRep').value='0'; initDateTimeDefaults('iInicio', false);
  await loadIncid(); await loadState();
}

/* ===== INDICADORES ===== */
function calcKPIs(){
  const mttr = kpiMTTR(INCIDS_ALL);
  const mtbf = kpiMTBF(INCIDS_ALL);
  const disp = kpiDisp(INCIDS_ALL);
  const oee  = kpiOEE(disp);
  setTxt('kpiMttrG',fmt(mttr)); setTxt('kpiMbfG',fmt(mtbf)); setTxt('kpiDispG',fmt(disp*100)); setTxt('kpiOeeG',fmt(oee*100));
  const weeks = groupByWeek(INCIDS_ALL); const labels=Object.keys(weeks).sort(); const data=labels.map(k=>kpiMTTR(weeks[k])); drawBars('kpiChart',labels,data,'MTTR semanal (h)');
}
function groupByWeek(arr){const g={}; for(const x of arr){ const d=new Date(x.created); const w=`${d.getFullYear()}-W${weeknum(d)}`; (g[w] ||= []).push(x);} return g;}
function weeknum(d){const a=new Date(Date.UTC(d.getFullYear(),0,1)); const n=Math.floor((d-a)/86400000)+a.getUTCDay(); return Math.floor(n/7)+1;}
function kpiMTTR(list){const s=list.reduce((p,x)=>p+(+x.hRep||0),0); const n=list.length||1; return s/n;}
function kpiMTBF(list){const horas=4*30*24; const fallas=list.length||1; return horas/fallas;}
function kpiDisp(list){const prodH=120; const perd=list.reduce((p,x)=>p+(+x.hParo||0),0); return Math.max(0,(prodH-perd)/prodH);}
function kpiOEE(disp){return disp*.9*.98;}
let _chart=null; function drawBars(id,lab,val,title){const ctx=byId(id).getContext('2d'); if(_chart){_chart.destroy();} _chart=new Chart(ctx,{type:'bar',data:{labels:lab,datasets:[{label:title,data:val}]}});}

/* Tablas históricas por KPI */
function buildKpiTables(){
  const weeks = groupByWeek(INCIDS_ALL);
  const labels = Object.keys(weeks).sort();
  byId('tblMttr').innerHTML = buildTableHtml(labels.map(w=>[w, fmt(kpiMTTR(weeks[w]))]), ['Semana','MTTR (h)']);
  byId('tblMtbf').innerHTML = buildTableHtml(labels.map(w=>[w, fmt(kpiMTBF(weeks[w]))]), ['Semana','MTBF (h)']);
  byId('tblDisp').innerHTML = buildTableHtml(labels.map(w=>[w, fmt(kpiDisp(weeks[w])*100)]), ['Semana','Disponibilidad (%)']);
  byId('tblOee').innerHTML  = buildTableHtml(labels.map(w=>[w, fmt(kpiOEE(kpiDisp(weeks[w]))*100)]),  ['Semana','OEE estimado (%)']);
}

/* ===== OT ===== */
let OTS=[];
let OT_PAGE = 1, OT_PAGE_SIZE = 10, OT_SORT_KEY='fecha', OT_SORT_DIR='desc';

async function loadOT(){
  const st=await apiGet({res:'state',fn:'list'}); STATE=st.ok?st.items:[];
  const ot=await apiGet({res:'ot',fn:'list'}); OTS=ot.ok?ot.items:[];
  byId('otEquipo').innerHTML=STATE.map(x=>`<option>${esc(x.nombre)}</option>`).join('');
  bindCounter('otDesc', 800); initDateTimeDefaults('otDue', true);
  renderOT();
}
function setOTSort(key){ if(OT_SORT_KEY===key){ OT_SORT_DIR = (OT_SORT_DIR==='asc'?'desc':'asc'); } else { OT_SORT_KEY=key; OT_SORT_DIR = (key==='fecha'?'desc':'asc'); } renderOT(); }
function renderOT(){
  let arr = [...OTS]; const dir = (OT_SORT_DIR==='asc'?1:-1);
  arr.sort((a,b)=>{ let A,B; switch(OT_SORT_KEY){
      case 'fecha':A=new Date(a.created).getTime();B=new Date(b.created).getTime();break;
      case 'titulo':A=a.titulo||'';B=b.titulo||'';break;
      case 'prioridad':A=a.prioridad||'';B=b.prioridad||'';break;
      case 'asignado':A=a.asignado||'';B=b.asignado||'';break;
      case 'vence':A=a.vencimiento||'';B=b.vencimiento||'';break;
      case 'estado':A=a.estado||'';B=b.estado||'';break; default:A=0;B=0;}
    if(typeof A==='string'&&typeof B==='string'){ return A.localeCompare(B,'es')*dir; } return (A===B?0:(A>B?1:-1))*dir; });
  const total=arr.length; const pages=Math.max(1,Math.ceil(total/OT_PAGE_SIZE)); OT_PAGE=Math.min(OT_PAGE,pages);
  const start=(OT_PAGE-1)*OT_PAGE_SIZE; arr=arr.slice(start,start+OT_PAGE_SIZE);
  const rows=arr.map(o=>`<tr><td class="nowrap">${fmtDate(o.created)}</td><td><b>${esc(o.titulo||'')}</b><div class="sub">${esc(o.equipo)}</div></td><td>${priBadge(o.prioridad)}</td><td>${esc(o.asignado||'')}</td><td class="nowrap">${esc(o.vencimiento||'')}</td><td>${esc(o.estado||'')}</td></tr>`).join('');
  const thBtn=(label,key)=>{const act=(OT_SORT_KEY===key);const dirCls=act?(OT_SORT_DIR==='asc'?'asc':'desc'):'';return `<button class="th-sort ${dirCls}" onclick="setOTSort('${key}')">${label}<span class="th-caret"></span></button>`};
  byId('otTableWrap').innerHTML=`<table><thead><tr><th>${thBtn('Fecha','fecha')}</th><th>${thBtn('OT','titulo')}</th><th>${thBtn('Prioridad','prioridad')}</th><th>${thBtn('Asignado','asignado')}</th><th>${thBtn('Vence','vence')}</th><th>${thBtn('Estado','estado')}</th></tr></thead><tbody>${rows}</tbody></table>${pagerControls(total,OT_PAGE,OT_PAGE_SIZE)}`;
}
function priBadge(p){const c=p==="R"?"#dc2626":p==="N"?"#f59e0b":p==="A"?"#eab308":"#16a34a"; return `<span class="rolechip" style="position:static;background:${c};color:#fff;padding:.15rem .45rem;border-radius:999px">${p}</span>`}
async function addOT(){
  if(!(currentUser.group==="admin"||currentUser.group==="tco")){ alert("Tu rol no puede crear OT."); return; }
  ['otEquipo','otPri','otTitulo','otDue'].forEach(clearInvalid);
  let ok = true;
  if(!val('otEquipo')) ok = setInvalid('otEquipo','Selecciona un equipo');
  if(!val('otPri'))    ok = setInvalid('otPri','Elige prioridad');
  if(!val('otTitulo') || val('otTitulo').trim().length<3) ok = setInvalid('otTitulo','Título demasiado corto');
  if(!val('otDue'))    ok = setInvalid('otDue','Indica fecha de vencimiento');
  if(!ok){ return; }
  const item={equipo:val('otEquipo'),prioridad:val('otPri'),titulo:val('otTitulo').trim(),asignado:val('otAsign'),vencimiento:val('otDue'),adj:val('otAdj'),desc:(val('otDesc')||'').trim()};
  await apiPost({res:'ot',fn:'add',item,actor:currentUser.user}); toast('OT creada');
  byId('otTitulo').value=''; byId('otAsign').value=''; byId('otAdj').value=''; byId('otDesc').value=''; await loadOT();
}
function exportOTPDF(){ const g=currentUser.group; if(!(g==="admin"||g==="gerente"||g==="tco")) return alert("No permitido"); const win=window.open('','_blank'); const rows=OTS.map(o=>`<tr><td>${fmtDate(o.created)}</td><td>${esc(o.titulo)}</td><td>${esc(o.equipo)}</td><td>${o.prioridad}</td><td>${esc(o.asignado)}</td><td>${esc(o.vencimiento)}</td></tr>`).join(''); win.document.write(`<!doctype html><meta charset="utf-8"><title>OT</title><style>body{font-family:Inter,sans-serif;padding:16px}table{width:100%;border-collapse:collapse}td,th{border:1px solid #ddd;padding:8px}</style><h2>Órdenes de trabajo</h2><table><tr><th>Fecha</th><th>Título</th><th>Equipo</th><th>Prioridad</th><th>Asignado</th><th>Vence</th></tr>${rows}</table>`); win.document.close();}

/* ===== INVENTARIO ===== */
let INV=[];
let INV_PAGE=1, INV_PAGE_SIZE=10, INV_SORT_KEY='ref', INV_SORT_DIR='asc';

async function loadInv(){ const j=await apiGet({res:'inv',fn:'list'}); INV=j.ok?j.items:[]; renderInv(); }
function setInvSort(key){ if(INV_SORT_KEY===key){ INV_SORT_DIR = (INV_SORT_DIR==='asc'?'desc':'asc'); } else { INV_SORT_KEY=key; INV_SORT_DIR = 'asc'; } renderInv(); }
function renderInv(){
  const q=(byId('invSearch').value||"").toLowerCase();
  let arr=INV.filter(x=> (x.nombre+x.ref).toLowerCase().includes(q));
  const dir=(INV_SORT_DIR==='asc'?1:-1);
  arr.sort((a,b)=>{ let A,B; switch(INV_SORT_KEY){case 'ref':A=a.ref||'';B=b.ref||'';break;case 'nombre':A=a.nombre||'';B=b.nombre||'';break;case 'stock':A=+a.stock||0;B=+b.stock||0;break;case 'minimo':A=+a.minimo||0;B=+b.minimo||0;break;default:A=0;B=0;} if(typeof A==='string'&&typeof B==='string'){ return A.localeCompare(B,'es')*dir; } return (A===B?0:(A>B?1:-1))*dir; });
  const total=arr.length; const pages=Math.max(1,Math.ceil(total/INV_PAGE_SIZE)); INV_PAGE=Math.min(INV_PAGE,pages);
  const start=(INV_PAGE-1)*INV_PAGE_SIZE; arr=arr.slice(start,start+INV_PAGE_SIZE);
  const rows=arr.map(x=>{
    const low = (+x.stock||0) <= (+x.minimo||0);
    const refEsc = x.ref.replace(/'/g,"\\'");
    return `<tr class="${low?'row-low':''}">
      <td><b>${esc(x.ref)}</b>${low?` <span class="badge-low">Bajo mínimo</span>`:''}<div class="sub">${esc(x.nombre||'')}</div></td>
      <td class="num">${+x.stock||0}</td><td class="num">${+x.minimo||0}</td>
      <td>
        <button class="btn btn-ghost btn-mini" onclick="delta('${refEsc}',-1)">–1</button>
        <button class="btn btn-ghost btn-mini" onclick="delta('${refEsc}',+1)">+1</button>
        <button class="btn btn-ghost btn-mini" onclick="openRepuestoByRef('${refEsc}')">QR</button>
      </td></tr>`;
  }).join('');
  const thBtn=(label,key)=>{const act=(INV_SORT_KEY===key);const dirCls=act?(INV_SORT_DIR==='asc'?'asc':'desc'):'';return `<button class="th-sort ${dirCls}" onclick="setInvSort('${key}')">${label}<span class="th-caret"></span></button>`};
  byId('invTableWrap').innerHTML=`<table><thead><tr><th>${thBtn('Repuesto','ref')}</th><th>${thBtn('Stock','stock')}</th><th>${thBtn('Mínimo','minimo')}</th><th>Acciones</th></tr></thead><tbody>${rows}</tbody></table>${pagerControls(total,INV_PAGE,INV_PAGE_SIZE)}`;
}
async function addInv(){
  if(currentUser.group==="guest"){ alert("Inicia sesión para añadir repuestos."); return; }
  ['invNombre','invRef','invStock','invMin'].forEach(clearInvalid);
  const nombre = (val('invNombre')||'').trim();
  const ref    = (val('invRef')||'').trim().toUpperCase();
  const stock  = Number(val('invStock'));
  const minimo = Number(val('invMin'));
  let ok = true;
  if(!ref){ ok = setInvalid('invRef','Referencia requerida'); }
  if(ref && INV.some(x => String(x.ref).toUpperCase() === ref)){ ok = setInvalid('invRef','La referencia ya existe'); }
  if(!nombre){ ok = setInvalid('invNombre','Nombre requerido'); }
  if(!Number.isFinite(stock) || stock<0){ ok = setInvalid('invStock','Stock debe ser ≥ 0'); }
  if(!Number.isFinite(minimo) || minimo<0){ ok = setInvalid('invMin','Mínimo debe ser ≥ 0'); }
  if(!ok){ return; }
  const item={ nombre, ref, stock:Math.floor(stock), minimo:Math.floor(minimo) };
  await apiPost({res:'inv',fn:'add',item,actor:currentUser.user});
  toast('Repuesto añadido');
  byId('invNombre').value=''; byId('invRef').value=''; byId('invStock').value='';  byId('invMin').value='';
  await loadInv();
}
async function delta(ref,d){
  if(currentUser.group==="guest"){ alert("Inicia sesión para modificar stock."); return; }
  await apiPost({res:'inv',fn:'delta',ref,delta:(+d||0),actor:currentUser.user}); await loadInv();
}
function exportInvCSV(){ if(!canExport())return; const header=["Ref","Nombre","Stock","Minimo"]; const rows=INV.map(x=>[x.ref,x.nombre,x.stock,x.minimo]); downloadBlob(toCSV(rows,header),'text/csv;charset=utf-8;','inventario.csv'); }
function canExport(){ const g=currentUser.group; const ok=(g==="admin"||g==="gerente"); if(!ok) alert("Solo Gerente/Admin pueden exportar aquí."); return ok; }

/* ===== TV ===== */
let TV_TIMER=null;
async function loadTV(){
  const st=await apiGet({res:'state',fn:'list'}); STATE=st.ok?st.items:[];
  const inv=await apiGet({res:'inv',fn:'list'}); INV=inv.ok?inv.items:[];
  renderTV(); if(TV_TIMER) clearInterval(TV_TIMER); TV_TIMER=setInterval(()=>loadTV(),30000);
}
function renderTV(){
  const par=STATE.filter(x=>x.estado==='Parada');
  const res=STATE.filter(x=>x.estado==='Restricciones');
  const low=INV.filter(x=> +x.stock <= +x.minimo);
  byId('tvParados').innerHTML = par.length? par.map(x=>`<div class="tv-item stop">⛔ ${esc(x.nombre)}</div>`).join('') : `<div class="tv-item">Sin paradas</div>`;
  byId('tvRestr').innerHTML  = res.length? res.map(x=>`<div class="tv-item warn">⚠️ ${esc(x.nombre)}</div>`).join('') : `<div class="tv-item">Sin restricciones</div>`;
  byId('tvStock').innerHTML  = low.length? low.map(x=>`<div class="tv-item stock">📦 ${esc(x.ref)} — ${esc(x.nombre)} ( ${x.stock}/${x.minimo} )</div>`).join('') : `<div class="tv-item">Stock correcto</div>`;
}
function tvFull(){
  const sec=byId('page-tv'); const clone=sec.cloneNode(true); clone.classList.add('fullscreen'); document.body.appendChild(clone);
  const close= document.createElement('button'); close.textContent='Salir pantalla completa'; close.className='btn btn-ghost'; close.style.position='fixed'; close.style.top='10px'; close.style.right='10px'; close.onclick=()=>clone.remove(); clone.appendChild(close);
}

/* ==== Mostrar/ocultar contraseña – SVG ==== */
document.addEventListener('click', (e)=>{
  const bt = e.target.closest('.pw-toggle'); if(!bt) return;
  const id = bt.getAttribute('data-target'); const inp = document.getElementById(id); if(!inp) return;
  const isPwd = inp.type === 'password'; inp.type = isPwd ? 'text' : 'password'; bt.setAttribute('aria-pressed', isPwd ? 'true' : 'false');
});

/* ====== QR + Fichas individuales (equipos y repuestos) ====== */
function slugify(s){return String(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');}
function baseURL(){ return location.origin + location.pathname; }
function ensureSectionsHidden(){
  for(const s of ["equipos","gruas","otros","incidencias","indicadores","ot","inventario","tv","equipo","repuesto"])
    byId('page-'+s)?.classList.add('hidden');
}

function openEquipoByName(name){
  const slug = slugify(name);
  location.hash = `#/equipo/${slug}`;
  renderEquipoBySlug(slug);
}
function openRepuestoByRef(ref){
  const code = encodeURIComponent(String(ref||'').toUpperCase());
  location.hash = `#/repuesto/${code}`;
  renderRepuestoByRef(code);
}
function renderEquipoBySlug(slug){
  const eq = STATE.find(x=>slugify(x.nombre)===slug);
  ensureSectionsHidden(); const host = byId('page-equipo'); host.classList.remove('hidden');
  if(!eq){ byId('equipoDetail').innerHTML = `<div class="kpi">Equipo no encontrado.</div>`; return; }
  const inc = INCIDS_ALL.filter(i=>i.equipo===eq.nombre).sort((a,b)=>new Date(b.created)-new Date(a.created));
  const qrText = `${baseURL()}#/equipo/${slug}`;
  const htmlInc = inc.length? inc.map(i=>`<tr><td class="nowrap">${fmtDate(i.created)}</td><td>${esc(i.tipo||'')}</td><td>${esc(i.res||'')}</td><td>${esc(i.desc||'')}</td><td class="num">${fmt(i.hParo||0)}</td><td class="num">${fmt(i.hRep||0)}</td></tr>`).join('') : `<tr><td colspan="6">Sin incidencias registradas.</td></tr>`;
  byId('equipoDetail').innerHTML = `
    <div class="kpi">
      <div class="qr-card">
        <div class="qr-wrap">
          <div class="qr-box"><div id="eqQR"></div></div>
          <div>
            <h2 style="margin:.2rem 0">${esc(eq.nombre)}</h2>
            <div class="sub">${esc(eq.grupo)}</div>
            <div style="margin-top:.5rem"><code style="font-size:.85rem;color:#475569">${qrText}</code></div>
            <div style="margin-top:.6rem;display:flex;gap:.5rem;flex-wrap:wrap">
              <button class="btn btn-ghost" onclick="printQR('eqQR','${esc(eq.nombre)}')">Imprimir etiqueta</button>
              <button class="btn btn-ghost" onclick="nav('equipos')">Volver</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="kpi" style="margin-top:12px">
      <h3>Historial de incidencias — ${esc(eq.nombre)}</h3>
      <table><thead><tr><th>Fecha</th><th>Tipo</th><th>Resultado</th><th>Descripción</th><th>Parada</th><th>Reparación</th></tr></thead><tbody>${htmlInc}</tbody></table>
    </div>`;
  new QRCode(byId('eqQR'), {text: qrText, width:150, height:150, correctLevel: QRCode.CorrectLevel.M});
}
function renderRepuestoByRef(code){
  const ref = decodeURIComponent(code).toUpperCase();
  const it = INV.find(x=>String(x.ref).toUpperCase()===ref);
  ensureSectionsHidden(); const host = byId('page-repuesto'); host.classList.remove('hidden');
  if(!it){ byId('repuestoDetail').innerHTML = `<div class="kpi">Repuesto no encontrado.</div>`; return; }
  const qrText = `${baseURL()}#/repuesto/${encodeURIComponent(ref)}`;
  byId('repuestoDetail').innerHTML = `
    <div class="kpi">
      <div class="qr-card">
        <div class="qr-wrap">
          <div class="qr-box"><div id="repQR"></div></div>
          <div>
            <h2 style="margin:.2rem 0">${esc(it.nombre||'')}</h2>
            <div class="sub"><b>Ref:</b> ${esc(ref)} · <b>Stock:</b> ${+it.stock||0} · <b>Mínimo:</b> ${+it.minimo||0}</div>
            <div style="margin-top:.5rem"><code style="font-size:.85rem;color:#475569">${qrText}</code></div>
            <div style="margin-top:.6rem;display:flex;gap:.5rem;flex-wrap:wrap">
              <button class="btn btn-ghost" onclick="printQR('repQR','REP-${esc(ref)}')">Imprimir etiqueta</button>
              <button class="btn btn-ghost" onclick="nav('inventario')">Volver</button>
            </div>
          </div>
        </div>
      </div>
    </div>`;
  new QRCode(byId('repQR'), {text: qrText, width:150, height:150, correctLevel: QRCode.CorrectLevel.M});
}
function printQR(containerId, title){
  const node = byId(containerId);
  const img = node.querySelector('img') || node.querySelector('canvas');
  const src = img.tagName==='CANVAS' ? img.toDataURL('image/png') : img.src;
  const w = window.open('','_blank');
  w.document.write(`<!doctype html><meta charset="utf-8"><title>${esc(title)}</title>
    <style>body{font-family:Inter,sans-serif;text-align:center;padding:16px}</style>
    <h3>${esc(title)}</h3><img src="${src}" width="220" height="220"><div style="margin-top:8px">${location.origin}${location.pathname}</div>`);
  w.document.close(); w.focus(); w.print();
}
/* Router hash */
function handleHash(){
  const h = location.hash || '';
  const m1 = h.match(/^#\/equipo\/([a-z0-9\-]+)$/);
  const m2 = h.match(/^#\/repuesto\/(.+)$/);
  if(m1){ renderEquipoBySlug(m1[1]); return; }
  if(m2){ renderRepuestoByRef(m2[1]); return; }
  ensureSectionsHidden(); byId('page-'+CURRENT_PAGE).classList.remove('hidden');
}
window.addEventListener('hashchange', handleHash);

/* ===== Arranque ===== */
setUser(currentUser);
nav('equipos');   // Home
loadState();
bindCounter('iDesc', 600);
initDateTimeDefaults('iInicio', false);
['invNombre','invRef','invStock','invMin'].forEach(id=>{ const el = byId(id); if(el){ el.addEventListener('input', ()=> clearInvalid(id)); }});
</script>
</body>
</html>