<!doctype html><html lang="es"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><title>CDL · CMMS v31</title><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet"><style>:root{--brand1:#A60000;--brand2:#E43B3B;--bg:#F5F7FA;--card:#FFFFFF;--ok:#16a34a;--warn:#f59e0b;--stop:#dc2626;--muted:#5B6673;--ink:#0E1824;--line:#E6ECF1;--ring:0 10px 30px rgba(0,0,0,.08)}*{box-sizing:border-box}body{margin:0;background:var(--bg);font-family:Inter,system-ui,sans-serif;color:var(--ink)}header{position:sticky;top:0;z-index:60;background:#fff;border-bottom:3px solid #e8ecef}.nav{position:relative;display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:.5rem;padding:.55rem .85rem}.logoBlk{display:flex;align-items:center;gap:.6rem;min-width:0}.logoBlk img{height:52px;width:auto;object-fit:contain}.titleBlk{display:grid;justify-items:center}.titleBlk .cdl{font-size:1.6rem;font-weight:800;letter-spacing:.5px;color:#0f172a}.titleBlk .sub{font-weight:600;color:#64748b}.rolechip{justify-self:end;font-size:.72rem;font-weight:800;color:#475569;opacity:.9}.menu{position:relative}.mbtn{border:0;border-radius:14px;padding:.6rem .8rem;font-weight:800;cursor:pointer;background:#0f172a;color:#fff}.panel{position:absolute;left:0;top:120%;background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:var(--ring);min-width:240px;overflow:hidden;z-index:70}.panel .row{padding:.6rem}.menuCol{display:flex;flex-direction:column;gap:.5rem}.pill-black{display:inline-flex;align-items:center;justify-content:center;border-radius:999px;padding:.6rem .9rem;font-weight:800;background:#0b0f14;color:#fff;border:1px solid #151a20;box-shadow:inset 0 2px 0 rgba(255,255,255,.06),0 6px 16px rgba(0,0,0,.12)}.pill-black:active{transform:translateY(1px)}.container{max-width:980px;margin:0 auto;padding:12px}.kpi{background:var(--card);border-radius:18px;box-shadow:var(--ring);padding:1rem}.kpi h3{margin:.2rem 0 .8rem}table{width:100%;border-collapse:separate;border-spacing:0 8px}th,td{padding:.62rem .85rem;background:#fff;border-bottom:1px solid #F2F5F8}th{text-align:left;color:#4B5563;font-size:.9rem;background:#f8fafc}tr td:first-child,tr th:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px}tr td:last-child,tr th:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px}.group{margin:10px 0}.card{background:#fff;border:1px solid var(--line);border-radius:18px;box-shadow:var(--ring);padding:12px;margin:8px 0}.cardH{display:flex;align-items:center;gap:.6rem}.pilot{width:18px;height:18px;border-radius:50%;box-shadow:0 0 0 3px #fff,0 0 0 6px rgba(0,0,0,.06)}.p-ok{background:var(--ok)}.p-warn{background:var(--warn)}.p-stop{background:var(--stop)}.name{font-weight:800;font-size:1.05rem}.sub{color:var(--muted);font-size:.9rem}.qr-mini{width:18px;height:18px;display:inline-block;background:linear-gradient(90deg,#111,#333);mask:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="white" d="M3 3h8v8H3V3m2 2v4h4V5H5m8-2h8v8h-8V3m2 2v4h4V5h-4M3 13h8v8H3v-8m2 2v4h4v-4H5m12-2h2v2h2v2h-4v-4m-4 4h2v2h-2v-2m4 2h4v4h-4v-4"/></svg>') center/contain no-repeat;border-radius:2px;margin-left:6px;opacity:.9}.row2{display:flex;flex-wrap:wrap;gap:.5rem;margin-top:8px}.btnCap{position:relative;display:inline-flex;align-items:center;gap:.55rem;border-radius:999px;padding:.5rem .85rem;font-weight:800;background:#0b0f14;color:#fff;border:1px solid #1a1f27;box-shadow:inset 0 2px 0 rgba(255,255,255,.07),0 6px 16px rgba(0,0,0,.14)}.btnCap::before{content:"";width:14px;height:14px;border-radius:50%;background:#999;box-shadow:inset 0 2px 4px rgba(255,255,255,.25),0 0 0 2px rgba(0,0,0,.25)}.cap-ok::before{background:var(--ok)}.cap-warn::before{background:var(--warn)}.cap-stop::before{background:var(--stop)}.btnLite{background:#eef3fb;color:#0f3a7f;border:1px solid #ced8ee}.seg{position:relative;display:flex;gap:6px;background:#0b0f14;border:1px solid #151a20;border-radius:999px;padding:6px;box-shadow:inset 0 2px 0 rgba(255,255,255,.06),0 8px 18px rgba(0,0,0,.12)}.seg button{flex:1;min-width:92px;border-radius:999px;border:0;padding:.5rem .6rem;font-weight:800;color:#d1d5db;background:transparent;position:relative}.seg .knob{position:absolute;top:6px;bottom:6px;width:33.33%;left:6px;border-radius:999px;background:#111;box-shadow:inset 0 2px 0 rgba(255,255,255,.05),0 8px 18px rgba(0,0,0,.18);transition:left .2s}.seg[data-pos="1"] .knob{left:calc(6px + 33.33%)}.seg[data-pos="2"] .knob{left:calc(6px + 66.66%)}.seg .dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px}.seg .d-ok{background:var(--ok)}.seg .d-warn{background:var(--warn)}.seg .d-stop{background:var(--stop)}.toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:8px 0}.legend{display:flex;gap:12px;align-items:center;background:#fff;border:1px solid var(--line);border-radius:999px;padding:6px 10px;box-shadow:var(--ring)}.legend .l{display:inline-flex;align-items:center;gap:6px;font-weight:700}.legend .dot{width:12px;height:12px;border-radius:50%}.inv-grid{display:grid;gap:10px;grid-template-columns:1fr 1fr 1fr 1fr}@media(max-width:720px){.inv-grid{grid-template-columns:1fr 1fr}.titleBlk .cdl{font-size:1.35rem}.seg button{min-width:auto;font-size:.9rem}}.row-low{background:#FEF3C7!important}.badge-low{display:inline-flex;align-items:center;gap:.35rem;padding:.15rem .45rem;border-radius:999px;font-weight:700;background:#FFEDD5;color:#7C2D12;border:1px solid #FED7AA;font-size:.78rem;line-height:1}.page-controls{display:flex;gap:.6rem;align-items:center;flex-wrap:wrap}.alertBtn{background:#991b1b;color:#fff;border:0;border-radius:10px;padding:.4rem .55rem;font-weight:800}.alertBox{margin-top:8px;border:1px solid #fecaca;background:#fee2e2;border-radius:12px;padding:8px;display:none}.tv-wrap .topline{display:flex;gap:10px;align-items:center}.tag{display:inline-flex;align-items:center;gap:.35rem;padding:.18rem .5rem;border-radius:999px;font-weight:700;line-height:1;border:1px solid transparent;font-size:.82rem}.tag-corr{color:#991B1B;background:#FEE2E2;border-color:#FECACA}.tag-prev{color:#0C4A6E;background:#E0F2FE;border-color:#BAE6FD}.tag-pred{color:#6B21A8;background:#F3E8FF;border-color:#E9D5FF}.tag-mej{color:#065F46;background:#D1FAE5;border-color:#A7F3D0}.tag-sol{color:#065F46;background:#D1FAE5;border-color:#A7F3D0}.tag-rest{color:#7C2D12;background:#FFEDD5;border-color:#FED7AA}.tag-par{color:#7F1D1D;background:#FEE2E2;border-color:#FECACA}.nowrap{white-space:nowrap}.num{text-align:right;font-variant-numeric:tabular-nums}.hidden{display:none!important}footer{padding:2rem 1rem;color:#9aa7b4;text-align:center}</style></head><body><header><div class="nav"><div class="menu"><button id="pagesBtn" class="mbtn">☰</button><div id="pagesPanel" class="panel hidden"><div class="row"><div class="menuCol"><button class="pill-black" onclick="nav('equipos')">Equipos</button><button class="pill-black" onclick="nav('gruas')">Puentes Grúa</button><button class="pill-black" onclick="nav('otros')">Otros</button><button class="pill-black" onclick="nav('incidencias')">Incidencias</button><button class="pill-black" onclick="nav('indicadores')">Indicadores</button><button class="pill-black" onclick="nav('ot')">OT</button><button class="pill-black" onclick="nav('inventario')">Inventario</button><button class="pill-black" onclick="nav('tv')">Dashboard TV</button></div></div></div></div><div class="logoBlk"><img src="logo_mantenimiento.png" alt="Logo" onerror="this.src='logo_mantenimiento.PNG'"></div><div class="titleBlk"><div class="cdl">CDL</div><div class="sub">Panel de control</div></div><div class="menu"><span id="roleChip" class="rolechip">Invitado</span><button id="userBtn" class="mbtn">⋮</button><div id="userPanel" class="panel hidden"><div class="row"><label class="small">Usuario</label><select id="userSelect"><option value="invitado">Invitado</option><option value="admin">Administrador</option><option value="gerente">Gerente</option><option value="encargado">Encargado</option><option value="produccion">Producción</option><option value="rt11">RT1.1</option><option value="rt12">RT1.2</option><option value="rt21">RT2.1</option><option value="rt22">RT2.2</option><option value="rt31">RT3.1</option><option value="rt32">RT3.2</option><option value="tcoint">Tco.INT</option><option value="subc">Subcontrata</option></select><div class="pw"><input id="userPass" type="password" placeholder="••••••••"></div><div class="page-controls" style="margin-top:.4rem"><button class="pill-black" onclick="login()">Entrar</button><button class="pill-black" onclick="logout()">Salir</button></div></div><div class="row"><label class="small">Cambiar contraseña</label><input id="oldPass" type="password" placeholder="Contraseña actual" style="width:100%;margin:.3rem 0"><input id="newPass" type="password" placeholder="Nueva contraseña" style="width:100%"><div class="page-controls" style="margin-top:.4rem"><button class="pill-black" onclick="changePwd()">Cambiar</button><span id="pwdMsg" class="small" style="color:#64748b"></span></div></div></div></div></div></header><main class="container"><section id="page-equipos"><div class="toolbar"><div class="legend"><span class="l"><span class="dot" style="background:var(--ok)"></span>En marcha</span><span class="l"><span class="dot" style="background:var(--warn)"></span>Restricciones</span><span class="l"><span class="dot" style="background:var(--stop)"></span>Parada</span></div></div><div id="equiposWrap"></div></section><section id="page-gruas" class="hidden"><h2>Puentes Grúa</h2><div id="gruasWrap"></div></section><section id="page-otros" class="hidden"><h2>Otros (auxiliares)</h2><div id="otrosWrap"></div></section><section id="page-incidencias" class="hidden"><div class="kpi"><h3>Registrar nueva incidencia</h3><div class="inv-grid"><label>Equipo<select id="iEquipo"></select></label><label>Tipo<select id="iTipo"><option>Correctivo</option><option>Preventivo</option><option>Predictivo</option><option>Mejora</option></select></label><label>Resultado<select id="iRes"><option>Solucionado</option><option>Con restricciones</option><option>Parada</option></select></label><label>¿Repuesto?<select id="iRep"><option>No</option><option>Sí</option></select></label><label>Repuesto (txt)<input id="iRepTxt" placeholder="p.ej. THM6-20"></label><label>Horas de parada<input id="iHParo" type="number" value="0"></label><label>Horas de reparación<input id="iHRep" type="number" value="0"></label><label>Fecha inicio<input id="iInicio" type="datetime-local"></label><label>Fecha fin<input id="iFin" type="datetime-local"></label><label>Reportante<input id="iReport" placeholder="Nombre"></label><label>Intervenido por<input id="iAsignado" placeholder="Nombre técnico"></label><label style="grid-column:1/-1">Descripción<textarea id="iDesc" rows="3" placeholder="Breve descripción obligatoria"></textarea></label></div><div class="page-controls" style="margin-top:.5rem"><button class="btnCap cap-ok" onclick="addIncid()">Añadir incidencia</button><button class="btnLite" onclick="exportIncidCSV()" id="btnExportIncidCSV">Exportar CSV</button><button class="btnLite" onclick="exportIncidPDF()" id="btnExportIncidPDF">Exportar PDF</button></div></div><div class="kpi" style="margin-top:10px"><div class="page-controls"><strong>Historial</strong><input id="filtroIncid" placeholder="Buscar…"><select id="fEquipo"><option value="">Equipo: todos</option></select><select id="fTipo"><option value="">Tipo: todos</option></select><select id="fRes"><option value="">Resultado: todos</option></select><button class="btnLite" onclick="resetIncidFilters()">Limpiar</button></div><div class="page-controls" style="margin:.4rem 0"><span>Mostrar:</span><label><input type="checkbox" id="colFecha" onchange="toggleIncidCols()" checked> Fecha</label><label><input type="checkbox" id="colEquipo" onchange="toggleIncidCols()" checked> Equipo</label><label><input type="checkbox" id="colTipo" onchange="toggleIncidCols()"> Tipo</label><label><input type="checkbox" id="colRes" onchange="toggleIncidCols()"> Resultado</label><label><input type="checkbox" id="colParo" onchange="toggleIncidCols()"> H. parada</label><label><input type="checkbox" id="colRep" onchange="toggleIncidCols()"> Reparación</label></div><div id="incidTableWrap"></div></div></section><section id="page-indicadores" class="hidden"><div class="kpi"><h3>KPIs globales</h3><table><tr><th>KPI</th><th>Valor</th><th>Definición</th></tr><tr><td>MTTR (h)</td><td id="kpiMttrG">0</td><td>Tiempo medio de reparación.</td></tr><tr><td>MTBF (h)</td><td id="kpiMbfG">0</td><td>Tiempo medio entre fallos.</td></tr><tr><td>Disponibilidad (%)</td><td id="kpiDispG">0</td><td>Tiempo disponible/planificado.</td></tr><tr><td>OEE estimado (%)</td><td id="kpiOeeG">0</td><td>Calidad × Rend. × Disp.</td></tr></table><div class="page-controls" style="margin-top:.5rem"><button class="btnLite" onclick="exportKPIsCSV()" id="btnExportKPICSV">Descargar KPIs (CSV)</button><button class="btnLite" onclick="exportKPIsPDF()" id="btnExportKPIPDF">Descargar KPIs (PDF)</button></div></div><div class="kpi" style="margin-top:10px"><h3>MTTR semanal</h3><canvas id="kpiChartMttr" height="140"></canvas></div><div class="kpi" style="margin-top:10px"><h3>MTBF semanal</h3><canvas id="kpiChartMtbf" height="140"></canvas></div><div class="kpi" style="margin-top:10px"><h3>Disponibilidad semanal</h3><canvas id="kpiChartDisp" height="140"></canvas></div><div class="kpi" style="margin-top:10px"><h3>OEE estimado semanal</h3><canvas id="kpiChartOee" height="140"></canvas></div></section><section id="page-ot" class="hidden"><div class="kpi"><h3>Nueva OT</h3><div class="inv-grid"><label>Equipo<select id="otEquipo"></select></label><label>Prioridad<select id="otPri"><option value="R">Rojo (Urgente)</option><option value="N">Naranja (Alta)</option><option value="A">Amarillo (Preventivo)</option><option value="V">Verde (Predictivo)</option></select></label><label>Título<input id="otTitulo" placeholder="Breve título"></label><label>Asignado<input id="otAsign" placeholder="Nombre técnico"></label><label>Vencimiento<input id="otDue" type="date"></label><label>Adjunto (URL)<input id="otAdj" placeholder="https://…"></label><label style="grid-column:1/-1">Descripción<textarea id="otDesc" rows="3"></textarea></label></div><div class="page-controls" style="margin-top:.5rem"><button id="btnAddOT" class="btnCap cap-ok" onclick="addOT()">Crear OT</button><button class="btnLite" onclick="exportOTPDF()">Exportar listado (PDF)</button></div></div><div class="kpi" style="margin-top:10px"><h3>Listado OT</h3><div id="otTableWrap"></div></div></section><section id="page-inventario" class="hidden"><div class="kpi"><h3>Inventario de repuestos</h3><div class="page-controls"><input id="invSearch" placeholder="Buscar ref/nombre…" oninput="renderInv()"><button class="btnLite" onclick="exportInvCSV()" id="btnExportInvCSV">Exportar CSV</button><button class="alertBtn" id="btnAlerts" onclick="toggleAlerts()">Alertas</button></div><div id="alertsBox" class="alertBox"></div><div class="inv-grid" style="margin-top:8px"><input id="invNombre" placeholder="Nombre repuesto"><input id="invRef" placeholder="Referencia"><input id="invStock" type="number" placeholder="Stock"><input id="invMin" type="number" placeholder="Mínimo"></div><div style="margin-top:.6rem"><button class="btnCap cap-ok" onclick="addInv()">Añadir</button></div><div id="invTableWrap" style="margin-top:12px"></div></div></section><section id="page-tv" class="hidden"><div class="kpi tv-wrap"><div class="topline"><h3 style="margin:0">Dashboard TV</h3><span class="legend" style="margin-left:auto">Actualiza cada <b>10 s</b></span></div><div class="page-controls" style="margin:.5rem 0"><span class="legend"><span class="l"><span class="dot" style="background:var(--stop)"></span>Parados</span><span class="l"><span class="dot" style="background:var(--warn)"></span>Restricciones</span><span class="l"><span class="dot" style="background:#0ea5e9"></span>Bajo mínimo</span></span></div><div class="inv-grid" style="grid-template-columns:1fr 1fr 1fr"><div class="kpi"><h3 style="margin-top:0">Equipos PARADOS</h3><div id="tvParados"></div></div><div class="kpi"><h3 style="margin-top:0">Equipos con RESTRICCIONES</h3><div id="tvRestr"></div></div><div class="kpi"><h3 style="margin-top:0">Repuestos BAJO MÍNIMO</h3><div id="tvStock"></div></div></div></div></section><section id="page-equipo" class="hidden"><div id="equipoDetail"></div></section><section id="page-repuesto" class="hidden"><div id="repuestoDetail"></div></section></main><footer>v31 · © CDL</footer><script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script><script>const API_BASE="https://script.google.com/macros/s/AKfycbyf9lBLIXXKIBOCuERaVaNb8lUkASiYFblFX8_OHS7KMU7tBg0hgtOTfmtAOV59zUAQ/exec";const byId=i=>document.getElementById(i);const val=i=>byId(i).value;const esc=s=>(s||"").replace(/[&<>"]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[m])).replace(/"/g,"&quot;");const fmt=n=>(Math.round((+n||0)*100)/100).toFixed(2);const fmtDate=d=>new Date(d).toLocaleString();async function apiGet(q){const r=await fetch(API_BASE+"?"+new URLSearchParams(q));return r.json()}async function apiPost(o){const r=await fetch(API_BASE,{method:"POST",headers:{"Content-Type":"text/plain;charset=utf-8"},body:JSON.stringify(o)});return r.json()}const ROLE_MAP={"Administrador":"admin","Gerente":"gerente","Encargado":"encargado","Producción":"produccion","RT":"rt","Tco.INT":"tco","Subcontrata":"subc","Invitado":"guest"};let currentUser=JSON.parse(localStorage.getItem("CDL_USER")||'{"user":"invitado","rol":"Invitado","group":"guest"}');function setUser(u){currentUser=u;localStorage.setItem("CDL_USER",JSON.stringify(u));byId("roleChip").textContent=u.rol;applyRoleUI()}async function login(){const user=val("userSelect"),pass=val("userPass")||"";const r=await apiPost({res:"auth",fn:"login",user,pass});if(!r.ok){alert("Error login");return}const group=ROLE_MAP[r.rol]||"guest";setUser({user,rol:r.rol,group});byId("userPanel").classList.add("hidden");byId("userPass").value=""}function logout(){setUser({user:"invitado",rol:"Invitado",group:"guest"})}async function changePwd(){const user=val("userSelect"),old=val("oldPass")||"",nu=val("newPass")||"";if(!old||!nu){byId("pwdMsg").textContent="Rellena ambas contraseñas.";return}const r=await apiPost({res:"auth",fn:"changepwd",user,old,nu});byId("pwdMsg").textContent=r.ok?"Contraseña cambiada.":"Error al cambiar."}function applyRoleUI(){const g=currentUser.group;["btnExportIncidCSV","btnExportIncidPDF","btnExportKPICSV","btnExportKPIPDF","btnExportInvCSV"].forEach(id=>byId(id)?.classList.toggle("hidden",!(g==="admin"||g==="gerente")));byId("btnAddOT")&&(byId("btnAddOT").disabled=!(g==="admin"||g==="tco"));/* inventario: todos menos guest pueden editar */}const userBtn=byId("userBtn"),pagesBtn=byId("pagesBtn"),userPanel=byId("userPanel"),pagesPanel=byId("pagesPanel");userBtn.addEventListener("click",e=>{e.stopPropagation();userPanel.classList.toggle("hidden");pagesPanel.classList.add("hidden")});pagesBtn.addEventListener("click",e=>{e.stopPropagation();pagesPanel.classList.toggle("hidden");userPanel.classList.add("hidden")});document.addEventListener("click",e=>{if(!userPanel.contains(e.target)&&e.target!==userBtn)userPanel.classList.add("hidden");if(!pagesPanel.contains(e.target)&&e.target!==pagesBtn)pagesPanel.classList.add("hidden")});let CURRENT_PAGE="equipos";function nav(id){CURRENT_PAGE=id;["equipos","gruas","otros","incidencias","indicadores","ot","inventario","tv","equipo","repuesto"].forEach(s=>byId("page-"+s).classList.add("hidden"));byId("page-"+id).classList.remove("hidden");if(id==="equipos")loadState();if(id==="gruas")renderSubGroup("Puentes Grúa","gruasWrap");if(id==="otros")renderSubGroup("Otros (auxiliares)","otrosWrap");if(id==="incidencias")loadIncid();if(id==="indicadores"){calcKPIs();drawAllCharts();}if(id==="ot")loadOT();if(id==="inventario")loadInv();if(id==="tv")loadTV();window.scrollTo({top:0,behavior:"smooth"})}let STATE=[];async function loadState(){try{const j=await apiGet({res:"state",fn:"list"});if(j.ok&&j.items.length){STATE=j.items;renderState();return}await apiPost({res:"state",fn:"seed"});const k=await apiGet({res:"state",fn:"list"});STATE=k.ok?k.items:[];renderState()}catch(e){console.error(e)}}function statusClass(s){return s==="Parada"?"p-stop":s==="Restricciones"?"p-warn":"p-ok"}function renderState(){const by={};STATE.forEach(it=>{(by[it.grupo]??=[]).push(it)});const wrap=byId("equiposWrap");wrap.innerHTML="";for(const[g,items]of Object.entries(by)){if(g.startsWith("Puentes Grúa")||g==="Otros (auxiliares)")continue;const blk=document.createElement("div");blk.className="group";items.forEach(eq=>blk.appendChild(cardEquipo(eq)));wrap.appendChild(blk)}if(!byId("page-gruas").classList.contains("hidden"))renderSubGroup("Puentes Grúa","gruasWrap");if(!byId("page-otros").classList.contains("hidden"))renderSubGroup("Otros (auxiliares)","otrosWrap")}function renderSubGroup(match,target){const wrap=byId(target);wrap.innerHTML="";STATE.filter(x=>match==="Otros (auxiliares)"?x.grupo===match:x.grupo.startsWith(match)).forEach(eq=>wrap.appendChild(cardEquipo(eq)))}function cardEquipo(eq){const el=document.createElement("div");el.className="card";const safe=eq.nombre.replace(/'/g,"\\'");el.innerHTML=`<div class="cardH"><span class="pilot ${statusClass(eq.estado)}"></span><div><div class="name">${esc(eq.nombre)}<i class="qr-mini"></i></div><div class="sub">${esc(eq.grupo||"")}</div></div><div style="margin-left:auto"><button class="btnLite" onclick="openFicha('${safe}')">Ficha</button> <button class="btnLite" onclick="estadoConIncid('${safe}','Nueva')">Nueva incidencia</button></div></div><div class="row2"><div class="seg" data-pos="${eq.estado==='En marcha'?0:eq.estado==='Restricciones'?1:2}" data-name="${safe}"><div class="knob"></div><button data-p="0"><span class="dot d-ok"></span>En marcha</button><button data-p="1"><span class="dot d-warn"></span>Restricciones</button><button data-p="2"><span class="dot d-stop"></span>Parada</button></div><button class="btnCap cap-warn" onclick="estadoConIncid('${safe}','Parada','programada')">Parada programada</button><button class="btnCap cap-stop" onclick="accionParadaProlongada('${safe}')">Parada prolongada</button></div>`;setTimeout(()=>bindSeg(el.querySelector(".seg")),0);return el}function bindSeg(seg){const name=seg.dataset.name;seg.addEventListener("click",e=>{const b=e.target.closest("button[data-p]");if(!b)return;seg.setAttribute("data-pos",b.dataset.p);const st=b.dataset.p==="0"?"En marcha":b.dataset.p==="1"?"Restricciones":"Parada";setEstado(name,st)})}async function setEstado(name,estado){if(currentUser.group==="guest"){alert("Inicia sesión para modificar estados.");return}await apiPost({res:"state",fn:"set",name,estado,actor:currentUser.user});const it=STATE.find(x=>x.nombre===name);if(it)it.estado=estado;renderState()}function estadoConIncid(name,estado,modo){if(estado!=="Nueva")setEstado(name,estado==="Parada"&&modo==="programada"?"Parada":estado);nav("incidencias");setTimeout(()=>{byId("iEquipo").value=name;byId("iTipo").value=modo==="programada"?"Preventivo":"Correctivo";byId("iRes").value=estado==="Restricciones"?"Con restricciones":estado==="Nueva"?"Solucionado":"Parada";byId("iDesc").focus()},140)}async function accionParadaProlongada(name){if(currentUser.group==="guest"){alert("Inicia sesión para marcar paradas.");return}await apiPost({res:"alert",fn:"parada",equipo:name,actor:currentUser.user});await loadState()}let INCIDS_ALL=[],INCID_PAGE=1,INCID_PAGE_SIZE=10,INCID_SORT_KEY="fecha",INCID_SORT_DIR="desc";function uniqSorted(a){return[...new Set(a)].sort((x,y)=>String(x).localeCompare(String(y),"es"))}function resetIncidFilters(){["fEquipo","fTipo","fRes","filtroIncid"].forEach(id=>byId(id).value="");renderIncidTable()}async function loadIncid(){const st=await apiGet({res:"state",fn:"list"});STATE=st.ok?st.items:[];const inc=await apiGet({res:"incid",fn:"list"});INCIDS_ALL=inc.ok?inc.items:[];byId("iEquipo").innerHTML=STATE.map(x=>`<option>${esc(x.nombre)}</option>`).join("");buildIncidFilters();renderIncidTable()}function buildIncidFilters(){const equipos=uniqSorted(INCIDS_ALL.map(x=>x.equipo).filter(Boolean));const tipos=uniqSorted(INCIDS_ALL.map(x=>x.tipo).filter(Boolean));const res=uniqSorted(INCIDS_ALL.map(x=>x.res).filter(Boolean));byId("fEquipo").innerHTML=`<option value="">Equipo: todos</option>`+equipos.map(n=>`<option value="${esc(n)}">${esc(n)}</option>`).join("");byId("fTipo").innerHTML=`<option value="">Tipo: todos</option>`+[...new Set(["Correctivo","Preventivo","Predictivo","Mejora",...tipos])].map(n=>`<option value="${esc(n)}">${esc(n)}</option>`).join("");byId("fRes").innerHTML=`<option value="">Resultado: todos</option>`+[...new Set(["Solucionado","Con restricciones","Parada",...res])].map(n=>`<option value="${esc(n)}">${esc(n)}</option>`).join("")}function toggleIncidCols(){const on=id=>byId(id).checked;document.querySelectorAll("#incidTableWrap th[data-k], #incidTableWrap td[data-k]").forEach(cell=>{const k=cell.getAttribute("data-k");cell.style.display=(k==="fecha"&&!on("colFecha")||k==="equipo"&&!on("colEquipo")||k==="tipo"&&!on("colTipo")||k==="res"&&!on("colRes")||k==="paro"&&!on("colParo")||k==="rep"&&!on("colRep"))?"none":""})}function renderIncidTable(){const q=(byId("filtroIncid").value||"").toLowerCase(),fEq=byId("fEquipo").value||"",fTip=byId("fTipo").value||"",fRes=byId("fRes").value||"";let arr=INCIDS_ALL.filter(x=>JSON.stringify(x).toLowerCase().includes(q)&&(!fEq||x.equipo===fEq)&&(!fTip||String(x.tipo||"").toLowerCase().startsWith(fTip.toLowerCase()))&&(!fRes||String(x.res||"").toLowerCase().startsWith(fRes.toLowerCase())));const dir=INCID_SORT_DIR==="asc"?1:-1;arr.sort((a,b)=>{let A,B;switch(INCID_SORT_KEY){case"fecha":A=new Date(a.created).getTime();B=new Date(b.created).getTime();break;default:A=0;B=0}return(A===B?0:A>B?1:-1)*dir});const rows=arr.slice((INCID_PAGE-1)*INCID_PAGE_SIZE,(INCID_PAGE-1)*INCID_PAGE_SIZE+INCID_PAGE_SIZE).map(x=>{const desc=String(x.desc||"");const preview=desc&&desc.length>60?desc.slice(0,57)+"…":desc||"Ver descripción";return`<tr><td class="nowrap" data-k="fecha">${fmtDate(x.created)}</td><td data-k="equipo"><b>${esc(x.equipo||"")}</b></td><td data-k="tipo"><span class="tag ${String(x.tipo||'').toLowerCase().startsWith('corre')?'tag-corr':String(x.tipo||'').toLowerCase().startsWith('preven')?'tag-prev':String(x.tipo||'').toLowerCase().startsWith('pred')?'tag-pred':'tag-mej'}">${esc(x.tipo||"")}</span></td><td data-k="res"><span class="tag ${String(x.res||'').toLowerCase().startsWith('solu')?'tag-sol':String(x.res||'').toLowerCase().includes('restr')?'tag-rest':'tag-par'}">${esc(x.res||"")}</span></td><td><details><summary>${esc(preview)}</summary><div>${esc(desc)}</div></details></td><td class="num" data-k="paro">${fmt(x.hParo)}</td><td class="num" data-k="rep">${fmt(x.hRep)}</td></tr>`}).join("");byId("incidTableWrap").innerHTML=`<table><thead><tr><th data-k="fecha">Fecha</th><th data-k="equipo">Equipo</th><th data-k="tipo">Tipo</th><th data-k="res">Resultado</th><th>Descripción</th><th data-k="paro">Horas parada</th><th data-k="rep">Reparación</th></tr></thead><tbody>${rows}</tbody></table>`;byId("colFecha").checked=false;byId("colTipo").checked=false;byId("colRes").checked=false;byId("colParo").checked=false;byId("colRep").checked=false;byId("colEquipo").checked=true;toggleIncidCols()}async function addIncid(){if(currentUser.group==="guest"){alert("Inicia sesión para registrar incidencias.");return}let ok=!0;const desc=(val("iDesc")||"").trim();if(!val("iEquipo"))ok=!1;if(!val("iTipo"))ok=!1;if(!val("iRes"))ok=!1;if(!val("iInicio"))ok=!1;if(!desc||desc.length>600)ok=!1;if(!ok)return alert("Revisa el formulario.");const item={equipo:val("iEquipo"),tipo:val("iTipo"),res:val("iRes"),rep:val("iRep"),repTxt:val("iRepTxt"),hParo:+val("iHParo")||0,hRep:+val("iHRep")||0,inicio:val("iInicio")||new Date().toISOString(),fin:val("iFin")||"",reportante:val("iReport")||currentUser.user,asignado:val("iAsignado")||"",adj:"",desc};await apiPost({res:"incid",fn:"add",item,actor:currentUser.user});loadIncid();loadState()}/* KPIs */function groupByWeek(arr){const g={};for(const x of arr){const d=new Date(x.created);const w=`${d.getFullYear()}-W${Math.floor((Date.UTC(d.getFullYear(),d.getMonth(),d.getDate())-Date.UTC(d.getFullYear(),0,1))/86400000/7)+1}`;(g[w]??=[]).push(x)}return g}function kpiMTTR(list){const s=list.reduce((p,x)=>p+(+x.hRep||0),0);const n=list.length||1;return s/n}function kpiMTBF(list){const horas=4*30*24;const fallas=list.length||1;return horas/fallas}function kpiDisp(list){const prodH=120;const perd=list.reduce((p,x)=>p+(+x.hParo||0),0);return Math.max(0,(prodH-perd)/prodH)}function kpiOEE(d){return d*.9*.98}function calcKPIs(){const mttr=kpiMTTR(INCIDS_ALL),mtbf=kpiMTBF(INCIDS_ALL),disp=kpiDisp(INCIDS_ALL),oee=kpiOEE(disp);byId("kpiMttrG").textContent=fmt(mttr);byId("kpiMbfG").textContent=fmt(mtbf);byId("kpiDispG").textContent=fmt(disp*100);byId("kpiOeeG").textContent=fmt(oee*100)}function drawChart(id,labels,data,label){const ctx=byId(id).getContext("2d");new Chart(ctx,{type:"bar",data:{labels:labels,datasets:[{label:label,data:data}]}})}function drawAllCharts(){const weeks=groupByWeek(INCIDS_ALL),labels=Object.keys(weeks).sort();drawChart("kpiChartMttr",labels,labels.map(w=>kpiMTTR(weeks[w])),"MTTR (h)");drawChart("kpiChartMtbf",labels,labels.map(w=>kpiMTBF(weeks[w])),"MTBF (h)");drawChart("kpiChartDisp",labels,labels.map(w=>kpiDisp(weeks[w])*100),"Disp (%)");drawChart("kpiChartOee",labels,labels.map(w=>kpiOEE(kpiDisp(weeks[w]))*100),"OEE (%)")}let OTS=[];async function loadOT(){const st=await apiGet({res:"state",fn:"list"});STATE=st.ok?st.items:[];const ot=await apiGet({res:"ot",fn:"list"});OTS=ot.ok?ot.items:[];byId("otEquipo").innerHTML=STATE.map(x=>`<option>${esc(x.nombre)}</option>`).join("");renderOT()}function renderOT(){let arr=[...OTS];arr.sort((a,b)=>new Date(b.created)-new Date(a.created));const rows=arr.map(o=>`<tr><td class="nowrap">${fmtDate(o.created)}</td><td><b>${esc(o.titulo||"")}</b><div class="sub">${esc(o.equipo)}</div></td><td>${o.prioridad}</td><td>${esc(o.asignado||"")}</td><td class="nowrap">${esc(o.vencimiento||"")}</td><td>${esc(o.estado||"")}</td></tr>`).join("");byId("otTableWrap").innerHTML=`<table><thead><tr><th>Fecha</th><th>OT</th><th>Prioridad</th><th>Asignado</th><th>Vence</th><th>Estado</th></tr></thead><tbody>${rows}</tbody></table>`}async function addOT(){if(!(currentUser.group==="admin"||currentUser.group==="tco")){alert("Tu rol no puede crear OT.");return}if(!val("otEquipo")||!val("otPri")||!val("otTitulo")||!val("otDue"))return alert("Completa los campos obligatorios.");const item={equipo:val("otEquipo"),prioridad:val("otPri"),titulo:val("otTitulo").trim(),asignado:val("otAsign"),vencimiento:val("otDue"),adj:val("otAdj"),desc:(val("otDesc")||"").trim()};await apiPost({res:"ot",fn:"add",item,actor:currentUser.user});byId("otTitulo").value="";byId("otAsign").value="";byId("otAdj").value="";byId("otDesc").value="";loadOT()}function exportOTPDF(){const g=currentUser.group;if(!(g==="admin"||g==="gerente"||g==="tco"))return alert("No permitido");const rows=OTS.map(o=>`<tr><td>${fmtDate(o.created)}</td><td>${esc(o.titulo)}</td><td>${esc(o.equipo)}</td><td>${o.prioridad}</td><td>${esc(o.asignado)}</td><td>${esc(o.vencimiento)}</td></tr>`).join("");const w=window.open("","_blank");w.document.write(`<!doctype html><meta charset="utf-8"><title>OT</title><style>body{font-family:Inter,sans-serif;padding:16px}table{width:100%;border-collapse:collapse}td,th{border:1px solid #ddd;padding:8px}</style><h2>Órdenes de trabajo</h2><table><tr><th>Fecha</th><th>Título</th><th>Equipo</th><th>Prioridad</th><th>Asignado</th><th>Vence</th></tr>${rows}</table>`);w.document.close()}/* Inventario */let INV=[];async function loadInv(){const j=await apiGet({res:"inv",fn:"list"});INV=j.ok?j.items:[];renderInv()}function toggleAlerts(){const box=byId("alertsBox");box.style.display=box.style.display==="block"?"none":"block"}function renderInv(){const q=(byId("invSearch").value||"").toLowerCase();const g=currentUser.group!=="guest";let arr=INV.filter(x=>(x.nombre+x.ref).toLowerCase().includes(q));const lows=arr.filter(x=>+x.stock<=+x.minimo);const list=lows.map(x=>`<div>• <b>${esc(x.ref)}</b> — ${esc(x.nombre)} <span class="badge-low">(${+x.stock}/${+x.minimo})</span></div>`).join("");byId("alertsBox").innerHTML=lows.length?list:"Sin alertas de mínimo.";const rows=arr.map(x=>{const low=(+x.stock||0)<= (+x.minimo||0);const refEsc=x.ref.replace(/'/g,"\\'");return`<tr class="${low?"row-low":""}"><td><b>${esc(x.ref)}</b> <i class="qr-mini"></i><div class="sub">${esc(x.nombre||"")}</div></td><td class="num">${g?`<span class="stk" data-ref="${esc(x.ref)}" contenteditable="true" onkeydown="if(event.key==='Enter'){event.preventDefault();this.blur()}">${+x.stock||0}</span>`:+x.stock||0}</td><td class="num">${+x.minimo||0}</td><td><button class="btnLite" onclick="delta('${refEsc}',-1)">–1</button> <button class="btnLite" onclick="delta('${refEsc}',+1)">+1</button> <button class="btnLite" onclick="openRepuestoByRef('${refEsc}')">QR</button></td></tr>`}).join("");byId("invTableWrap").innerHTML=`<table><thead><tr><th>Repuesto</th><th>Stock</th><th>Mínimo</th><th>Acciones</th></tr></thead><tbody>${rows}</tbody></table>`;document.querySelectorAll(".stk").forEach(el=>{el.addEventListener("blur",async()=>{const ref=el.dataset.ref;const old=INV.find(r=>String(r.ref)===ref)?.stock||0;let nu=parseInt(el.textContent.trim(),10);if(!Number.isFinite(nu)||nu<0){el.textContent=old;return}const diff=nu-old;await apiPost({res:"inv",fn:"delta",ref,delta:diff,actor:currentUser.user});loadInv()})})}async function addInv(){if(currentUser.group==="guest"){alert("Inicia sesión para añadir repuestos.");return}const nombre=(val("invNombre")||"").trim(),ref=(val("invRef")||"").trim().toUpperCase(),stock=Number(val("invStock")),minimo=Number(val("invMin"));if(!ref||!nombre||!Number.isFinite(stock)||stock<0||!Number.isFinite(minimo)||minimo<0)return alert("Revisa los campos.");if(INV.some(x=>String(x.ref).toUpperCase()===ref))return alert("La referencia ya existe");await apiPost({res:"inv",fn:"add",item:{nombre,ref,stock:Math.floor(stock),minimo:Math.floor(minimo)},actor:currentUser.user});byId("invNombre").value="";byId("invRef").value="";byId("invStock").value="";byId("invMin").value="";loadInv()}async function delta(ref,d){if(currentUser.group==="guest"){alert("Inicia sesión para modificar stock.");return}await apiPost({res:"inv",fn:"delta",ref,delta:+d||0,actor:currentUser.user});loadInv()}function exportInvCSV(){const header=["Ref","Nombre","Stock","Minimo"];const rows=INV.map(x=>[x.ref,x.nombre,x.stock,x.minimo]);const toCSV=a=>a.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(",")).join("\n");const a=document.createElement("a");a.href=URL.createObjectURL(new Blob([toCSV([header,...rows])],{type:"text/csv"}));a.download="inventario.csv";a.click()}/* TV */let TV_TIMER=null;async function loadTV(){const st=await apiGet({res:"state",fn:"list"});STATE=st.ok?st.items:[];const inv=await apiGet({res:"inv",fn:"list"});INV=inv.ok?inv.items:[];renderTV();if(TV_TIMER)clearInterval(TV_TIMER);TV_TIMER=setInterval(()=>loadTV(),1e4)}function renderTV(){const par=STATE.filter(x=>x.estado==="Parada"),res=STATE.filter(x=>x.estado==="Restricciones"),low=INV.filter(x=>+x.stock<=+x.minimo);byId("tvParados").innerHTML=par.length?par.map(x=>`<div>• ${esc(x.nombre)}</div>`).join(""):"Sin paradas";byId("tvRestr").innerHTML=res.length?res.map(x=>`<div>• ${esc(x.nombre)}</div>`).join(""):"Sin restricciones";byId("tvStock").innerHTML=low.length?low.map(x=>`<div>• ${esc(x.ref)} — ${esc(x.nombre)} (${x.stock}/${x.minimo})</div>`).join(""):"Stock correcto"}/* QR pages */function slugify(s){return String(s||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"")}function baseURL(){return location.origin+location.pathname}function ensureHidden(){["equipos","gruas","otros","incidencias","indicadores","ot","inventario","tv","equipo","repuesto"].forEach(s=>byId("page-"+s)?.classList.add("hidden"))}function openEquipoByName(n){const slug=slugify(n);location.hash=`#/equipo/${slug}`;renderEquipoBySlug(slug)}function openRepuestoByRef(ref){const code=encodeURIComponent(String(ref||"").toUpperCase());location.hash=`#/repuesto/${code}`;renderRepuestoByRef(code)}function renderEquipoBySlug(slug){const eq=STATE.find(x=>slugify(x.nombre)===slug);ensureHidden();const host=byId("page-equipo");host.classList.remove("hidden");if(!eq){byId("equipoDetail").innerHTML=`<div class="kpi">Equipo no encontrado.</div>`;return}const inc=INCIDS_ALL.filter(i=>i.equipo===eq.nombre).sort((a,b)=>new Date(b.created)-new Date(a.created));const qrText=`${baseURL()}#/equipo/${slug}`;const htmlInc=inc.length?inc.map(i=>`<tr><td class="nowrap">${fmtDate(i.created)}</td><td>${esc(i.tipo||"")}</td><td>${esc(i.res||"")}</td><td>${esc(i.desc||"")}</td><td class="num">${fmt(i.hParo||0)}</td><td class="num">${fmt(i.hRep||0)}</td></tr>`).join(""):`<tr><td colspan="6">Sin incidencias registradas.</td></tr>`;const safeTitle=(eq.nombre||"").replace(/["']/g,m=>m==='"'?"&quot;":"&#39;");byId("equipoDetail").innerHTML=`<div class="kpi"><div style="display:flex;gap:12px;align-items:center"><div id="eqQR"></div><div><h2 style="margin:.2rem 0">${esc(eq.nombre)}</h2><div class="sub">${esc(eq.grupo)}</div><div style="margin-top:.4rem"><code>${qrText}</code></div><div style="margin-top:.5rem"><button class="btnLite" onclick="printQR('eqQR','${safeTitle}')">Imprimir etiqueta</button> <button class="btnLite" onclick="nav('equipos')">Volver</button></div></div></div></div><div class="kpi" style="margin-top:10px"><h3>Historial de incidencias — ${esc(eq.nombre)}</h3><table><thead><tr><th>Fecha</th><th>Tipo</th><th>Resultado</th><th>Descripción</th><th>Parada</th><th>Reparación</th></tr></thead><tbody>${htmlInc}</tbody></table></div>`;new QRCode(byId("eqQR"),{text:qrText,width:120,height:120,correctLevel:QRCode.CorrectLevel.M})}function renderRepuestoByRef(code){const ref=decodeURIComponent(code).toUpperCase();const it=INV.find(x=>String(x.ref).toUpperCase()===ref);ensureHidden();const host=byId("page-repuesto");host.classList.remove("hidden");if(!it){byId("repuestoDetail").innerHTML=`<div class="kpi">Repuesto no encontrado.</div>`;return}const qrText=`${baseURL()}#/repuesto/${encodeURIComponent(ref)}`;const safe=("REP-"+ref).replace(/["']/g,m=>m==='"'?"&quot;":"&#39;");byId("repuestoDetail").innerHTML=`<div class="kpi"><div style="display:flex;gap:12px;align-items:center"><div id="repQR"></div><div><h2 style="margin:.2rem 0">${esc(it.nombre||"")}</h2><div class="sub"><b>Ref:</b> ${esc(ref)} · <b>Stock:</b> ${+it.stock||0} · <b>Mínimo:</b> ${+it.minimo||0}</div><div style="margin-top:.4rem"><code>${qrText}</code></div><div style="margin-top:.5rem"><button class="btnLite" onclick="printQR('repQR','${safe}')">Imprimir etiqueta</button> <button class="btnLite" onclick="nav('inventario')">Volver</button></div></div></div></div>`;new QRCode(byId("repQR"),{text:qrText,width:120,height:120,correctLevel:QRCode.CorrectLevel.M})}function printQR(id,title){const node=byId(id);const img=node.querySelector("img")||node.querySelector("canvas");const src=img.tagName==="CANVAS"?img.toDataURL("image/png"):img.src;const w=window.open("","_blank");w.document.write(`<!doctype html><meta charset="utf-8"><title>${esc(title)}</title><style>body{font-family:Inter,sans-serif;text-align:center;padding:16px}</style><h3>${esc(title)}</h3><img src="${src}" width="220" height="220"><div style="margin-top:8px">${location.origin}${location.pathname}</div>`);w.document.close();w.print()}/* boot */setUser(currentUser);nav("equipos");loadState();</script></body></html>