<!doctype html><html lang="es"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>CDL Â· CMMS</title>
<style>
:root{--c1:#C62828;--c1l:#FBEAEA;--g:#2e7d32;--o:#f57c00;--r:#d32f2f;--soft:#f6f7f9}
*{box-sizing:border-box}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--soft)}
.header{position:sticky;top:0;z-index:30;background:linear-gradient(180deg,var(--c1l),#fff);border-bottom:3px solid var(--c1)}
.header-top{display:flex;align-items:center;gap:14px;padding:8px 12px}
.header-top img{height:70px}
.header-top h1{margin:0;font-size:19px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:900;color:#111}
.header-bottom{display:flex;gap:8px;overflow-x:auto;padding:8px 10px;border-top:1px solid #eee}
.navbtn{flex:0 0 auto;text-decoration:none;color:#111;background:#fff;border:1px solid #e2e2e2;padding:8px 12px;border-radius:999px;font-weight:800;font-size:13px}
.navbtn.active{background:var(--c1);color:#fff;border-color:var(--c1)}
.container{max-width:1100px;margin:12px auto;padding:0 12px}
.card{background:#fff;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.06);padding:12px;margin:12px 0;border:1px solid #eee}
.section-title{margin:4px 0 10px 0;font-size:17px;color:#111}
.grid{display:grid;grid-template-columns:1fr;gap:8px}@media(min-width:720px){.grid{grid-template-columns:1fr 1fr}}
.item{display:flex;flex-wrap:wrap;gap:10px;border:1px solid #eee;border-radius:12px;padding:10px}
.item-left{display:flex;align-items:center;gap:10px;flex:1 1 260px;min-width:0}
.dot{width:12px;height:12px;border-radius:999px}
.dot.g{background:var(--g)}.dot.o{background:var(--o)}.dot.r{background:var(--r)}
.title{font-weight:900;line-height:1.15;word-break:break-word}
.small{color:#666}
.item-actions{display:flex;gap:8px;flex:1 1 240px;justify-content:flex-end}
select,input,textarea{border:1px solid #ddd;border-radius:10px;padding:8px}
.btn{appearance:none;border:0;background:var(--c1);color:#fff;border-radius:10px;padding:9px 12px;font-weight:800;cursor:pointer}
.btn.ghost{background:#e8eaed;color:#111}.btn.warn{background:var(--r)}
.table-wrap{overflow-x:auto;border-radius:12px}
.table{width:100%;min-width:920px;border-collapse:separate;border-spacing:0 8px}
.table th{text-align:left;color:#666;font-size:12px;padding:8px;white-space:nowrap}
.table td{background:#fff;padding:10px;border-radius:10px;vertical-align:top;word-break:break-word}
.badge{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:4px 8px;background:#eee;font-weight:700;font-size:12px}
canvas{max-width:100%}
.inv-grid{display:grid;grid-template-columns:2fr 1fr 1fr 1fr 160px;gap:8px;align-items:center}
.inv-item{display:contents}
.inv-head{font-size:12px;color:#666}
.inv-cell{background:#fff;border:1px solid #eee;border-radius:10px;padding:8px}
.qty{display:flex;gap:6px;align-items:center;justify-content:flex-end}
.qty button{padding:6px 10px;border-radius:8px;border:0;background:#e9e9e9;font-weight:800;cursor:pointer}
.alert{background:#fff3f3;border-left:6px solid var(--c1);padding:10px;border-radius:10px}
.toast{position:fixed;left:10px;right:10px;bottom:12px;display:none;z-index:50}
.toast .in{background:#323232;color:#fff;padding:10px 12px;border-radius:10px;display:flex;justify-content:space-between;align-items:center;gap:10px;box-shadow:0 6px 18px rgba(0,0,0,.3)}
.toast button{background:#ff7043;border:0;color:#fff;border-radius:6px;padding:6px 10px;font-weight:700}
</style>
</head>
<body>
<header class="header">
  <div class="header-top">
    <img src="logo_mantenimiento.jpeg" alt="CDL">
    <h1>CDL Â· CMMS</h1>
  </div>
  <div class="header-bottom" id="nav">
    <a href="#equipos" class="navbtn active">Equipos</a>
    <a href="#puentes" class="navbtn">Puentes GrÃºa</a>
    <a href="#otros" class="navbtn">Otros</a>
    <a href="#incidencias" class="navbtn">Incidencias</a>
    <a href="#indicadores" class="navbtn">Indicadores</a>
    <a href="#inventario" class="navbtn">Inventario Repuestos</a>
  </div>
</header>

<div class="container">
  <div id="alerta" class="card" style="display:none;border-left:6px solid var(--r)">
    <h3 style="margin:0;color:#d32f2f">Equipos parados o con restricciones por averÃ­a</h3>
    <div id="alertaList" style="display:flex;flex-direction:column;gap:6px"></div>
  </div>

  <section id="equiposSec" class="card">
    <div class="section-title">
      <span class="badge">ðŸ”´ Parada</span>
      <span class="badge">ðŸŸ  Restricciones</span>
      <span class="badge">ðŸŸ¢ En marcha</span>
    </div>
    <button class="btn warn" onclick="serverParadaProlongada()">Parada prolongada (aviso correo)</button>
    <div id="equiposGroups"></div>
  </section>

  <section id="puentesSec" class="card" style="display:none">
    <h2 class="section-title">Puentes GrÃºa por nave</h2>
    <div id="gruasGroups"></div>
  </section>

  <section id="otrosSec" class="card" style="display:none">
    <h2 class="section-title">Otros (auxiliares)</h2>
    <div id="otrosWrap"></div>
  </section>

  <section id="incidenciasSec" class="card" style="display:none">
    <h2 class="section-title">Incidencias</h2>
    <div class="card">
      <h3>Registrar nueva incidencia</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div style="grid-column:1/3"><label>Equipo</label><br><select id="incEquipo" style="width:100%"></select></div>
        <div><label>Tipo</label><br><select id="incTipo" style="width:100%"><option>Correctivo</option><option>Preventivo</option><option>Mejora</option></select></div>
        <div><label>Resultado</label><br><select id="incResultado" style="width:100%"><option>Solucionado</option><option>Con restricciones</option><option>No solucionado</option></select></div>
        <div><label>Â¿Uso de repuestos?</label><br><select id="incRep" style="width:100%"><option>No</option><option>SÃ­</option></select></div>
        <div><label>Repuesto (opcional)</label><br><input id="incRepTxt" placeholder="CÃ³digo o descripciÃ³n" style="width:100%"></div>
        <div><label>Horas de paro (total)</label><br><input type="number" step="0.01" id="incHorasParo" placeholder="Ej. 2.5" style="width:100%"></div>
        <div><label>Horas de reparaciÃ³n</label><br><input type="number" step="0.01" id="incHorasRepar" placeholder="Ej. 1.3" style="width:100%"></div>
        <div><label>Fecha inicio incidencia</label><br><input type="datetime-local" id="incInicio" style="width:100%"></div>
        <div><label>Reportante</label><br><input id="incReportante" placeholder="Nombre/apellidos" style="width:100%"></div>
        <div style="grid-column:1/2"><label>DescripciÃ³n breve</label><br><textarea id="incDesc" rows="3" style="width:100%"></textarea></div>
      </div>
      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" onclick="addIncidencia()">AÃ±adir incidencia</button>
      </div>
    </div>

    <div class="card">
      <h3>Filtros / bÃºsqueda</h3>
      <div style="display:flex;flex-wrap:wrap;gap:8px">
        <div style="flex:1 1 180px"><label>Equipo</label><br><select id="fEquipo" style="width:100%"><option value="">Todos</option></select></div>
        <div style="flex:1 1 160px"><label>Tipo</label><br><select id="fTipo" style="width:100%"><option value="">Todos</option><option>Correctivo</option><option>Preventivo</option><option>Mejora</option></select></div>
        <div style="flex:1 1 160px"><label>Resultado</label><br><select id="fRes" style="width:100%"><option value="">Todos</option><option>Solucionado</option><option>Con restricciones</option><option>No solucionado</option></select></div>
        <div style="flex:2 1 240px"><label>Texto</label><br><input id="fTexto" placeholder="Equipo, descripciÃ³n, repuestoâ€¦" style="width:100%"></div>
        <div style="display:flex;gap:8px;align-items:flex-end">
          <button class="btn ghost" onclick="resetFiltros()">Limpiar</button>
          <button class="btn" onclick="aplicarFiltros()">Aplicar</button>
          <button class="btn ghost" onclick="activarAdmin()">Modo Admin</button>
          <button id="btnCsv" class="btn ghost" style="display:none" onclick="exportarCSV()">Exportar CSV</button>
          <button id="btnPdf" class="btn ghost" style="display:none" onclick="exportarPDF()">Exportar PDF</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>KPIs semanales (segÃºn filtro)</h3>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <div style="background:#fff;border-radius:10px;padding:10px;min-width:140px"><div style="font-size:12px;color:#666">MTTR medio (h)</div><div id="kpiMttr" style="font-size:22px;font-weight:800">0</div></div>
        <div style="background:#fff;border-radius:10px;padding:10px;min-width:140px"><div style="font-size:12px;color:#666">MTBF (h/averÃ­a)</div><div id="kpiMtbf" style="font-size:22px;font-weight:800">0</div></div>
        <div style="background:#fff;border-radius:10px;padding:10px;min-width:140px"><div style="font-size:12px;color:#666">Disponibilidad (%)</div><div id="kpiDisp" style="font-size:22px;font-weight:800">0</div></div>
        <div style="background:#fff;border-radius:10px;padding:10px;min-width:140px"><div style="font-size:12px;color:#666">OEE (estimado %)</div><div id="kpiOee" style="font-size:22px;font-weight:800">0</div></div>
      </div>
      <div class="card"><b>MTTR por semana</b><canvas id="chartMttr" height="160"></canvas></div>
      <div class="card"><b>Incidencias por semana</b><canvas id="chartCount" height="160"></canvas></div>
      <div class="card">
        <b>Leyenda</b>
        <ul style="margin-top:6px">
          <li><b>MTTR</b>: tiempo medio de reparaciÃ³n (h).</li>
          <li><b>MTBF</b>: tiempo medio entre fallos (h); depende de horas/semana.</li>
          <li><b>Disponibilidad</b>: % de tiempo Ãºtil / tiempo total.</li>
          <li><b>OEE (estimado)</b>: aproximado a Disponibilidad (sin rendimiento/calidad).</li>
        </ul>
      </div>
    </div>

    <h3 style="margin-top:10px">Historial (Ãºltimas primero)</h3>
    <div class="table-wrap">
      <table class="table" id="incTable"><thead>
        <tr><th>Fecha</th><th>Equipo</th><th>Tipo</th><th>Resultado</th><th>Reportante</th><th>Inicio</th><th>DescripciÃ³n</th><th>Paro (h)</th><th>ReparaciÃ³n (h)</th><th>Repuestos</th></tr>
      </thead><tbody></tbody></table>
    </div>
  </section>

  <section id="indicadoresSec" class="card" style="display:none">
    <h2 class="section-title">Indicadores (resumen global)</h2>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <div style="background:#fff;border-radius:10px;padding:10px;min-width:140px"><div style="font-size:12px;color:#666">MTTR global (h)</div><div id="kpiMttrG" style="font-size:22px;font-weight:800">0</div></div>
      <div style="background:#fff;border-radius:10px;padding:10px;min-width:140px"><div style="font-size:12px;color:#666">MTBF global (h/averÃ­a)</div><div id="kpiMtbfG" style="font-size:22px;font-weight:800">0</div></div>
      <div style="background:#fff;border-radius:10px;padding:10px;min-width:140px"><div style="font-size:12px;color:#666">Disponibilidad global (%)</div><div id="kpiDispG" style="font-size:22px;font-weight:800">0</div></div>
      <div style="background:#fff;border-radius:10px;padding:10px;min-width:140px"><div style="font-size:12px;color:#666">OEE global (estimado %)</div><div id="kpiOeeG" style="font-size:22px;font-weight:800">0</div></div>
      <div class="card" style="flex:1 1 260px">
        <b>Ajustes</b>
        <div style="margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <label for="hoursPerWeek">Horas/semana</label>
          <input id="hoursPerWeek" type="number" min="1" max="168" step="1" value="120" style="width:120px">
          <button class="btn ghost" onclick="saveHoursPerWeek()">Guardar</button>
          <span id="savedMsg" style="font-size:12px;color:#2e7d32;display:none">Guardado</span>
        </div>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn ghost" onclick="activarAdmin()">Modo Admin</button>
          <button id="btnKpiCsv" class="btn ghost" style="display:none" onclick="exportarKPIsCSV()">Exportar KPIs (CSV)</button>
          <button id="btnKpiPdf" class="btn ghost" style="display:none" onclick="exportarKPIsPDF()">Exportar KPIs (PDF)</button>
        </div>
      </div>
    </div>
    <div class="card"><b>MTTR por semana</b><canvas id="chartMttr2" height="160"></canvas></div>
    <div class="card"><b>Incidencias por semana</b><canvas id="chartCount2" height="160"></canvas></div>
    <div id="indicEmpty" style="display:none;color:#555;margin-top:8px">AÃºn no hay incidencias registradas.</div>
  </section>

  <section id="inventarioSec" class="card" style="display:none">
    <h2 class="section-title">Inventario de repuestos</h2>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin:8px 0">
      <button class="btn ghost" onclick="activarAdmin()">Modo Admin</button>
      <button id="btnInvCsv" class="btn ghost" style="display:none" onclick="exportarInventarioCSV()">Exportar Inventario (CSV)</button>
      <button id="btnInvPdf" class="btn ghost" style="display:none" onclick="exportarInventarioPDF()">Exportar Inventario (PDF)</button>
    </div>

    <div id="invAlert" class="alert" style="display:none">
      <b>âš  Repuestos por reponer</b>
      <div id="invAlertList" style="margin-top:6px"></div>
    </div>

    <div class="card">
      <h3>AÃ±adir repuesto</h3>
      <div style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr 1fr;gap:8px">
        <input id="invNombre" class="inv-cell" placeholder="Nombre (p.ej. Tornillo hex M6x20)">
        <input id="invRef" class="inv-cell" placeholder="Referencia (p.ej. THM6x20)">
        <input id="invStock" class="inv-cell" type="number" min="0" placeholder="Stock">
        <input id="invMin" class="inv-cell" type="number" min="0" placeholder="Stock mÃ­nimo">
        <button class="btn" onclick="invAdd()">AÃ±adir</button>
      </div>
    </div>

    <div class="card">
      <h3>Buscar</h3>
      <input id="invSearch" class="inv-cell" placeholder="Nombre o referenciaâ€¦" oninput="renderInventario()">
    </div>

    <div class="card">
      <div class="inv-grid inv-head">
        <div>Nombre</div><div>Referencia</div><div>Stock</div><div>MÃ­nimo</div><div>Acciones</div>
      </div>
      <div id="invList"></div>
    </div>
  </section>
</div>

<div class="toast" id="toast">
  <div class="in">
    <div id="toastMsg">Listo.</div>
    <div style="display:flex;gap:8px;align-items:center">
      <span id="toastCountdown" style="font-size:12px"></span>
    </div>
  </div>
</div>

<script>
const API_BASE = "https://script.google.com/macros/s/AKfycbzZDI2MNxVk-c2CeeJd11pRlQFmz9kqMq_E_sX9pK8rviVnb97wHPrb1mBKtixt9mxk4A/exec";
const API_KEY  = "";
const HOURS_KEY="cdl_hours_per_week";
async function apiGet(params){ if(!API_BASE){return {ok:false,offline:true,items:[]}}; const url=new URL(API_BASE); Object.entries(params).forEach(([k,v])=>url.searchParams.set(k,v)); if(API_KEY) url.searchParams.set('key',API_KEY); const r=await fetch(url,{method:'GET'}); return await r.json(); }
async function apiPost(body){ if(!API_BASE){return {ok:false,offline:true}}; if(API_KEY) body.key=API_KEY; const r=await fetch(API_BASE,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}); return await r.json(); }
const q=s=>document.querySelector(s);
function setActive(hash){ document.querySelectorAll('.navbtn').forEach(a=>a.classList.remove('active')); const link=document.querySelector('.navbtn[href="'+hash+'"]'); if(link) link.classList.add('active'); ['equiposSec','puentesSec','otrosSec','incidenciasSec','indicadoresSec','inventarioSec'].forEach(id=>q('#'+id).style.display='none'); if(hash==='#puentes') q('#puentesSec').style.display='block'; else if(hash==='#otros') q('#otrosSec').style.display='block'; else if(hash==='#incidencias') q('#incidenciasSec').style.display='block'; else if(hash==='#indicadores') q('#indicadoresSec').style.display='block'; else if(hash==='#inventario') q('#inventarioSec').style.display='block'; else q('#equiposSec').style.display='block'; }
const ADMIN_CODE = "inventariocsv25";
let IS_ADMIN=false; let lastExportTs=0; const EXPORT_COOLDOWN_MS=15000;
function activarAdmin(){ const code=prompt("Introduce clave de administrador:"); if(code===ADMIN_CODE){ IS_ADMIN=true; ['btnCsv','btnPdf','btnKpiCsv','btnKpiPdf','btnInvCsv','btnInvPdf'].forEach(id=>{const el=document.getElementById(id); if(el) el.style.display='inline-block';}); alert("Modo Admin activado"); } else { alert("Clave incorrecta"); } }
function canExportNow(){ const now=Date.now(); if(now-lastExportTs<EXPORT_COOLDOWN_MS) return confirm("Acabas de exportar hace muy poco.\nÂ¿Seguro que quieres lanzar otra exportaciÃ³n ahora?"); lastExportTs=now; return true; }
let STATE=[];
function statusDot(s){return s==='Parada'?'r':(s==='Restricciones'?'o':'g')}
function groupBy(arr,key){return arr.reduce((acc,it)=>{const k=it[key]||'â€”';(acc[k]=acc[k]||[]).push(it);return acc;},{});}
function renderItems(list,labelGroup){ const grid=document.createElement('div'); grid.className='grid'; list.forEach(it=>{ const wrap=document.createElement('div'); wrap.className='item'; wrap.innerHTML=`<div class="item-left"><span class="dot ${statusDot(it.estado||'En marcha')}"></span><div><div class="title">${it.nombre}</div><div class="small">${labelGroup}</div></div></div>`; const actions=document.createElement('div'); actions.className='item-actions'; const sel=document.createElement('select'); ['En marcha','Restricciones','Parada'].forEach(t=>{const o=document.createElement('option');o.value=t;o.textContent=t;if((it.estado||'En marcha')===t) o.selected=true; sel.appendChild(o)}); sel.onchange=async()=>{ await apiPost({res:'state',fn:'set',name:it.nombre,estado:sel.value}); await loadState(); }; const btn=document.createElement('button'); btn.className='btn warn'; btn.textContent='Parada prolongada'; btn.onclick=async()=>{ await apiPost({res:'alert',fn:'parada',equipo:it.nombre}); await loadState(); }; actions.appendChild(sel); actions.appendChild(btn); wrap.appendChild(actions); grid.appendChild(wrap); }); return grid; }
function renderEquipos(){ const host=q('#equiposGroups'); host.innerHTML=''; const grupos=groupBy(STATE.filter(s=>!String(s.grupo||'').startsWith('Puentes GrÃºa') && s.grupo!=='Otros (auxiliares)'), 'grupo'); Object.keys(grupos).forEach(g=>{ const card=document.createElement('div'); card.className='card'; card.innerHTML=`<h3 class="section-title">${g}</h3>`; card.appendChild(renderItems(grupos[g], g)); host.appendChild(card); }); }
function renderGruas(){ const host=q('#gruasGroups'); host.innerHTML=''; const grupos=groupBy(STATE.filter(s=>String(s.grupo||'').startsWith('Puentes GrÃºa')), 'grupo'); Object.keys(grupos).forEach(g=>{ const card=document.createElement('div'); card.className='card'; card.innerHTML=`<h3 class="section-title">${g.replace('Puentes GrÃºa Â· ','Nave ')}</h3>`; card.appendChild(renderItems(grupos[g], g)); host.appendChild(card); }); }
function renderOtros(){ const host=q('#otrosWrap'); host.innerHTML=''; const lista=STATE.filter(s=>s.grupo==='Otros (auxiliares)'); host.appendChild(renderItems(lista,'Auxiliar')); }
async function loadState(){ let r=await apiGet({res:'state',fn:'list'}); if(!r.ok || (r.items||[]).length===0){ await apiPost({res:'state',fn:'seed'}); r=await apiGet({res:'state',fn:'list'}); } STATE=r.items||[]; renderEquipos(); renderGruas(); renderOtros(); renderAlert(); fillEquipoSelect('#incEquipo'); fillEquipoSelect('#fEquipo'); }
function renderAlert(){ const items=STATE.filter(s=> s.estado==='Parada' || s.estado==='Restricciones'); const box=q('#alerta'), list=q('#alertaList'); if(items.length===0){ box.style.display='none'; list.innerHTML=''; return; } box.style.display='block'; list.innerHTML= items.map(i=>`${i.nombre} â€” ${i.estado}`).join('<br>'); }
let INC=[];
function fillEquipoSelect(id){ const sel=q(id); sel.innerHTML=''; STATE.forEach(s=>{ const o=document.createElement('option'); o.value=s.nombre; o.textContent=s.nombre; sel.appendChild(o); }); }
async function loadIncid(){ const r=await apiGet({res:'incid',fn:'list'}); INC=r.items||[]; }
function getFilters(){ return {equipo:q('#fEquipo').value,tipo:q('#fTipo').value,res:q('#fRes').value,texto:q('#fTexto').value.trim().toLowerCase()}; }
function aplicarFiltros(){ const f=getFilters(); const arr=INC.filter(i=>{ if(f.equipo && i.equipo!==f.equipo) return false; if(f.tipo && i.tipo!==f.tipo) return false; if(f.res && i.res!==f.res) return false; if(f.texto){ const blob=(i.equipo+' '+(i.desc||'')+' '+(i.repTxt||'')).toLowerCase(); if(!blob.includes(f.texto)) return false; } return true; }); renderIncidTable(arr); renderKPIs(arr); }
function resetFiltros(){ q('#fEquipo').value=''; q('#fTipo').value=''; q('#fRes').value=''; q('#fTexto').value=''; aplicarFiltros(); }
function renderIncidTable(arr){ const tbody=q('#incTable tbody'); tbody.innerHTML=''; arr.forEach(it=>{ const tr=document.createElement('tr'); tr.innerHTML='<td>'+new Date(it.created).toLocaleString()+'</td><td><span class="badge">'+it.equipo+'</span></td><td>'+it.tipo+'</td><td>'+it.res+'</td><td>'+(it.reportante||'â€”')+'</td><td>'+(it.inicio? new Date(it.inicio).toLocaleString():'â€”')+'</td><td>'+it.desc+'</td><td>'+Number(it.hParo||0).toFixed(2)+'</td><td>'+Number(it.hRep||0).toFixed(2)+'</td><td>'+it.rep+(it.repTxt?(' â€” '+it.repTxt):'')+'</td>'; tbody.appendChild(tr); }); }
function isoWeek(d){const dt=new Date(d),t=new Date(dt.valueOf());const dn=(dt.getDay()+6)%7;t.setDate(t.getDate()-dn+3);const ft=new Date(t.getFullYear(),0,4);return 1+Math.round(((t-ft)/86400000-3+((ft.getDay()+6)%7))/7)}
function drawBars(id,labels,values){ const c=q('#'+id),ctx=c.getContext('2d'); const W=c.width=c.clientWidth, H=c.height=c.clientHeight; ctx.clearRect(0,0,W,H); const pad=28, max=Math.max(1,...values), step=(W-pad*2)/Math.max(1,labels.length), bw=step*0.7; ctx.strokeStyle='#ccc'; ctx.beginPath(); ctx.moveTo(pad,H-pad); ctx.lineTo(W-pad,H-pad); ctx.stroke(); values.forEach((v,i)=>{ const x=pad+i*step+(step-bw)/2, h=(H-pad*2)*(v/max), y=H-pad-h; ctx.fillStyle='rgba(198,40,40,.9)'; ctx.fillRect(x,y,bw,h); ctx.fillStyle='#333'; ctx.font='11px system-ui'; ctx.textAlign='center'; ctx.fillText(String(labels[i]), x+bw/2, H-8); }); }
function getHoursPerWeek(){ const v=parseFloat(localStorage.getItem(HOURS_KEY)||'120'); return isNaN(v)?120:v; }
function saveHoursPerWeek(){ const v=parseFloat(q('#hoursPerWeek').value||'120'); localStorage.setItem(HOURS_KEY, String(Math.max(1,Math.min(168,v)))); q('#savedMsg').style.display='inline'; setTimeout(()=>q('#savedMsg').style.display='none',1200); renderGlobalKPIs(); aplicarFiltros(); }
function renderKPIs(arr){ const corr=arr.filter(i=>i.tipo==='Correctivo'); const byW={}; corr.forEach(i=>{const w=isoWeek(i.created); if(!byW[w]) byW[w]={count:0,rep:0,paro:0}; byW[w].count++; byW[w].rep+=(+i.hRep||0); byW[w].paro+=(+i.hParo||0); }); const weeks=Object.keys(byW).sort((a,b)=>a-b); const mttr=corr.length ? corr.reduce((s,i)=>s+(+i.hRep||0),0)/corr.length : 0; const HPW=getHoursPerWeek(); const mtbfWeeks=weeks.map(w=> byW[w].count ? HPW/byW[w].count : HPW); const dispWeeks=weeks.map((w,i)=>{ const fail=byW[w].count; const mtbf=mtbfWeeks[i]; const mttrW= fail? byW[w].rep/fail : 0; return (mtbf/(mtbf+mttrW))*100; }); const meanMtbf=weeks.length ? mtbfWeeks.reduce((a,b)=>a+b,0)/weeks.length : 0; const meanDisp=weeks.length ? dispWeeks.reduce((a,b)=>a+b,0)/weeks.length : 0; q('#kpiMttr').textContent=mttr.toFixed(2); q('#kpiMtbf').textContent=meanMtbf.toFixed(1); q('#kpiDisp').textContent=meanDisp.toFixed(1); q('#kpiOee').textContent=meanDisp.toFixed(1); drawBars('chartMttr',weeks,weeks.map((w,i)=>{const fail=byW[w].count; return fail? byW[w].rep/fail : 0;})); drawBars('chartCount',weeks,weeks.map(w=>byW[w].count)); }
function renderGlobalKPIs(){ const corr=INC.filter(i=>i.tipo==='Correctivo'); const byW={}; corr.forEach(i=>{const w=isoWeek(i.created); if(!byW[w]) byW[w]={count:0,rep:0}; byW[w].count++; byW[w].rep+=(+i.hRep||0); }); const weeks=Object.keys(byW).sort((a,b)=>a-b); const HPW=getHoursPerWeek(); const mttr=corr.length ? corr.reduce((s,i)=>s+(+i.hRep||0),0)/corr.length : 0; const mtbfWeeks=weeks.map(w=> byW[w].count ? HPW/byW[w].count : HPW); const meanMtbf=weeks.length ? mtbfWeeks.reduce((a,b)=>a+b,0)/weeks.length : 0; const dispWeeks=weeks.map((w,i)=>{ const fail=byW[w].count; const mtbf=mtbfWeeks[i]; const mttrW= fail? byW[w].rep/fail : 0; return (mtbf/(mtbf+mttrW))*100; }); const meanDisp=weeks.length ? dispWeeks.reduce((a,b)=>a+b,0)/weeks.length : 0; q('#kpiMttrG').textContent=mttr.toFixed(2); q('#kpiMtbfG').textContent=meanMtbf.toFixed(1); q('#kpiDispG').textContent=meanDisp.toFixed(1); q('#kpiOeeG').textContent=meanDisp.toFixed(1); drawBars('chartMttr2',weeks,weeks.map((w,i)=>{const fail=byW[w].count; return fail? byW[w].rep/fail : 0;})); drawBars('chartCount2',weeks,weeks.map(w=>byW[w].count)); q('#indicEmpty').style.display = INC.length? 'none':'block'; const hpwInput=q('#hoursPerWeek'); if(hpwInput) hpwInput.value=getHoursPerWeek(); }
async function addIncidencia(){ const item={ equipo:q('#incEquipo').value.trim(), tipo:q('#incTipo').value, res:q('#incResultado').value, rep:q('#incRep').value, repTxt:q('#incRepTxt').value.trim(), hParo:parseFloat(q('#incHorasParo').value||'0'), hRep:parseFloat(q('#incHorasRepar').value||'0'), inicio:q('#incInicio').value, reportante:q('#incReportante').value.trim(), desc:q('#incDesc').value.trim() }; if(!item.equipo || !item.desc){ alert('Equipo y descripciÃ³n obligatorios'); return; } await apiPost({res:'incid',fn:'add',item}); ['incDesc','incRepTxt','incHorasParo','incHorasRepar','incInicio','incReportante'].forEach(id=>q('#'+id).value=''); await loadIncid(); aplicarFiltros(); await loadState(); }
function getFiltradas(){ const f=getFilters(); return INC.filter(i=>{ if(f.equipo && i.equipo!==f.equipo) return false; if(f.tipo && i.tipo!==f.tipo) return false; if(f.res && i.res!==f.res) return false; if(f.texto){ const blob=(i.equipo+' '+(i.desc||'')+' '+(i.repTxt||'')).toLowerCase(); if(!blob.includes(f.texto)) return false; } return true; }); }
function toCSV(rows, header){ const all= header ? [header, ...rows] : rows; return all.map(r => r.map(v => '"'+String(v if v is not None else '').replace('"','""')+'"').join(',')).join('\n'); }
</script>