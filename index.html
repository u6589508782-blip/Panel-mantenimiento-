<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CDL ¬∑ CMMS v29</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --brand1:#a60000; --brand2:#e43b3b; --bg:#f4f7f9; --card:#ffffff;
  --ok:#16a34a; --warn:#f59e0b; --stop:#dc2626; --muted:#64748b; --ink:#0f172a;
  --ring:0 10px 30px rgba(0,0,0,.08);
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);font-family:Inter,system-ui,sans-serif;color:var(--ink)}
/* ===== Header ===== */
header{position:sticky;top:0;z-index:50;background:linear-gradient(180deg,#fff,#fff0);backdrop-filter:saturate(1.2) blur(4px);border-bottom:3px solid #e8ecef}
.nav{display:flex;align-items:center;gap:.75rem;padding:.65rem .9rem}
.logo{display:flex;align-items:center;gap:.8rem;min-width:0}
.logo img{height:56px;width:auto;object-fit:contain}
.logo h1{font-size:1.45rem;margin:0;font-weight:800;white-space:nowrap}
.grow{flex:1 1 auto}
.rolechip{font-size:.78rem;font-weight:700;border-radius:999px;padding:.32rem .6rem;background:#eef2f7;border:1px solid #e2e8f0;color:#0f172a}
/* Men√∫s */
.menu{position:relative}
.mbtn{border:0;border-radius:14px;padding:.7rem .9rem;font-weight:800;cursor:pointer;background:linear-gradient(90deg,var(--brand1),var(--brand2));color:#fff}
.mbtn-pages{background:#0f172a;color:#fff}
.panel{position:absolute;right:0;top:120%;background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:var(--ring);min-width:300px;overflow:hidden}
.row{padding:.85rem 1rem;border-bottom:1px solid #edf2f7}
.row:last-child{border-bottom:0}
label.small{font-size:.8rem;color:#6b7280;display:block;margin-bottom:.3rem}
.actions{display:flex;gap:.5rem;flex-wrap:wrap}
.btn{border:0;border-radius:12px;padding:.6rem .85rem;font-weight:700;cursor:pointer}
.btn-ghost{background:#f2f4f7} .btn-ghost:hover{background:#e9eef5}
.btn-danger{background:var(--stop);color:#fff}
.btn-brand{background:linear-gradient(90deg,var(--brand1),var(--brand2));color:#fff}
/* ===== Contenido ===== */
.container{max-width:980px;margin:0 auto;padding:1rem}
/* Chips / leyenda al final */
.toolbar{background:var(--card);border-radius:18px;box-shadow:var(--ring);padding:.75rem 1rem;margin:1rem 0;display:flex;flex-wrap:wrap;gap:.6rem;align-items:center}
.badge-chip{display:inline-flex;align-items:center;gap:.5rem;padding:.45rem .75rem;border-radius:999px;background:#fff;border:1px solid #e5e7eb;box-shadow:var(--ring);font-weight:700}
.dot{width:16px;height:16px;border-radius:50%}
.dot.ok{background:var(--ok)} .dot.warn{background:var(--warn)} .dot.stop{background:var(--stop)}
/* Grupos y tarjetas */
.group{margin:1.2rem 0}
.group h2{margin:.2rem 0 .7rem;font-size:1.1rem}
.card{background:var(--card);border-radius:18px;box-shadow:var(--ring);padding:1rem;margin:.6rem 0;display:flex;gap:1rem;align-items:center;flex-wrap:wrap}
.name{font-weight:800;font-size:1.05rem;min-width:220px;max-width:100%}
.sub{color:var(--muted);font-size:.9rem}
.right{margin-left:auto;display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
select,input,textarea{border:1px solid #e3e8ef;border-radius:12px;padding:.55rem .7rem;background:#fff;min-width:0}
select{min-width:150px}
.pilot{width:18px;height:18px;border-radius:50%;box-shadow:0 0 0 3px #fff,0 0 0 6px rgba(0,0,0,.05)}
.p-ok{background:var(--ok)} .p-warn{background:var(--warn)} .p-stop{background:var(--stop)}
.small{font-size:.9rem}
.btn-mini{padding:.45rem .6rem;border-radius:10px}
.btn-mail{background:var(--stop);color:#fff}
.btn-plan{background:#e6eefb;color:#0f3a7f}
.hidden{display:none!important}
/* Formularios y tablas */
.kpi{background:var(--card);border-radius:18px;box-shadow:var(--ring);padding:1rem}
.kpi h3{margin:.2rem 0 .8rem}
table{width:100%;border-collapse:separate;border-spacing:0 10px}
th,td{padding:.7rem 1rem;background:#fff}
th{text-align:left;color:#475569;font-size:.9rem;background:#f8fafc}
tr td:first-child, tr th:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px}
tr td:last-child, tr th:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px}
/* inventario grid */
.inv-grid{display:grid;gap:10px;grid-template-columns:1fr 1fr 1fr 1fr}
@media(max-width:720px){.inv-grid{grid-template-columns:1fr 1fr}.right{justify-content:flex-start}}
/* Form grid responsive incid/ot */
.form-grid{display:grid;gap:10px;grid-template-columns:1fr 1fr}
@media(max-width:720px){.form-grid{grid-template-columns:1fr}}
/* iOS select fix */
label{display:flex;flex-direction:column;gap:6px}
select{width:100%;max-width:100%;appearance:auto}
/* ===== TV ===== */
.tv-wrap{max-width:1400px}
.tv-grid{display:grid;gap:16px}
@media(min-width:760px){.tv-grid{grid-template-columns:1fr 1fr}}
@media(min-width:1180px){.tv-grid{grid-template-columns:1fr 1fr 1fr}}
.tv-card{background:#fff;border-radius:22px;box-shadow:var(--ring);padding:18px}
.tv-title{display:flex;align-items:center;gap:.6rem;margin:0 0 10px}
.tv-title .dot{width:18px;height:18px}
.tv-list{display:flex;flex-direction:column;gap:8px;max-height:60vh;overflow:auto}
.tv-item{padding:10px 12px;border-radius:12px;font-weight:700}
.tv-item.stop{background:#fee2e2;color:#7f1d1d}
.tv-item.warn{background:#ffedd5;color:#7c2d12}
.tv-item.stock{background:#e0f2fe;color:#0c4a6e}
.tv-legend{color:#64748b;font-size:.9rem;margin-left:8px}
.fullscreen{position:fixed;inset:0;background:var(--bg);padding:14px;z-index:80;overflow:auto}
/* Footer */
footer{padding:2rem 1rem;color:#9aa7b4;text-align:center}
</style>
</head>
<body>
<header>
  <div class="nav">
    <div class="logo">
      <img src="logo_mantenimiento.png" alt="Logo" onerror="this.src='logo_mantenimiento.PNG'">
      <h1>CDL ¬∑ Panel de mantenimiento</h1>
    </div>
    <div class="grow"></div>

    <span id="roleChip" class="rolechip">Invitado</span>

    <!-- Men√∫ P√°ginas -->
    <div class="menu" style="margin-left:.4rem">
      <button id="pagesBtn" class="mbtn mbtn-pages">‚ò∞</button>
      <div id="pagesPanel" class="panel hidden" style="min-width:260px">
        <div class="row">
          <div class="actions">
            <button class="btn btn-ghost" onclick="nav('equipos')">Equipos</button>
            <button class="btn btn-ghost" id="mGruas" onclick="nav('gruas')">Puentes Gr√∫a</button>
            <button class="btn btn-ghost" id="mOtros" onclick="nav('otros')">Otros</button>
            <button class="btn btn-ghost" id="mIncid" onclick="nav('incidencias')">Incidencias</button>
            <button class="btn btn-ghost" id="mIndic" onclick="nav('indicadores')">Indicadores</button>
            <button class="btn btn-ghost" id="mOT" onclick="nav('ot')">OT</button>
            <button class="btn btn-ghost" id="mInv" onclick="nav('inventario')">Inventario</button>
            <button class="btn btn-ghost" id="mTV" onclick="nav('tv')">Dashboard TV</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Men√∫ Usuario -->
    <div class="menu">
      <button id="userBtn" class="mbtn">‚ãØ</button>
      <div id="userPanel" class="panel hidden">
        <div class="row">
          <label class="small">Usuario</label>
          <select id="userSelect">
            <option value="invitado">Invitado</option>
            <option value="admin">Administrador</option>
            <option value="gerente">Gerente</option>
            <option value="encargado">Encargado</option>
            <option value="produccion">Producci√≥n</option>
            <option value="rt11">RT1.1</option><option value="rt12">RT1.2</option>
            <option value="rt21">RT2.1</option><option value="rt22">RT2.2</option>
            <option value="rt31">RT3.1</option><option value="rt32">RT3.2</option>
            <option value="tcoint">Tco.INT</option>
            <option value="subc">Subcontrata</option>
          </select>
          <label class="small" style="margin-top:.4rem">Contrase√±a</label>
          <input id="userPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
          <div class="actions" style="margin-top:.6rem">
            <button class="btn btn-brand" onclick="login()">Entrar</button>
            <button class="btn btn-ghost" onclick="logout()">Salir</button>
          </div>
        </div>
        <div class="row">
          <label class="small">Cambiar contrase√±a</label>
          <input id="oldPass" type="password" placeholder="Contrase√±a actual">
          <input id="newPass" type="password" placeholder="Nueva contrase√±a">
          <div class="actions" style="margin-top:.6rem">
            <button class="btn btn-ghost" onclick="changePwd()">Cambiar</button>
          </div>
          <div id="pwdMsg" class="small" style="margin-top:.4rem;color:#64748b"></div>
        </div>
      </div>
    </div>

  </div>
</header>

<main class="container">

  <!-- EQUIPOS (home) -->
  <section id="page-equipos">
    <div id="equiposWrap"></div>
    <!-- Leyenda al FINAL -->
    <div class="toolbar">
      <span class="badge-chip"><span class="dot stop"></span> Parada</span>
      <span class="badge-chip"><span class="dot warn"></span> Restricciones</span>
      <span class="badge-chip"><span class="dot ok"></span> En marcha</span>
    </div>
  </section>

  <!-- GR√öAS -->
  <section id="page-gruas" class="hidden">
    <h2>Puentes Gr√∫a</h2>
    <div id="gruasWrap"></div>
  </section>

  <!-- OTROS -->
  <section id="page-otros" class="hidden">
    <h2>Otros (auxiliares)</h2>
    <div id="otrosWrap"></div>
  </section>

  <!-- INCIDENCIAS -->
  <section id="page-incidencias" class="hidden">
    <div class="kpi">
      <h3>Registrar nueva incidencia</h3>
      <div class="form-grid">
        <label>Equipo <select id="iEquipo"></select></label>
        <label>Tipo
          <select id="iTipo"><option>Correctivo</option><option>Preventivo</option><option>Predictivo</option><option>Mejora</option></select>
        </label>
        <label>Resultado
          <select id="iRes"><option>Solucionado</option><option>Con restricciones</option><option>Parada</option></select>
        </label>
        <label>¬øRepuesto? <select id="iRep"><option>No</option><option>S√≠</option></select></label>
        <label>Repuesto (txt) <input id="iRepTxt" placeholder="p.ej. THM6-20"/></label>
        <label>Horas de parada <input id="iHParo" type="number" value="0"/></label>
        <label>Horas de reparaci√≥n <input id="iHRep" type="number" value="0"/></label>
        <label>Fecha inicio <input id="iInicio" type="datetime-local"/></label>
        <label>Fecha fin <input id="iFin" type="datetime-local"/></label>
        <label>Reportante <input id="iReport" placeholder="Nombre"/></label>
        <label>Intervenido por <input id="iAsignado" placeholder="Nombre t√©cnico"/></label>
        <label style="grid-column:1/-1">Descripci√≥n <textarea id="iDesc" rows="3" placeholder="Breve descripci√≥n obligatoria"></textarea></label>
      </div>
      <div style="margin-top:.6rem;display:flex;gap:.5rem;flex-wrap:wrap">
        <button class="btn btn-brand" onclick="addIncid()">A√±adir incidencia</button>
        <button class="btn btn-ghost" onclick="exportIncidCSV()" id="btnExportIncidCSV">Exportar CSV</button>
        <button class="btn btn-ghost" onclick="exportIncidPDF()" id="btnExportIncidPDF">Exportar PDF</button>
      </div>
    </div>
    <div class="kpi" style="margin-top:12px">
      <div style="display:flex;gap:.7rem;align-items:center;margin-bottom:.6rem;flex-wrap:wrap">
        <strong>Historial (√∫ltimas primero)</strong>
        <input id="filtroIncid" placeholder="Buscar‚Ä¶" oninput="renderIncidTable()">
      </div>
      <div id="incidTableWrap"></div>
    </div>
  </section>

  <!-- INDICADORES -->
  <section id="page-indicadores" class="hidden">
    <div class="kpi">
      <h3>KPIs globales</h3>
      <table>
        <tr><th>KPI</th><th>Valor</th><th>Definici√≥n</th></tr>
        <tr><td>MTTR (h)</td><td id="kpiMttrG">0</td><td>Tiempo medio de reparaci√≥n (promedio de horas dedicadas a reparar).</td></tr>
        <tr><td>MTBF (h)</td><td id="kpiMbfG">0</td><td>Tiempo medio entre fallos (horas de operaci√≥n entre incidencias).</td></tr>
        <tr><td>Disponibilidad (%)</td><td id="kpiDispG">0</td><td>Tiempo disponible / tiempo planificado (penaliza horas de parada).</td></tr>
        <tr><td>OEE estimado (%)</td><td id="kpiOeeG">0</td><td>Calidad √ó Rendimiento √ó Disponibilidad (aprox. usando disp.).</td></tr>
      </table>
      <div style="margin-top:.6rem;display:flex;gap:.5rem;flex-wrap:wrap">
        <button class="btn btn-ghost" onclick="exportKPIsCSV()" id="btnExportKPICSV">Descargar KPIs (CSV)</button>
        <button class="btn btn-ghost" onclick="exportKPIsPDF()" id="btnExportKPIPDF">Descargar KPIs (PDF)</button>
      </div>
    </div>

    <!-- Gr√°fico MTTR semanal -->
    <div class="kpi" style="margin-top:12px">
      <h3>Evoluci√≥n semanal (MTTR)</h3>
      <canvas id="kpiChart" height="140"></canvas>
    </div>

    <!-- Tablas hist√≥ricas por KPI -->
    <div class="kpi" style="margin-top:12px">
      <h3>Hist√≥rico semanal ‚Äî MTTR</h3>
      <p class="sub">MTTR: Tiempo medio de reparaci√≥n por semana. Ayuda a ver si reducimos la duraci√≥n de las reparaciones.</p>
      <div style="margin:.4rem 0">
        <button class="btn btn-ghost" onclick="exportTableCSV('tblMttr','mttr_semanal.csv')">CSV</button>
        <button class="btn btn-ghost" onclick="exportTablePDF('tblMttr','MTTR semanal')">PDF</button>
      </div>
      <div id="tblMttr"></div>
    </div>

    <div class="kpi" style="margin-top:12px">
      <h3>Hist√≥rico semanal ‚Äî MTBF</h3>
      <p class="sub">MTBF: Horas entre fallos por semana. Valores m√°s altos significan menos interrupciones.</p>
      <div style="margin:.4rem 0">
        <button class="btn btn-ghost" onclick="exportTableCSV('tblMtbf','mtbf_semanal.csv')">CSV</button>
        <button class="btn btn-ghost" onclick="exportTablePDF('tblMtbf','MTBF semanal')">PDF</button>
      </div>
      <div id="tblMtbf"></div>
    </div>

    <div class="kpi" style="margin-top:12px">
      <h3>Hist√≥rico semanal ‚Äî Disponibilidad</h3>
      <p class="sub">Disponibilidad: % de tiempo operativo por semana (120 h planificadas ‚àí horas de parada).</p>
      <div style="margin:.4rem 0">
        <button class="btn btn-ghost" onclick="exportTableCSV('tblDisp','disponibilidad_semanal.csv')">CSV</button>
        <button class="btn btn-ghost" onclick="exportTablePDF('tblDisp','Disponibilidad semanal')">PDF</button>
      </div>
      <div id="tblDisp"></div>
    </div>

    <div class="kpi" style="margin-top:12px">
      <h3>Hist√≥rico semanal ‚Äî OEE estimado</h3>
      <p class="sub">OEE estimado: indicador global (aqu√≠: OEE ‚âà Disponibilidad √ó 0.9 √ó 0.98).</p>
      <div style="margin:.4rem 0">
        <button class="btn btn-ghost" onclick="exportTableCSV('tblOee','oee_semanal.csv')">CSV</button>
        <button class="btn btn-ghost" onclick="exportTablePDF('tblOee','OEE semanal')">PDF</button>
      </div>
      <div id="tblOee"></div>
    </div>
  </section>

  <!-- OT -->
  <section id="page-ot" class="hidden">
    <div class="kpi">
      <h3>Nueva OT</h3>
      <div class="form-grid">
        <label>Equipo <select id="otEquipo"></select></label>
        <label>Prioridad
          <select id="otPri">
            <option value="R">Rojo (Urgente)</option>
            <option value="N">Naranja (Alta)</option>
            <option value="A">Amarillo (Preventivo)</option>
            <option value="V">Verde (Predictivo)</option>
          </select>
        </label>
        <label>T√≠tulo <input id="otTitulo" placeholder="Breve t√≠tulo"/></label>
        <label>Asignado <input id="otAsign" placeholder="Nombre t√©cnico"/></label>
        <label>Vencimiento <input id="otDue" type="date"/></label>
        <label>Adjunto (URL) <input id="otAdj" placeholder="https://‚Ä¶"/></label>
        <label style="grid-column:1/-1">Descripci√≥n <textarea id="otDesc" rows="3"></textarea></label>
      </div>
      <div style="margin-top:.6rem;display:flex;gap:.5rem;flex-wrap:wrap">
        <button id="btnAddOT" class="btn btn-brand" onclick="addOT()">Crear OT</button>
        <button class="btn btn-ghost" onclick="exportOTPDF()">Exportar listado (PDF)</button>
      </div>
    </div>
    <div class="kpi" style="margin-top:12px">
      <h3>Listado OT</h3>
      <div id="otTableWrap"></div>
    </div>
  </section>

  <!-- INVENTARIO -->
  <section id="page-inventario" class="hidden">
    <div class="kpi">
      <h3>Inventario de repuestos</h3>
      <div style="display:flex;gap:.6rem;flex-wrap:wrap;margin-bottom:.6rem">
        <input id="invSearch" placeholder="Buscar ref/nombre‚Ä¶" oninput="renderInv()">
        <button class="btn btn-ghost" onclick="exportInvCSV()" id="btnExportInvCSV">Exportar CSV</button>
      </div>
      <div class="inv-grid">
        <input id="invNombre" placeholder="Nombre repuesto" />
        <input id="invRef" placeholder="Referencia" />
        <input id="invStock" type="number" placeholder="Stock" />
        <input id="invMin" type="number" placeholder="M√≠nimo" />
      </div>
      <div style="margin-top:.6rem">
        <button class="btn btn-brand" onclick="addInv()">A√±adir</button>
      </div>
      <div id="invTableWrap" style="margin-top:12px"></div>
    </div>
  </section>

  <!-- DASHBOARD TV -->
  <section id="page-tv" class="hidden">
    <div class="tv-wrap">
      <div style="display:flex;align-items:center">
        <h2 style="margin:0">Dashboard TV (alertas globales)</h2>
        <span class="tv-legend"> ¬∑ se actualiza cada 30 s</span>
        <div class="grow"></div>
        <button class="btn btn-ghost" onclick="tvFull()">Pantalla completa</button>
      </div>
      <div class="tv-grid" style="margin-top:10px">
        <div class="tv-card">
          <h3 class="tv-title"><span class="dot stop"></span> Equipos PARADOS</h3>
          <div id="tvParados" class="tv-list"></div>
        </div>
        <div class="tv-card">
          <h3 class="tv-title"><span class="dot warn"></span> Equipos con RESTRICCIONES</h3>
          <div id="tvRestr" class="tv-list"></div>
        </div>
        <div class="tv-card">
          <h3 class="tv-title"><span class="dot"></span> Repuestos BAJO M√çNIMO</h3>
          <div id="tvStock" class="tv-list"></div>
        </div>
      </div>
    </div>
  </section>

</main>

<footer>v29 ¬∑ ¬© CDL</footer>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
/* ================= CONFIG ================= */
const API_BASE = "https://script.google.com/macros/s/AKfycbxbIWXzjq__2OSL7UhkxeanoBcvuz_5QC3dyBvyHVlY_W_F5WSVhts0I1HVOh2ofp4A/exec";

/* ===== Util ===== */
const byId=(id)=>document.getElementById(id);
function fmt(n){return (Math.round((+n||0)*100)/100).toFixed(2);}
function fmtDate(d){const x=new Date(d); return x.toLocaleString();}
function esc(s){return (s||"").replace(/[&<>"]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[m]));}
function toCSV(rows,header){const all=[header,...rows]; return all.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\\n');}
function downloadBlob(txt,mime,name){const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([txt],{type:mime})); a.download=name; a.click();}
function setTxt(id,v){byId(id).textContent=v;}
function getText(id){return byId(id).textContent;}
function val(id){return byId(id).value;}
function buildTableHtml(rows, header){
  const thead = `<tr>${header.map(h=>`<th>${esc(h)}</th>`).join('')}</tr>`;
  const tbody = rows.map(r=>`<tr>${r.map(c=>`<td>${esc(String(c))}</td>`).join('')}</tr>`).join('');
  return `<table><thead>${thead}</thead><tbody>${tbody}</tbody></table>`;
}
function exportTableCSV(containerId, filename){
  const el = byId(containerId);
  const th=[...el.querySelectorAll('thead th')].map(x=>x.textContent);
  const rs=[...el.querySelectorAll('tbody tr')].map(tr=>[...tr.children].map(td=>td.textContent));
  downloadBlob(toCSV(rs, th),'text/csv;charset=utf-8;', filename);
}
function exportTablePDF(containerId, title){
  const el = byId(containerId);
  const html = `<h2>${esc(title)}</h2>` + el.innerHTML.replaceAll('thead','table').replaceAll('tbody','table');
  const win=window.open('','_blank');
  win.document.write(`<!doctype html><meta charset="utf-8"><title>${esc(title)}</title>
    <style>body{font-family:Inter,sans-serif;padding:16px}table{width:100%;border-collapse:collapse}td,th{border:1px solid #ddd;padding:8px}</style>
    ${html}`);
  win.document.close();
}

/* ===== Auth & Roles ===== */
const ROLE_MAP = {
  "Administrador":"admin","Gerente":"gerente","Encargado":"encargado","Producci√≥n":"produccion",
  "RT":"rt","Tco.INT":"tco","Subcontrata":"subc","Invitado":"guest"
};
let currentUser = JSON.parse(localStorage.getItem("CDL_USER")||'{"user":"invitado","rol":"Invitado","group":"guest"}');

function setUser(u){
  currentUser=u;
  localStorage.setItem("CDL_USER",JSON.stringify(u));
  byId('roleChip').textContent=u.rol;
  applyRoleUI();
}
async function login(){
  const user = byId('userSelect').value;
  const pass = byId('userPass').value||"";
  const r = await apiPost({res:'auth',fn:'login',user,pass});
  if(!r.ok){ alert("Credenciales incorrectas o usuario inactivo"); return; }
  const group = ROLE_MAP[r.rol]||"guest";
  setUser({user,rol:r.rol,group});
  byId('userPanel').classList.add('hidden');
  byId('userPass').value="";
}
function logout(){
  setUser({user:"invitado",rol:"Invitado",group:"guest"});
}
async function changePwd(){
  const user = byId('userSelect').value;
  const old = byId('oldPass').value||"";
  const nu  = byId('newPass').value||"";
  if(!old||!nu){ byId('pwdMsg').textContent="Rellena ambas contrase√±as."; return;}
  const r = await apiPost({res:'auth',fn:'changepwd',user,old,nu});
  byId('pwdMsg').textContent = r.ok? "Contrase√±a cambiada." : "Error al cambiar (credenciales).";
  if(r.ok){ byId('oldPass').value=""; byId('newPass').value=""; }
}

/* permisos por grupo */
function applyRoleUI(){
  const g=currentUser.group;
  // visibilidad de p√°ginas
  const canIndic = (g==="admin"||g==="gerente");
  const canOT    = (g==="admin"||g==="tco");
  const canIncid = (g!=="guest");
  const canInv   = (g!=="guest");
  const canGruas = (g!=="guest");
  const canOtros = (g!=="guest");
  const canTV    = (g!=="guest");

  toggleItem('mIndic', canIndic);
  toggleItem('mOT',    canOT);
  toggleItem('mIncid', canIncid);
  toggleItem('mInv',   canInv);
  toggleItem('mGruas', canGruas);
  toggleItem('mOtros', canOtros);
  toggleItem('mTV',    canTV);

  // exportaciones
  const canExport = (g==="admin"||g==="gerente");
  ['btnExportIncidCSV','btnExportIncidPDF','btnExportKPICSV','btnExportKPIPDF','btnExportInvCSV']
    .forEach(id=> byId(id)?.classList.toggle('hidden',!canExport));

  // crear OT
  if (byId('btnAddOT')) byId('btnAddOT').disabled = !canOT;
}
function toggleItem(id, show){ const el=byId(id); if(el) el.classList.toggle('hidden', !show); }

/* ===== API helpers ===== */
async function apiGet(q){
  const r = await fetch(API_BASE + "?" + new URLSearchParams(q));
  return r.json();
}

async function apiPost(o){
  const r = await fetch(API_BASE, {
    method: 'POST',
    headers: { 'Content-Type':'text/plain;charset=utf-8' }, // <- cambiado
    body: JSON.stringify(o)
  });
  return r.json();
}

/* ===== Men√∫s ===== */
byId('userBtn').onclick=()=> byId('userPanel').classList.toggle('hidden');
byId('pagesBtn').onclick=()=> byId('pagesPanel').classList.toggle('hidden');
document.addEventListener('click',e=>{
  const up=byId('userPanel'), ub=byId('userBtn');
  const pp=byId('pagesPanel'), pb=byId('pagesBtn');
  if (!up.contains(e.target) && e.target!==ub) up.classList.add('hidden');
  if (!pp.contains(e.target) && e.target!==pb) pp.classList.add('hidden');
});

/* ===== NAV ===== */
let CURRENT_PAGE='equipos';
function nav(id){
  CURRENT_PAGE=id;
  byId('pagesPanel').classList.add('hidden');
  for(const s of ["equipos","gruas","otros","incidencias","indicadores","ot","inventario","tv"])
    byId('page-'+s).classList.add('hidden');
  byId('page-'+id).classList.remove('hidden');
  if(id==="equipos") loadState();
  if(id==="gruas") renderSubGroup("Puentes Gr√∫a","gruasWrap");
  if(id==="otros") renderSubGroup("Otros (auxiliares)","otrosWrap");
  if(id==="incidencias"){ loadIncid(); }
  if(id==="indicadores"){ calcKPIs(); buildKpiTables(); }
  if(id==="ot"){ loadOT(); }
  if(id==="inventario"){ loadInv(); }
  if(id==="tv"){ loadTV(); }
  window.scrollTo({top:0,behavior:"smooth"});
}

/* ===== EQUIPOS ===== */
let STATE=[];
function statusClass(s){return s==="Parada"?"p-stop":(s==="Restricciones"?"p-warn":"p-ok");}

async function loadState(){
  try{
    const j=await apiGet({res:'state',fn:'list'});
    if(j.ok&&j.items.length){STATE=j.items;renderState();return;}
    await apiPost({res:'state',fn:'seed'});
    const k=await apiGet({res:'state',fn:'list'}); STATE=(k.ok?k.items:[]);
    renderState();
  }catch(e){console.error(e)}
}
function renderState(){
  const by={}; STATE.forEach(it=>{(by[it.grupo] ||= []).push(it);});
  const wrap=byId('equiposWrap'); wrap.innerHTML="";
  for(const [g,items] of Object.entries(by)){
    if(g.startsWith("Puentes Gr√∫a")||g==="Otros (auxiliares)") continue;
    const group=document.createElement('div'); group.className='group'; group.innerHTML=`<h2>${g}</h2>`;
    items.forEach(eq=>group.appendChild(cardEquipo(eq)));
    wrap.appendChild(group);
  }
  if(!byId('page-gruas').classList.contains('hidden')) renderSubGroup("Puentes Gr√∫a","gruasWrap");
  if(!byId('page-otros').classList.contains('hidden')) renderSubGroup("Otros (auxiliares)","otrosWrap");
}
function renderSubGroup(match,target){
  const wrap=byId(target); wrap.innerHTML="";
  const items=STATE.filter(x=> match==="Otros (auxiliares)"?x.grupo===match:x.grupo.startsWith(match));
  const by={}; items.forEach(it=>{(by[it.grupo] ||= []).push(it);});
  for(const [g,arr] of Object.entries(by)){
    const group=document.createElement('div'); group.className='group'; group.innerHTML=`<h2>${g}</h2>`;
    arr.forEach(eq=>group.appendChild(cardEquipo(eq))); wrap.appendChild(group);
  }
}
function cardEquipo(eq){
  const canIncButtons = (currentUser.group!=="guest");
  const safeName = eq.nombre.replace(/'/g,"\\'");
  const el=document.createElement('div'); el.className='card';
  el.innerHTML=`
    <span class="pilot ${statusClass(eq.estado)}"></span>
    <div style="min-width:220px">
      <div class="name">${esc(eq.nombre)}</div>
      <div class="sub">${esc(eq.grupo)}</div>
    </div>
    <div class="right">
      <select class="small" onchange="cambiaEstado('${safeName}',this.value)">
        <option ${eq.estado==='En marcha'?'selected':''}>En marcha</option>
        <option ${eq.estado==='Restricciones'?'selected':''}>Restricciones</option>
        <option ${eq.estado==='Parada'?'selected':''}>Parada</option>
      </select>
      <button class="btn btn-ghost btn-mini" onclick="openFicha('${safeName}')">Ficha</button>
      ${canIncButtons ? `
        <button class="btn btn-mini btn-mail" title="Parada prolongada (aviso correo)" onclick="accionParadaProlongada('${safeName}')">Parada prolongada</button>
        <button class="btn btn-mini btn-plan" title="Parada programada" onclick="accionParadaProgramada('${safeName}')">Parada programada</button>
      `:''}
    </div>`;
  return el;
}
async function cambiaEstado(name,estado){
  if(currentUser.group==="guest"){ alert("Inicia sesi√≥n para modificar estados."); return; }
  await apiPost({res:'state',fn:'set',name,estado,actor:currentUser.user});
  const it=STATE.find(x=>x.nombre===name); if(it) it.estado=estado;
}
function openFicha(name){
  const inc=INCIDS_ALL.filter(x=>x.equipo===name);
  alert(`Equipo: ${name}\nIncidencias: ${inc.length}`);
}
async function accionParadaProlongada(name){
  if(currentUser.group==="guest"){ alert("Inicia sesi√≥n para marcar paradas."); return; }
  await apiPost({res:'alert',fn:'parada',equipo:name,actor:currentUser.user});
  await loadState();
}
async function accionParadaProgramada(name){
  if(currentUser.group==="guest"){ alert("Inicia sesi√≥n para marcar paradas."); return; }
  await apiPost({res:'state',fn:'set',name,estado:'Parada',actor:currentUser.user});
  await apiPost({res:'incid',fn:'add', item:{
    equipo:name,tipo:'Preventivo',res:'Parada',rep:'No',repTxt:'',
    hParo:0,hRep:0,inicio:new Date().toISOString(),fin:'',
    reportante:currentUser.user,asignado:'',adj:'',desc:'Parada programada'
  }, actor:currentUser.user});
  await loadState();
}

/* ===== INCIDENCIAS ===== */
let INCIDS_ALL=[];
async function loadIncid(){
  const st=await apiGet({res:'state',fn:'list'}); STATE=st.ok?st.items:[];
  const inc=await apiGet({res:'incid',fn:'list'}); INCIDS_ALL=inc.ok?inc.items:[];
  byId('iEquipo').innerHTML=STATE.map(x=>`<option>${esc(x.nombre)}</option>`).join('');
  renderIncidTable();
}
function renderIncidTable(){
  const q=(byId('filtroIncid').value||"").toLowerCase();
  const arr=INCIDS_ALL.filter(x=> JSON.stringify(x).toLowerCase().includes(q));
  const rows=arr.map(x=>`
    <tr><td>${fmtDate(x.created)}</td>
        <td><span class="rolechip">${esc(x.equipo)}</span></td>
        <td>${esc(x.tipo)}</td>
        <td>${esc(x.desc||'')}</td>
        <td>${fmt(x.hParo)}</td>
        <td>${fmt(x.hRep)}</td>
    </tr>`).join('');
  byId('incidTableWrap').innerHTML=
    `<table><thead><tr><th>Fecha</th><th>Equipo</th><th>Tipo</th><th>Descripci√≥n</th><th>Horas parada</th><th>Reparaci√≥n</th></tr></thead><tbody>${rows}</tbody></table>`;
}
async function addIncid(){
  if(currentUser.group==="guest"){ alert("Inicia sesi√≥n para registrar incidencias."); return; }
  const item={
    equipo:val('iEquipo'),tipo:val('iTipo'),res:val('iRes'),
    rep:val('iRep'),repTxt:val('iRepTxt'),
    hParo:+val('iHParo')||0,hRep:+val('iHRep')||0,
    inicio:val('iInicio')||new Date().toISOString(), fin:val('iFin')||'',
    reportante:val('iReport')||currentUser.user,
    asignado:val('iAsignado')||'',
    adj:'', desc:val('iDesc')||'(sin descripci√≥n)'
  };
  await apiPost({res:'incid',fn:'add',item,actor:currentUser.user});
  await loadIncid(); await loadState();
}

/* ===== INDICADORES ===== */
function calcKPIs(){
  const mttr = kpiMTTR(INCIDS_ALL);
  const mtbf = kpiMTBF(INCIDS_ALL);
  const disp = kpiDisp(INCIDS_ALL);
  const oee  = kpiOEE(disp);
  setTxt('kpiMttrG',fmt(mttr)); setTxt('kpiMbfG',fmt(mtbf)); setTxt('kpiDispG',fmt(disp*100)); setTxt('kpiOeeG',fmt(oee*100));
  const weeks = groupByWeek(INCIDS_ALL); const labels=Object.keys(weeks).sort(); const data=labels.map(k=>kpiMTTR(weeks[k])); drawBars('kpiChart',labels,data,'MTTR semanal (h)');
}
function groupByWeek(arr){const g={}; for(const x of arr){ const d=new Date(x.created); const w=`${d.getFullYear()}-W${weeknum(d)}`; (g[w] ||= []).push(x);} return g;}
function weeknum(d){const a=new Date(Date.UTC(d.getFullYear(),0,1)); const n=Math.floor((d-a)/86400000)+a.getUTCDay(); return Math.floor(n/7)+1;}
function kpiMTTR(list){const s=list.reduce((p,x)=>p+(+x.hRep||0),0); const n=list.length||1; return s/n;}
function kpiMTBF(list){const horas=4*30*24; const fallas=list.length||1; return horas/fallas;}
function kpiDisp(list){const prodH=120; const perd=list.reduce((p,x)=>p+(+x.hParo||0),0); return Math.max(0,(prodH-perd)/prodH);}
function kpiOEE(disp){return disp*.9*.98;}
let _chart=null; function drawBars(id,lab,val,title){const ctx=byId(id).getContext('2d'); if(_chart){_chart.destroy();} _chart=new Chart(ctx,{type:'bar',data:{labels:lab,datasets:[{label:title,data:val}]}});}

/* Tablas hist√≥ricas por KPI */
function buildKpiTables(){
  const weeks = groupByWeek(INCIDS_ALL);
  const labels = Object.keys(weeks).sort(); // YYYY-W##
  // MTTR
  const mttrRows = labels.map(w=>[w, fmt(kpiMTTR(weeks[w]))]);
  byId('tblMttr').innerHTML = buildTableHtml(mttrRows, ['Semana','MTTR (h)']);
  // MTBF
  const mtbfRows = labels.map(w=>[w, fmt(kpiMTBF(weeks[w]))]);
  byId('tblMtbf').innerHTML = buildTableHtml(mtbfRows, ['Semana','MTBF (h)']);
  // Disponibilidad
  const dispRows = labels.map(w=>[w, fmt(kpiDisp(weeks[w])*100)]);
  byId('tblDisp').innerHTML = buildTableHtml(dispRows, ['Semana','Disponibilidad (%)']);
  // OEE
  const oeeRows  = labels.map(w=>[w, fmt(kpiOEE(kpiDisp(weeks[w]))*100)]);
  byId('tblOee').innerHTML  = buildTableHtml(oeeRows,  ['Semana','OEE estimado (%)']);
}

/* Export KPIs globales */
function exportKPIsCSV(){ if(!canExport())return; const rows=[["MTTR (h)",getText('kpiMttrG')],["MTBF (h)",getText('kpiMbfG')],["Disponibilidad (%)",getText('kpiDispG')],["OEE estimado (%)",getText('kpiOeeG')]]; downloadBlob(toCSV(rows,["KPI","Valor"]),'text/csv;charset=utf-8;','kpis_globales.csv');}
function exportKPIsPDF(){ if(!canExport())return; const win=window.open('','_blank'); win.document.write(`<!doctype html><meta charset="utf-8"><title>KPIs</title><style>body{font-family:Inter,sans-serif;padding:16px}table{width:100%;border-collapse:collapse}td,th{border:1px solid #ddd;padding:8px}</style><h2>KPIs globales</h2><table><tr><th>KPI</th><th>Valor</th></tr><tr><td>MTTR (h)</td><td>${getText('kpiMttrG')}</td></tr><tr><td>MTBF (h)</td><td>${getText('kpiMbfG')}</td></tr><tr><td>Disponibilidad (%)</td><td>${getText('kpiDispG')}</td></tr><tr><td>OEE estimado (%)</td><td>${getText('kpiOeeG')}</td></tr></table>`); win.document.close();}

/* ===== OT ===== */
let OTS=[];
async function loadOT(){
  const st=await apiGet({res:'state',fn:'list'}); STATE=st.ok?st.items:[];
  const ot=await apiGet({res:'ot',fn:'list'}); OTS=ot.ok?ot.items:[];
  byId('otEquipo').innerHTML=STATE.map(x=>`<option>${esc(x.nombre)}</option>`).join('');
  renderOT();
}
function renderOT(){
  const rows=OTS.map(o=>`<tr><td>${fmtDate(o.created)}</td><td><b>${esc(o.titulo||'')}</b><div class="sub">${esc(o.equipo)}</div></td><td>${priBadge(o.prioridad)}</td><td>${esc(o.asignado||'')}</td><td>${esc(o.vencimiento||'')}</td><td>${esc(o.estado||'')}</td></tr>`).join('');
  byId('otTableWrap').innerHTML=`<table><thead><tr><th>Fecha</th><th>OT</th><th>Prioridad</th><th>Asignado</th><th>Vence</th><th>Estado</th></tr></thead><tbody>${rows}</tbody></table>`;
}
function priBadge(p){const c=p==="R"?"#dc2626":p==="N"?"#f59e0b":p==="A"?"#eab308":"#16a34a"; return `<span class="rolechip" style="background:${c};color:#fff">${p}</span>`}
async function addOT(){
  if(!(currentUser.group==="admin"||currentUser.group==="tco")){ alert("Tu rol no puede crear OT."); return; }
  const item={equipo:val('otEquipo'),prioridad:val('otPri'),titulo:val('otTitulo'),asignado:val('otAsign'),vencimiento:val('otDue'),adj:val('otAdj'),desc:val('otDesc')};
  await apiPost({res:'ot',fn:'add',item,actor:currentUser.user});
  await loadOT();
}
function exportOTPDF(){ const g=currentUser.group; if(!(g==="admin"||g==="gerente"||g==="tco")) return alert("No permitido"); const win=window.open('','_blank'); const rows=OTS.map(o=>`<tr><td>${fmtDate(o.created)}</td><td>${esc(o.titulo)}</td><td>${esc(o.equipo)}</td><td>${o.prioridad}</td><td>${esc(o.asignado)}</td><td>${esc(o.vencimiento)}</td></tr>`).join(''); win.document.write(`<!doctype html><meta charset="utf-8"><title>OT</title><style>body{font-family:Inter,sans-serif;padding:16px}table{width:100%;border-collapse:collapse}td,th{border:1px solid #ddd;padding:8px}</style><h2>√ìrdenes de trabajo</h2><table><tr><th>Fecha</th><th>T√≠tulo</th><th>Equipo</th><th>Prioridad</th><th>Asignado</th><th>Vence</th></tr>${rows}</table>`); win.document.close();}

/* ===== INVENTARIO ===== */
let INV=[];
async function loadInv(){ const j=await apiGet({res:'inv',fn:'list'}); INV=j.ok?j.items:[]; renderInv(); }
function renderInv(){
  const q=(byId('invSearch').value||"").toLowerCase();
  const arr=INV.filter(x=> (x.nombre+x.ref).toLowerCase().includes(q));
  const rows=arr.map(x=>`<tr><td><b>${esc(x.ref)}</b><div class="sub">${esc(x.nombre)}</div></td><td>${x.stock}</td><td>${x.minimo}</td><td><button class="btn btn-ghost btn-mini" onclick="delta('${x.ref.replace(/'/g,"\\'")}',-1)">‚Äì1</button><button class="btn btn-ghost btn-mini" onclick="delta('${x.ref.replace(/'/g,"\\'")}',+1)">+1</button></td></tr>`).join('');
  byId('invTableWrap').innerHTML=`<table><thead><tr><th>Repuesto</th><th>Stock</th><th>M√≠nimo</th><th>Acciones</th></tr></thead><tbody>${rows}</tbody></table>`;
}
async function addInv(){
  if(currentUser.group==="guest"){ alert("Inicia sesi√≥n para a√±adir repuestos."); return; }
  const item={nombre:val('invNombre'),ref:val('invRef'),stock:+val('invStock')||0,minimo:+val('invMin')||0};
  if(!item.ref){alert("Referencia requerida");return;}
  await apiPost({res:'inv',fn:'add',item,actor:currentUser.user}); await loadInv();
}
async function delta(ref,d){
  if(currentUser.group==="guest"){ alert("Inicia sesi√≥n para modificar stock."); return; }
  await apiPost({res:'inv',fn:'delta',ref,delta:d,actor:currentUser.user}); await loadInv();
}
function exportInvCSV(){ if(!canExport())return; const header=["Ref","Nombre","Stock","Minimo"]; const rows=INV.map(x=>[x.ref,x.nombre,x.stock,x.minimo]); downloadBlob(toCSV(rows,header),'text/csv;charset=utf-8;','inventario.csv'); }
function canExport(){ const g=currentUser.group; const ok=(g==="admin"||g==="gerente"); if(!ok) alert("Solo Gerente/Admin pueden exportar aqu√≠."); return ok; }

/* ===== TV ===== */
let TV_TIMER=null;
async function loadTV(){
  const st=await apiGet({res:'state',fn:'list'}); STATE=st.ok?st.items:[];
  const inv=await apiGet({res:'inv',fn:'list'}); INV=inv.ok?inv.items:[];
  renderTV();
  if(TV_TIMER) clearInterval(TV_TIMER);
  TV_TIMER=setInterval(()=>loadTV(),30000);
}
function renderTV(){
  const par=STATE.filter(x=>x.estado==='Parada');
  const res=STATE.filter(x=>x.estado==='Restricciones');
  const low=INV.filter(x=> +x.stock <= +x.minimo);
  byId('tvParados').innerHTML = par.length? par.map(x=>`<div class="tv-item stop">‚õî ${esc(x.nombre)}</div>`).join('') : `<div class="tv-item">Sin paradas</div>`;
  byId('tvRestr').innerHTML  = res.length? res.map(x=>`<div class="tv-item warn">‚ö†Ô∏è ${esc(x.nombre)}</div>`).join('') : `<div class="tv-item">Sin restricciones</div>`;
  byId('tvStock').innerHTML  = low.length? low.map(x=>`<div class="tv-item stock">üì¶ ${esc(x.ref)} ‚Äî ${esc(x.nombre)} ( ${x.stock}/${x.minimo} )</div>`).join('') : `<div class="tv-item">Stock correcto</div>`;
}
function tvFull(){
  const sec=byId('page-tv'); const clone=sec.cloneNode(true); clone.classList.add('fullscreen'); document.body.appendChild(clone);
  const close= document.createElement('button'); close.textContent='Salir pantalla completa'; close.className='btn btn-ghost'; close.style.position='fixed'; close.style.top='10px'; close.style.right='10px'; close.onclick=()=>clone.remove();
  clone.appendChild(close);
}

/* ===== Arranque ===== */
setUser(currentUser);
nav('equipos');   // Home
loadState();
let _once=false; // para construir tablas una vez cargadas incidencias en Indicadores
</script>
</body>
</html>